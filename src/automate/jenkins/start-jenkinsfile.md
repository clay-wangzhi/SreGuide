---
category: è‡ªåŠ¨åŒ–å·¥å…·
tags:
  - Jenkins
---

# 4.1 å¼€å§‹ç¼–å†™Jenkinsfile

> æœ¬æ–‡è½¬è‡ªï¼š[å¼€å§‹ç¼–å†™ Jenkinsfile | æ³½é˜³](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/)

æ‚¨å¥½ï¼Œè¿˜åœ¨ç–‘æƒ‘ä»€ä¹ˆæ˜¯æµæ°´çº¿å—ï¼Ÿ æœ¬ç« æˆ‘ä»¬å°†å‘Šè¯‰æ‚¨å¦‚ä½•è¿è¡Œä¸€æ¡æµæ°´çº¿ èµ¶å¿«å­¦ä¹ å§ï¼ ğŸ˜€

------

## ä¸ºä»€ä¹ˆä½¿ç”¨pipeline?

æœ¬è´¨ä¸Šï¼Œjenkinsæ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–å¼•æ“ï¼Œå®ƒæ”¯æŒè®¸å¤šè‡ªåŠ¨æ¨¡å¼ã€‚æµæ°´çº¿å‘Jenkinsæ·»åŠ äº†ä¸€ç»„å¼ºå¤§çš„å·¥å…·ï¼Œæ”¯æŒç”¨ä¾‹ã€ç®€å•çš„æŒç»­é›†æˆåˆ°å…¨é¢çš„æŒç»­äº¤ä»˜æµæ°´çº¿ã€‚ é€šè¿‡å¯¹ä¸€ç³»åˆ—çš„å‘å¸ƒä»»åŠ¡å»ºç«‹æ ‡å‡†çš„æ¨¡æ¿ï¼Œç”¨æˆ·å¯ä»¥åˆ©ç”¨æ›´å¤šæµæ°´çº¿çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ï¼š

- ä»£ç åŒ–: æµæ°´çº¿æ˜¯åœ¨ä»£ç ä¸­å®ç°çš„ï¼Œé€šå¸¸ä¼šå­˜æ”¾åˆ°æºä»£ç æ§åˆ¶ï¼Œä½¿å›¢é˜Ÿå…·æœ‰ç¼–è¾‘ã€å®¡æŸ¥å’Œæ›´æ–°ä»–ä»¬é¡¹ç›®çš„äº¤ä»˜æµæ°´çº¿çš„èƒ½åŠ›ã€‚
- è€ç”¨æ€§ï¼šæµæ°´çº¿å¯ä»¥ä»Jenkinsçš„masterèŠ‚ç‚¹é‡å¯åç»§ç»­è¿è¡Œã€‚
- å¯æš‚åœçš„ï¼šæµæ°´çº¿å¯ä»¥ç”±äººåŠŸè¾“å…¥æˆ–æ‰¹å‡†ç»§ç»­æ‰§è¡Œæµæ°´çº¿ã€‚
- è§£å†³å¤æ‚å‘å¸ƒï¼š æ”¯æŒå¤æ‚çš„äº¤ä»˜æµç¨‹ã€‚ä¾‹å¦‚å¾ªç¯ã€å¹¶è¡Œæ‰§è¡Œã€‚
- å¯æ‰©å±•æ€§ï¼š æ”¯æŒæ‰©å±•DSLå’Œå…¶ä»–æ’ä»¶é›†æˆã€‚

æ„å»ºä¸€ä¸ªå¯æ‰©å±•æ˜¯Jenkinsçš„æ ¸å¿ƒä»·å€¼ï¼Œæµæ°´çº¿å¯ä»¥é€šè¿‡ShareLibraryçš„æ–¹å¼æ¥æ‰©å±•ã€‚

## pipelineå®šä¹‰

å…³äºJenkinsæµæ°´çº¿çš„è¿è¡Œæˆ‘ä»¬å¯ä»¥æŠ½è±¡ä¸€ä¸‹ï¼Œä¾‹å¦‚ï¼šå¯ä»¥æŠŠæµæ°´çº¿(pipeline)æƒ³è±¡æˆ13å·çº¿åœ°é“ï¼ŒæŠŠæµæ°´çº¿çš„é˜¶æ®µ(stage)æƒ³è±¡æˆåœ°é“çš„æ¯ä¸€ä¸ªç«™ç‚¹ï¼ŒæŠŠæµæ°´çº¿è„šæœ¬(jenkinsfile)æƒ³è±¡æˆåœ°é“çº¿è·¯å›¾ã€‚è¿™å°±æ˜¯æµæ°´çº¿çš„å¤šæ ·æ€§ï¼Œæ¯æ¡çº¿è·¯éƒ½æœ‰ä¸åŒçš„ç«™ç‚¹ã€‚

[![images](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/images/01-subwaybeijing.jpg)](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/images/01-subwaybeijing.jpg)

ç°åœ¨åœ°é“ï¼ˆJenkinsï¼‰å·²ç»æœ‰äº†ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡åœ°é“çš„è¿è¡Œçº¿è·¯å›¾ï¼ˆJenkinsfileï¼‰ï¼Œåœ¨çº¿è·¯å›¾ä¸­æŒ‡å®šè¦ç»è¿‡çš„ç«™ç‚¹ï¼ˆstagesï¼‰ã€‚è¿™ä¸‹ä½ æ˜¯å¦å·²ç»çŸ¥é“æˆ‘ä»¬è¦è¿è¡Œä¸€æ¡æµæ°´çº¿ï¼Œéœ€è¦å…ˆåšä»€ä¹ˆå‘¢ï¼Ÿ â€“ç¼–å†™jenkinsfile

Pipeline

- Jenkinsçš„Pipelineé€šè¿‡Jenkinsfileè¿›è¡Œæè¿°ï¼ˆç±»ä¼¼äºDockerfileï¼‰
- Jenkinsfileæ˜¯Jenkinsçš„ç‰¹æ€§ï¼ˆpipeline as codeï¼‰
- Pipelineæ˜¯Jenkinsçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›ä¸€ç»„å¯æ‰©å±•çš„å·¥å…·ã€‚
- é€šè¿‡Pipeline çš„DSLï¼ˆPipeline Domain Specific Languageï¼‰è¯­æ³•å¯ä»¥å®Œæˆä»ç®€å•åˆ°å¤æ‚çš„äº¤ä»˜æµæ°´çº¿å®ç°ã€‚

Jenkinsfile

- Jenkinsfileä½¿ç”¨ä¸¤ç§è¯­æ³•è¿›è¡Œç¼–å†™ï¼Œåˆ†åˆ«æ˜¯å£°æ˜å¼å’Œè„šæœ¬å¼ã€‚
- å£°æ˜å¼å’Œè„šæœ¬å¼çš„æµæ°´çº¿ä»æ ¹æœ¬ä¸Šæ˜¯ä¸åŒçš„ã€‚
- å£°æ˜å¼æ˜¯jenkinsæµæ°´çº¿æ›´å‹å¥½çš„ç‰¹æ€§ã€‚
- è„šæœ¬å¼çš„æµæ°´çº¿è¯­æ³•ï¼Œæä¾›æ›´ä¸°å¯Œçš„è¯­æ³•ç‰¹æ€§ã€‚
- å£°æ˜å¼æµæ°´çº¿ä½¿ç¼–å†™å’Œè¯»å–æµæ°´çº¿ä»£ç æ›´å®¹æ˜“è®¾è®¡ã€‚

## pipelineæ¼”ç¤º

æ¥æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹è¿™é‡Œçš„é…ç½®ï¼Œçœ‹ä¸‹Jenkinsfileçš„ç»„æˆåŠæ¯ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½å«ä¹‰ã€‚

- ä½¿ç”¨agent{}ï¼ŒæŒ‡å®šnodeèŠ‚ç‚¹/workspaceï¼ˆå®šä¹‰å¥½æ­¤æµæ°´çº¿åœ¨æŸèŠ‚ç‚¹è¿è¡Œï¼‰
- æŒ‡å®šoptions{}è¿è¡Œé€‰é¡¹ï¼ˆå®šä¹‰å¥½æ­¤æµæ°´çº¿è¿è¡Œæ—¶çš„ä¸€äº›é€‰é¡¹ï¼Œä¾‹å¦‚è¾“å‡ºæ—¥å¿—çš„æ—¶é—´ï¼‰
- æŒ‡å®šstages{}ï¼ˆstagesåŒ…å«å¤šä¸ªstageï¼ŒstageåŒ…å«stepsã€‚æ˜¯æµæ°´çº¿çš„æ¯ä¸ªæ­¥éª¤)
- æŒ‡å®špost{}ï¼ˆå®šä¹‰å¥½æ­¤æµæ°´çº¿è¿è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥åï¼Œæ ¹æ®çŠ¶æ€åšä¸€äº›ä»»åŠ¡ï¼‰

```groovy
pipeline{
    //æŒ‡å®šè¿è¡Œæ­¤æµæ°´çº¿çš„èŠ‚ç‚¹
    agent { node { label "build"}}
    

    //æµæ°´çº¿çš„é˜¶æ®µ
    stages{

        //é˜¶æ®µ1 è·å–ä»£ç 
        stage("CheckOut"){
            steps{
                script{
                    println("è·å–ä»£ç ")
                }
            }
        }
        stage("Build"){
            steps{
                script{
                    println("è¿è¡Œæ„å»º")
                }
            }
        }
    }
    post {
        always{
            script{
                println("æµæ°´çº¿ç»“æŸåï¼Œç»å¸¸åšçš„äº‹æƒ…")
            }
        }
        
        success{
            script{
                println("æµæ°´çº¿æˆåŠŸåï¼Œè¦åšçš„äº‹æƒ…")
            }
        
        }
        failure{
            script{
                println("æµæ°´çº¿å¤±è´¥åï¼Œè¦åšçš„äº‹æƒ…")
            }
        }
        
        aborted{
            script{
                println("æµæ°´çº¿å–æ¶ˆåï¼Œè¦åšçš„äº‹æƒ…")
            }
        
        }
    }
}
```

## éªŒè¯æµæ°´çº¿æ•ˆæœ

æŸ¥çœ‹Jenkinsæ„å»ºæ—¥å¿—ï¼ˆæ­£ç¡®æ•ˆæœï¼‰[![images](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/images/03-jenkinslog.png)](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/images/03-jenkinslog.png)

é€šè¿‡BlueOceanæŸ¥çœ‹ï¼ˆå¦‚æœæ²¡æœ‰BlueOceanå›¾æ ‡ï¼Œéœ€è¦è‡ªè¡Œåœ¨æ’ä»¶ä¸­å¿ƒå®‰è£…æ’ä»¶ï¼‰[![images](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/images/02-blueocean.png)](http://docs.idevops.site/jenkins/pipelinesyntax/chapter01/images/02-blueocean.png)

åˆ°æ­¤ä¸€ä¸ªç®€å•çš„Jenkinfileå®Œæˆäº†ï¼ åé¢æˆ‘ä»¬æ¥è¯¦ç»†åˆ†ææ¯ä¸ªæ­¥éª¤çš„ä½œç”¨ã€‚