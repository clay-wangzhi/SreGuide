import{_ as s}from"./plugin-vue_export-helper-c27b6911.js";import{o as a,c as n,e}from"./app-3644928f.js";const t={},p=e(`<h1 id="k8s-æ— å¤‡ä»½-ä¸è¿ç»´" tabindex="-1"><a class="header-anchor" href="#k8s-æ— å¤‡ä»½-ä¸è¿ç»´" aria-hidden="true">#</a> K8s æ— å¤‡ä»½ï¼Œä¸è¿ç»´</h1><p>å‡ºæ•…éšœæ—¶ï¼Œå°±çŸ¥é“æ˜¯è°åœ¨è£¸æ³³ ğŸ™ƒ</p><p>K8s æŠ•äº§ä½¿ç”¨ï¼Œå¤‡ä»½æ˜¯ä¿å‘½æ‰‹æ®µï¼Œå¿…é¡»è¦ä¸Šï¼Œå»ºè®®åšä¸€ä¸ª checklistï¼Œå·¡æ£€é€šè¿‡ï¼Œé›†ç¾¤æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ¯”å¦‚ï¼Œè¿™æ ·ğŸ‘‡</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240320195757171.png" alt="image-20240320195757171"></p><h2 id="å¤‡ä»½æ–¹æ¡ˆåˆ¶å®š" tabindex="-1"><a class="header-anchor" href="#å¤‡ä»½æ–¹æ¡ˆåˆ¶å®š" aria-hidden="true">#</a> å¤‡ä»½æ–¹æ¡ˆåˆ¶å®š</h2><ol><li>ç‰©ç†å¤‡ä»½ï¼šetcd å¤‡ä»½ï¼Œä¿å­˜æŸä¸€ä¸ªæ—¶åˆ»çš„å¿«ç…§ï¼Œå¿«æ·æ–¹ä¾¿ã€‚</li><li>é€»è¾‘å¤‡ä»½ï¼švelero å¤‡ä»½ ï¼Œå…è®¸ç”¨æˆ·è‡ªå·±é€‰æ‹©å¤‡ä»½çš„å†…å®¹ï¼Œæ¯”å¦‚å•ä¸ª namespaceã€æŒ‡å®šèµ„æºç±»å‹ç­‰ã€‚</li></ol><p>ç‰©ç†å¤‡ä»½çš„ä¼˜ç‚¹æ˜¯é€Ÿåº¦å¿«ï¼Œæ— è®ºæ˜¯å¤‡ä»½è¿˜æ˜¯å›æ¢å¤ï¼Œä½†ç¼ºç‚¹æ˜¯å…ƒæ•°æ®ä¸å¯è¯»ï¼Œåªèƒ½å…¨éƒ¨æ¢å¤ã€‚è€Œé€»è¾‘å¤‡ä»½æ­£å¥½ç›¸åï¼Œå› æ­¤ä¸¤è€…å¯ä»¥ç»“åˆä½¿ç”¨ï¼Œæ—¢èƒ½å¿«ï¼Œåˆèƒ½æœ‰ç»†ç²’åº¦æ§åˆ¶çš„èƒ½åŠ›ã€‚</p><h2 id="etcd-å¤‡ä»½" tabindex="-1"><a class="header-anchor" href="#etcd-å¤‡ä»½" aria-hidden="true">#</a> Etcd å¤‡ä»½</h2><p>1ã€åˆ›å»ºå¤‡ä»½è„šæœ¬<code>/opt/etcd_backup.sh</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token comment">#</span>
<span class="token comment"># Etcd backup</span>
 
<span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span>
 
<span class="token assign-left variable">ETCD_CA_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span>
<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.crt&quot;</span>
<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.key&quot;</span>
<span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">&quot;/var/lib/docker/etcd_backup&quot;</span>
<span class="token assign-left variable">DT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d.%H%M%S<span class="token variable">)</span></span>
 
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-d</span> <span class="token variable">\${BACKUP_DIR}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">\${BACKUP_DIR}</span>
<span class="token function">find</span> <span class="token variable">\${BACKUP_DIR}</span> <span class="token parameter variable">-name</span> <span class="token string">&quot;*.db&quot;</span> <span class="token parameter variable">-mtime</span> +7 <span class="token parameter variable">-exec</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>
 
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /usr/local/bin/etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span>https://127.0.0.1:2379 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>
  snapshot save <span class="token string">&quot;<span class="token variable">\${BACKUP_DIR}</span>/etcd-snapshot-<span class="token variable">\${DT}</span>.db&quot;</span>
 
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Etcd backup success, backup file: <span class="token variable">\${BACKUP_DIR}</span>/etcd-snapshot-<span class="token variable">\${DT}</span>.db, \\
  file size: <span class="token variable"><span class="token variable">$(</span><span class="token function">du</span> <span class="token parameter variable">-sh</span> $<span class="token punctuation">{</span>BACKUP_DIR<span class="token punctuation">}</span>/etcd-snapshot-$<span class="token punctuation">{</span>DT<span class="token punctuation">}</span>.db <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">&#39;{print $1}&#39;</span><span class="token variable">)</span></span>&quot;</span>
<span class="token builtin class-name">echo</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ã€æ·»åŠ cronå®šæ—¶ä»»åŠ¡ <code>crontab -e</code></p><blockquote><p>åªéœ€è¦å¤‡ä»½ä¸€ä¸ªetcdå°±è¡Œï¼Œæ¢å¤æ—¶ï¼Œæ‹¿åŒä¸€ä»½å¤‡ä»½æ•°æ®æ¢å¤</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">0</span> */1 * * * /bin/bash /opt/etcd_backup.sh <span class="token operator">&gt;&gt;</span>/opt/log-backup-etcd.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="velero-å¤‡ä»½" tabindex="-1"><a class="header-anchor" href="#velero-å¤‡ä»½" aria-hidden="true">#</a> velero å¤‡ä»½</h2><p>1ã€å®‰è£…é…ç½® velero</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ä¸‹è½½ç‰ˆæœ¬ï¼šhttps://github.com/vmware-tanzu/velero/releases æœ€æ–°ç¨³å®šç‰ˆï¼Œæ³¨æ„k8sç‰ˆæœ¬å…¼å®¹æ€§ï¼Œ1.8.1ç‰ˆæœ¬è¦æ±‚k8sç‰ˆæœ¬è‡³å°‘1.16</span>
<span class="token function">wget</span> https://github.com/vmware-tanzu/velero/releases/download/v1.8.1/velero-v1.8.1-linux-amd64.tar.gz
<span class="token comment"># è§£å‹</span>
<span class="token function">tar</span> <span class="token parameter variable">-xvf</span> velero-v1.8.1-linux-amd64.tar.gz
<span class="token comment"># åŠ å…¥ç¯å¢ƒå˜é‡</span>
<span class="token function">cp</span> velero-v1.8.1-linux-amd64/velero /usr/bin/
<span class="token comment"># è®¾ç½®è¡¥å…¨å‘½ä»¤</span>
velero completion <span class="token function">bash</span> <span class="token operator">&gt;</span> /etc/bash_completion.d/velero.sh
<span class="token builtin class-name">source</span> /etc/bash_completion.d/velero.sh
<span class="token comment"># åˆ›å»ºå‡­è¯æ–‡ä»¶ cat credentials-velero</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>xxx
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span>xxx
<span class="token comment"># å®‰è£…</span>
velero <span class="token function">install</span>  <span class="token parameter variable">--provider</span> aws <span class="token parameter variable">--plugins</span> velero/velero-plugin-for-aws:v1.1.0 <span class="token parameter variable">--bucket</span>  velero-xxx --secret-file ./credentials-velero --use-volume-snapshots<span class="token operator">=</span>false --use-restic --default-volumes-to-restic --backup-location-config <span class="token assign-left variable">region</span><span class="token operator">=</span>ap-shanghai,s3ForcePathStyle<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>,s3Url<span class="token operator">=</span>https://cos.ap-shanghai.myqcloud.com --restic-pod-cpu-request<span class="token operator">=</span>1000m --restic-pod-cpu-limit<span class="token operator">=</span>2000m --restic-pod-mem-request<span class="token operator">=</span>1024Mi --restic-pod-mem-limit<span class="token operator">=</span>4096Mi  --velero-pod-cpu-request<span class="token operator">=</span>1000m --velero-pod-cpu-limit<span class="token operator">=</span>2000m --velero-pod-mem-request<span class="token operator">=</span>1024Mi --velero-pod-mem-limit<span class="token operator">=</span>4096Mi
<span class="token comment"># æŸ¥çœ‹é…ç½®çš„å­˜å‚¨ä½ç½®æ˜¯å¦å¯ç”¨</span>
velero backup-location get
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ã€æ ¹æ®å®é™…æƒ…å†µå¤‡ä»½æŒ‡å®š namespace æˆ– æŒ‡å®šèµ„æºç±»å‹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>velero create schedule xxx <span class="token parameter variable">--schedule</span><span class="token operator">=</span><span class="token string">&quot;0 1 * * *&quot;</span> --include-namespaces<span class="token operator">=</span>prod --snapshot-volumes<span class="token operator">=</span>false --default-volumes-to-restic<span class="token operator">=</span>false <span class="token parameter variable">--ttl</span><span class="token operator">=</span>168h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="etcd-æ¢å¤" tabindex="-1"><a class="header-anchor" href="#etcd-æ¢å¤" aria-hidden="true">#</a> Etcd æ¢å¤</h2><p>1ã€åˆ›å»ºå¤‡ä»½ç›®å½•</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/k8s_manifests_backup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2ã€åœæ­¢æ‰€æœ‰ Master ä¸Š kube-apiserver æœåŠ¡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mv</span> /etc/kubernetes/manifests/kube-apiserver.yaml /opt/k8s_manifests_backup/
<span class="token comment"># æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²åœæ­¢</span>
kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> kube-apiserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ã€åœæ­¢é›†ç¾¤ä¸­æ‰€æœ‰ etcd æœåŠ¡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># è®°å½• etcd --nameã€--initial-advertise-peer-urlsã€--data-dir å€¼</span>
<span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> etcd
<span class="token comment"># åœæ­¢æœåŠ¡</span>
<span class="token function">mv</span> /etc/kubernetes/manifests/etcd.yaml /opt/k8s_manifests_backup/
<span class="token comment"># æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²åœæ­¢</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> etcd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4ã€ç§»é™¤æ‰€æœ‰ etcd å­˜å‚¨ç›®å½•ä¸‹æ•°æ®ï¼Œä¸åŒç¯å¢ƒä¸‹ï¼Œå­˜å‚¨ç›®å½•å¯èƒ½ä¸ä¸€æ ·ï¼Œæ ·ä¾‹å­˜å‚¨ç›®å½•ä¸º <code>/data/etcd</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mv</span> /data/etcd<span class="token punctuation">{</span>,.bak<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>5ã€æ‹·è´è¦æ¢å¤çš„å¿«ç…§åˆ°æ‰€æœ‰ etcd èŠ‚ç‚¹ï¼Œè¿›è¡Œå¿«ç…§æ¢å¤ æ‰€æœ‰ etcd èŠ‚ç‚¹æ“ä½œï¼Œä¸åŒèŠ‚ç‚¹ï¼Œä¼ å…¥ä¸åŒçš„ <code>--nameã€--initial-advertise-peer-urlsã€--data-dir</code>å€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /usr/local/bin/etcdctl snapshot restore /tmp/xxx.db <span class="token punctuation">\\</span>
  <span class="token parameter variable">--name</span> hostname1 <span class="token punctuation">\\</span>
  --initial-cluster <span class="token string">&quot;hostname1=https://ip1:2380,hostname2=https://ip2:2380,hostname3=https://ip3:2380&quot;</span> <span class="token punctuation">\\</span>
  --initial-cluster-token k8s_etcd <span class="token punctuation">\\</span>
  --initial-advertise-peer-urls https://ip1:2380 <span class="token punctuation">\\</span>
  --data-dir<span class="token operator">=</span>/data/etcd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>6ã€å¯åŠ¨é›†ç¾¤ä¸­æ‰€æœ‰ etcd</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mv</span> /opt/k8s_manifests_backup/etcd.yaml /etc/kubernetes/manifests/
<span class="token comment"># æ£€æŸ¥é›†ç¾¤çŠ¶æ€</span>
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /usr/local/bin/etcdctl  <span class="token parameter variable">--cacert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/ca.crt <span class="token punctuation">\\</span>
  <span class="token parameter variable">--cert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/server.crt <span class="token punctuation">\\</span>
  <span class="token parameter variable">--key</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/server.key <span class="token punctuation">\\</span>
  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span>https://ip1:2379,https://ip2:2379,https://ip3:2379 <span class="token punctuation">\\</span>
  endpoint health
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>7ã€å¯åŠ¨æ‰€æœ‰ Master ä¸Š kube-apiserver æœåŠ¡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mv</span> /opt/k8s_manifests_backup/kube-apiserver.yaml /etc/kubernetes/manifests/
<span class="token comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span>
kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> kube-apiserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>8ã€æ£€æŸ¥æ˜¯å¦å¦‚æœŸæ¢å¤</p><p><strong>æ€»ç»“</strong></p><p>Kubernetes é›†ç¾¤å¤‡ä»½ä¸»è¦æ˜¯å¤‡ä»½etcdé›†ç¾¤ã€‚è€Œæ¢å¤æ—¶ï¼Œä¸»è¦è€ƒè™‘æ¢å¤æ•´ä¸ªé¡ºåºï¼š</p><p>åœæ­¢Kube-apiserver --&gt; åœæ­¢etcd --&gt; æ¢å¤æ•°æ® --&gt; å¯åŠ¨etcd --&gt; å¯åŠ¨kube-apiserver</p><h2 id="velero-æ¢å¤" tabindex="-1"><a class="header-anchor" href="#velero-æ¢å¤" aria-hidden="true">#</a> velero æ¢å¤</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æŸ¥è¯¢å¤‡ä»½ä¿¡æ¯</span>
velero backup get
<span class="token comment"># æŒ‰éœ€ä¸‹è½½å¤‡ä»½æ–‡ä»¶</span>
velero backup download filename
<span class="token comment"># è§£å‹</span>
<span class="token function">tar</span> <span class="token parameter variable">-xvf</span> xxx.tar.gz
<span class="token comment"># æ ¹æ®éœ€è¦è¿›è¡Œ yaml æ–‡ä»¶æ¢å¤</span>
kubectl apply <span class="token parameter variable">-f</span> filename/dirname
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šçº¿å‰ï¼Œé™¤äº†è¦åšå¥½å¿…è¦çš„å¤‡ä»½å¤–ï¼Œè¿˜æœ‰åšå¥½ å®¹é‡è§„åˆ’ã€ç½‘ç»œè§„åˆ’ã€æ¶æ„è§„åˆ’ã€ç»„ä»¶åŸºå‡†æµ‹è¯•ç­‰ï¼Œåç»­ç»§ç»­åˆ†äº«~</p><p>æˆ‘æ˜¯ Clayï¼Œä¸‹æœŸè§ ğŸ‘‹</p><hr><blockquote><ul><li><p>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·ã€ŒSREè¿ç»´è¿›é˜¶ä¹‹è·¯ã€æˆ–å…³æ³¨æˆ‘çš„ Github https://github.com/clay-wangzhi/wiki æŸ¥çœ‹æœ€æ–°æ–‡ç« </p></li><li><p>æ¬¢è¿åŠ æˆ‘å¾®ä¿¡<code>sre-k8s-ai</code>ï¼Œä¸æˆ‘è®¨è®ºäº‘åŸç”Ÿã€ç¨³å®šæ€§ç›¸å…³å†…å®¹</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin.png" alt="weixin" style="zoom:50%;">`,44),l=[p];function i(c,o){return a(),n("div",null,l)}const u=s(t,[["render",i],["__file","etcd-and-velero.html.vue"]]);export{u as default};
