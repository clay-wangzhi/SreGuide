import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{o as n,c as s,e}from"./app-4d4f7d7e.js";const t={},l=e(`<h1 id="k8s-cpu-throttle-ä¼˜åŒ–æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#k8s-cpu-throttle-ä¼˜åŒ–æ–¹æ¡ˆ" aria-hidden="true">#</a> K8s CPU Throttle ä¼˜åŒ–æ–¹æ¡ˆ</h1><h2 id="cpu-throttle-é—®é¢˜è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#cpu-throttle-é—®é¢˜è¯¦è§£" aria-hidden="true">#</a> CPU Throttle é—®é¢˜è¯¦è§£</h2><p>å—å†…æ ¸è°ƒåº¦æ§åˆ¶å‘¨æœŸï¼ˆcfs_periodï¼‰å½±å“ï¼Œå®¹å™¨çš„ CPU åˆ©ç”¨ç‡å¾€å¾€å…·æœ‰ä¸€å®šçš„æ¬ºéª—æ€§ï¼Œä¸‹å›¾å±•ç¤ºäº†æŸå®¹å™¨ä¸€æ®µæ—¶é—´çš„ CPU ä½¿ç”¨æƒ…å†µï¼ˆå•ä½ä¸º0.01æ ¸ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ 1s çº§åˆ«çš„ç²’åº¦ä¸‹ï¼ˆå›¾ä¸­ç´«è‰²æŠ˜çº¿ï¼‰ï¼Œå®¹å™¨çš„ CPU ç”¨é‡è¾ƒä¸ºç¨³å®šï¼Œå¹³å‡åœ¨ 2.5 æ ¸å·¦å³ã€‚æ ¹æ®ç»éªŒï¼Œç®¡ç†å‘˜ä¼šå°† CPU Limitè®¾ç½®ä¸º 4 æ ¸ã€‚æœ¬ä»¥ä¸ºè¿™å·²ç»ä¿ç•™äº†å……è¶³çš„å¼¹æ€§ç©ºé—´ï¼Œç„¶è€Œè‹¥æˆ‘ä»¬å°†è§‚å¯Ÿç²’åº¦æ”¾å¤§åˆ° 100ms çº§åˆ«ï¼ˆå›¾ä¸­ç»¿è‰²æŠ˜çº¿ï¼‰ï¼Œå®¹å™¨çš„ CPU ç”¨é‡å‘ˆç°å‡ºäº†ä¸¥é‡çš„æ¯›åˆºç°è±¡ï¼Œå³°å€¼è¾¾åˆ° 4 æ ¸ä»¥ä¸Šã€‚æ­¤æ—¶å®¹å™¨ä¼šäº§ç”Ÿé¢‘ç¹çš„ CPU Throttleï¼Œè¿›è€Œå¯¼è‡´åº”ç”¨æ€§èƒ½ä¸‹é™ã€RT æŠ–åŠ¨ï¼Œä½†æˆ‘ä»¬ä»å¸¸ç”¨çš„ CPU åˆ©ç”¨ç‡æŒ‡æ ‡ä¸­ç«Ÿç„¶å®Œå…¨æ— æ³•å‘ç°ï¼</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240802142813585.png" alt=""></p><p>æ¯›åˆºäº§ç”Ÿçš„åŸå› é€šå¸¸æ˜¯ç”±äºåº”ç”¨çªå‘æ€§çš„ CPU èµ„æºéœ€æ±‚ï¼ˆå¦‚ä»£ç é€»è¾‘çƒ­ç‚¹ã€æµé‡çªå¢ç­‰ï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥æè¿° CPU Throttle å¯¼è‡´åº”ç”¨æ€§èƒ½ä¸‹é™çš„è¿‡ç¨‹ã€‚å›¾ä¸­å±•ç¤ºäº†ä¸€ä¸ªCPU Limit = 2 çš„ Web æœåŠ¡ç±»å®¹å™¨ï¼Œåœ¨æ”¶åˆ°è¯·æ±‚åï¼ˆreqï¼‰å„çº¿ç¨‹ï¼ˆThreadï¼‰çš„ CPU èµ„æºåˆ†é…æƒ…å†µã€‚å‡è®¾æ¯ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´å‡ä¸º 60 msï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿å®¹å™¨åœ¨æœ€è¿‘æ•´ä½“çš„ CPU åˆ©ç”¨ç‡è¾ƒä½ï¼Œç”±äºåœ¨ 100 msï½200 ms åŒºé—´å†…è¿ç»­å¤„ç†äº†4 ä¸ªè¯·æ±‚ï¼Œå°†è¯¥å†…æ ¸è°ƒåº¦å‘¨æœŸå†…çš„æ—¶é—´ç‰‡é¢„ç®—ï¼ˆ200msï¼‰å…¨éƒ¨æ¶ˆè€—ï¼ŒThread 2 éœ€è¦ç­‰å¾…ä¸‹ä¸€ä¸ªå‘¨æœŸæ‰èƒ½ç»§ç»­å°† req 2 å¤„ç†å®Œæˆï¼Œè¯¥è¯·æ±‚çš„å“åº”æ—¶å»¶ï¼ˆRTï¼‰å°±ä¼šå˜é•¿ã€‚è¿™ç§æƒ…å†µåœ¨åº”ç”¨è´Ÿè½½ä¸Šå‡æ—¶å°†æ›´å®¹æ˜“å‘ç”Ÿï¼Œå¯¼è‡´å…¶ RT çš„é•¿å°¾æƒ…å†µå°†ä¼šå˜å¾—æ›´ä¸ºä¸¥é‡ã€‚</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240802143534465.png" alt=""></p><p>ä¸ºäº†é¿å… CPU Throttle çš„é—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½å°†å®¹å™¨çš„ CPU Limit å€¼è°ƒå¤§ã€‚ç„¶è€Œï¼Œè‹¥æƒ³å½»åº•è§£å†³ CPU Throttleï¼Œé€šå¸¸éœ€è¦å°† CPU Limit è°ƒå¤§ä¸¤ä¸‰å€ï¼Œæœ‰æ—¶ç”šè‡³äº”åˆ°åå€ï¼Œé—®é¢˜æ‰ä¼šå¾—åˆ°æ˜æ˜¾ç¼“è§£ã€‚è€Œä¸ºäº†é™ä½ CPU Limit è¶…å–è¿‡å¤šçš„é£é™©ï¼Œè¿˜éœ€é™ä½å®¹å™¨çš„éƒ¨ç½²å¯†åº¦ï¼Œè¿›è€Œå¯¼è‡´æ•´ä½“èµ„æºæˆæœ¬ä¸Šå‡ã€‚</p><h2 id="è°ƒç ”-cpu-burst-æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#è°ƒç ”-cpu-burst-æ–¹æ¡ˆ" aria-hidden="true">#</a> è°ƒç ” CPU Burst æ–¹æ¡ˆ</h2><p>**ä»€ä¹ˆæ˜¯ CPU Burstï¼š**CPU Burstï¼ˆCPU çªå‘ï¼‰æ˜¯æŒ‡åœ¨è®¡ç®—æœºå¤„ç†å™¨ç©ºé—²æ—¶ï¼Œå…è®¸è¿›ç¨‹æˆ–çº¿ç¨‹åœ¨ä¸€æ®µçŸ­æ—¶é—´å†…ä½¿ç”¨è¶…è¿‡å…¶å¹³å‡ CPU ä½¿ç”¨é‡çš„é¢å¤– CPU æ—¶é—´ã€‚åœ¨ CPU çªå‘æœŸé—´ï¼Œè¿›ç¨‹å¯ä»¥ä½¿ç”¨æ¯”å…¶åœ¨é™å®šæ—¶é—´æ®µå†…è¢«å…è®¸çš„å¹³å‡ CPU ä½¿ç”¨é‡æ›´å¤šçš„ CPU èµ„æºï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„å“åº”é€Ÿåº¦å’Œæ€§èƒ½ã€‚</p><p><strong>æ–¹æ¡ˆå¯¹æ¯”</strong></p><table><thead><tr><th></th><th>koordinator + cpuBurstOnly</th><th>koordinator + cfsQuotaBurstOnly</th><th>äºŒå¼€ koordlet ç»„ä»¶ + cfsQuotaBurstOnly</th></tr></thead><tbody><tr><td>ä¾èµ–</td><td>æ“ä½œç³»ç»Ÿå†…æ ¸ &gt;= 5.14</td><td></td><td></td></tr><tr><td>ç­–ç•¥æ§åˆ¶</td><td>CRD/configmap/annotation</td><td>CRD/configmap/annotation</td><td>configmap/annotation</td></tr><tr><td>åŠŸèƒ½&amp;å¤æ‚åº¦</td><td>åŠŸèƒ½å¼ºå¤§ä¸”å¤æ‚<br>Koord-Scheduler/Koord-Descheduler/Koord-Manager/Koordlet/Koord-RuntimeProxy</td><td>åŠŸèƒ½å¼ºå¤§ä¸”å¤æ‚<br>Koord-Scheduler/Koord-Descheduler/Koord-Manager/Koordlet/Koord-RuntimeProxy</td><td>åŠŸèƒ½å•ä¸€ç®€å•ï¼Œæ”¯æŒåŸºäºå…¨å±€ cm æŒ‡å®šå“ªäº› Pod éœ€è¦æ‰§è¡Œç­–ç•¥<br>Koordlet</td></tr></tbody></table><p><strong>æœ¬é¡¹ç›®çš„ç”±æ¥</strong>ï¼š äºŒå¼€ koordlet ç»„ä»¶ + cfsQuotaBurstOnly ä¼˜åŒ– K8s CPU Throttle é—®é¢˜</p><h2 id="é¡¹ç›®æ¶æ„" tabindex="-1"><a class="header-anchor" href="#é¡¹ç›®æ¶æ„" aria-hidden="true">#</a> é¡¹ç›®æ¶æ„</h2><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/koordlet.png" alt=""></p><p>StatesInformer</p><ul><li>Node Informerï¼šæä¾›æœ¬èŠ‚ç‚¹ corev1.Node</li><li>Pod Informerï¼šæä¾›æœ¬èŠ‚ç‚¹æ‰€æœ‰ PodMeta ä¿¡æ¯ï¼Œ PodMeta åŒ…æ‹¬ corev1.Pod å’Œ CgroupDir <ul><li>PLEGï¼šç›‘å¬ Pod å˜åŒ–ï¼Œè§¦å‘åŒæ­¥</li><li>Kubeletï¼šè·å– GetAllPods</li></ul></li><li>CM Informerï¼šæä¾›å…¨å±€ CM æŒ‡å®šå“ªäº› Pod ï¼Œå¯ä»¥åŠ¨æ€è°ƒèŠ‚ cpu.cfs_quota_us</li></ul><p>Metric Cacheï¼šPrometheus tsdb å­˜åœ¨æ”¶é›†åˆ°çš„æŒ‡æ ‡</p><p>MetricCollectors</p><ul><li>Node Infoï¼šæ”¶é›† Node CPU æ ¸æ•°ç­‰</li><li>Node Resourceï¼šæ”¶é›† Node CPU ã€MEM ä½¿ç”¨æƒ…å†µ</li><li>Pod Throttledï¼šæ”¶é›† Pod Throttled ä¿¡æ¯ï¼Œä» cpu.stat æ”¶é›†</li></ul><p>CPU Burst Pluginï¼šå‘ç° Pod Throttledï¼Œ åŠ¨æ€è°ƒæ•´ cpu.cfs_quota_us</p><h2 id="å¿«é€Ÿå¼€å§‹" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿå¼€å§‹" aria-hidden="true">#</a> å¿«é€Ÿå¼€å§‹</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º ns</span>
kubectl apply <span class="token parameter variable">-f</span> manifests/setup/
<span class="token comment"># åˆ›å»º rbacã€cmã€ds</span>
kubectl apply <span class="token parameter variable">-f</span> manifests/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤çš„ cm å†…å®¹å¦‚ä¸‹ï¼š</p><p>å…¶ä¸­ <code>appï¼šapache-demo</code> æ˜¯ç”¨äºåŒ¹é… Pod çš„ label çš„ï¼ŒåŒ¹é…æˆåŠŸï¼Œåˆ™ Pod åº”ç”¨ ç­–ç•¥</p><p><code>cpu-burst-config</code> æ˜¯é»˜è®¤çš„ç­–ç•¥æ–‡ä»¶</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">app</span><span class="token punctuation">:</span> apache<span class="token punctuation">-</span>demo
  <span class="token key atrule">cpu-burst-config</span><span class="token punctuation">:</span> &#39;<span class="token punctuation">{</span><span class="token key atrule">&quot;policy&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;cfsQuotaBurstOnly&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;cpuBurstPercent&quot;</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;cfsQuotaBurstPercent&quot;</span><span class="token punctuation">:</span>
    <span class="token number">300</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;cfsQuotaBurstPeriodSeconds&quot;</span><span class="token punctuation">:</span> <span class="token number">-1</span><span class="token punctuation">}</span>&#39;
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cfs<span class="token punctuation">-</span>quota<span class="token punctuation">-</span>burst<span class="token punctuation">-</span>cm
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> koordinator<span class="token punctuation">-</span>system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»º demo æµ‹è¯•</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> apache<span class="token punctuation">-</span>demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> apache<span class="token punctuation">-</span>demo <span class="token comment"># use label enable or disable CPU Burst.</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpd
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>D
    <span class="token punctuation">-</span> FOREGROUND
    <span class="token key atrule">image</span><span class="token punctuation">:</span> koordinatorsh/apache<span class="token punctuation">-</span>2<span class="token punctuation">-</span>4<span class="token punctuation">-</span>51<span class="token punctuation">-</span>for<span class="token punctuation">-</span>slo<span class="token punctuation">-</span>test<span class="token punctuation">:</span>v0.1
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
    <span class="token key atrule">name</span><span class="token punctuation">:</span> apache
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;4&quot;</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Gi
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;4&quot;</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Gi
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token comment"># $nodeName Set the value to the name of the node that you use.</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ wrk2 è¿›è¡Œå‹åŠ›æµ‹è¯•</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./wrk <span class="token parameter variable">-H</span> <span class="token string">&quot;Accept-Encoding: deflate, gzip&quot;</span> <span class="token parameter variable">-t</span> <span class="token number">2</span> <span class="token parameter variable">-c</span> <span class="token number">12</span> <span class="token parameter variable">-d</span> <span class="token number">120</span> <span class="token parameter variable">--latency</span> <span class="token parameter variable">--timeout</span> 2s <span class="token parameter variable">-R</span> <span class="token number">24</span> http://<span class="token variable">$target_ip_address</span>:8010/static/file.1m.test
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å°† demo ä¸­ label å»æ‰ï¼Œå†è¿›è¡Œæµ‹è¯•</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>apiVersion: v1
kind: Pod
metadata:
  name: apache-demo
spec:
  containers:
  - command:
    - httpd
    - <span class="token parameter variable">-D</span>
    - FOREGROUND
    image: koordinatorsh/apache-2-4-51-for-slo-test:v0.1
    imagePullPolicy: Always
    name: apache
    resources:
      limits:
        cpu: <span class="token string">&quot;4&quot;</span>
        memory: 10Gi
      requests:
        cpu: <span class="token string">&quot;4&quot;</span>
        memory: 10Gi
  nodeName: <span class="token comment"># $nodeName Set the value to the name of the node that you use.</span>
  hostNetwork: False
  restartPolicy: Never
  schedulerName: default-scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl delete pod apache-demo
kubectl apply <span class="token parameter variable">-f</span> apache-demo.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th>é»˜è®¤</th><th>å¼€å¯ cfsQuotaBurstOnly</th></tr></thead><tbody><tr><td>apache RT-p99</td><td>231.93ms</td><td>99.52ms</td></tr></tbody></table><h2 id="show-me-code" tabindex="-1"><a class="header-anchor" href="#show-me-code" aria-hidden="true">#</a> Show me Code</h2><p>æºç åœ°å€ï¼šhttps://github.com/clay-wangzhi/cfs-quota-burst</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p>å¦‚ä½•åˆç†ä½¿ç”¨ CPU ç®¡ç†ç­–ç•¥ï¼Œæå‡å®¹å™¨æ€§èƒ½ï¼Ÿï¼šhttps://developer.aliyun.com/article/872282</p><p>Koordinator cpuBurstï¼š https://koordinator.sh/zh-Hans/docs/user-manuals/cpu-burst</p><p>æˆ‘æ˜¯ Clayï¼Œä¸‹æœŸè§ ğŸ‘‹</p><hr><blockquote><ul><li><p>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·ã€ŒSREè¿ç»´è¿›é˜¶ä¹‹è·¯ã€æˆ–å…³æ³¨æˆ‘çš„ Github https://github.com/clay-wangzhi/SreGuide æŸ¥çœ‹æœ€æ–°æ–‡ç« </p></li><li><p>æ¬¢è¿åŠ æˆ‘å¾®ä¿¡<code>sre-k8s-ai</code>ï¼Œä¸æˆ‘è®¨è®ºäº‘åŸç”Ÿã€ç¨³å®šæ€§ç›¸å…³å†…å®¹</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin-20240615194414355.png" alt="weixin" style="zoom:50%;">`,44),i=[l];function p(o,c){return n(),s("div",null,i)}const d=a(t,[["render",p],["__file","cpu-burst.html.vue"]]);export{d as default};
