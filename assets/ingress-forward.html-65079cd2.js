import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as e,e as n}from"./app-7187cc90.js";const t={},r=n(`<h1 id="æ•…éšœæ’æŸ¥-ä¹‹-å•ç‚¹ç™»å½•è·³è½¬å¤±è´¥-ingress-ç›¸å…³" tabindex="-1"><a class="header-anchor" href="#æ•…éšœæ’æŸ¥-ä¹‹-å•ç‚¹ç™»å½•è·³è½¬å¤±è´¥-ingress-ç›¸å…³" aria-hidden="true">#</a> æ•…éšœæ’æŸ¥ ä¹‹ å•ç‚¹ç™»å½•è·³è½¬å¤±è´¥(Ingress ç›¸å…³)</h1><h2 id="æ•…éšœç°è±¡" tabindex="-1"><a class="header-anchor" href="#æ•…éšœç°è±¡" aria-hidden="true">#</a> æ•…éšœç°è±¡</h2><p>å•ç‚¹ç™»å½•å¤±è´¥ï¼Œä½†æ˜¯å…¶ä»–æ¥å£æ­£å¸¸</p><h2 id="æ ¹å› åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æ ¹å› åˆ†æ" aria-hidden="true">#</a> æ ¹å› åˆ†æ</h2><p>é—®é¢˜è¦ç‚¹æ˜¯ï¼šå•ç‚¹ç™»å½•å¤±è´¥ï¼Œçœ‹ä»£ç æ˜¯ request å’Œ response çš„ RedirectUri ä¸ä¸€æ ·å¯¼è‡´çš„ã€‚</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241106201212000.png" alt=""></p><p>ç›®å‰çš„å—åŒ—æµé‡æ¶æ„ä¸ºï¼š</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241106205830482.png" alt=""></p><p><strong>äºŒåˆ†æ³•æ’æŸ¥é—®é¢˜</strong>ï¼šå»æ‰ å¤–å±‚ Nginxï¼Œ æˆ–è€…å»æ‰ K8s Ingress , æ•…éšœå‡å¯æ¢å¤ï¼Œé‚£ä¹ˆé—®é¢˜å°±å‡ºç°åœ¨è½¬å‘è¿‡ç¨‹ã€‚</p><p><strong>ä½¿ç”¨ arthas æ’æŸ¥é—®é¢˜</strong>ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># è¿›å…¥ Pod æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</span>
<span class="token function">curl</span> <span class="token parameter variable">-O</span> https://arthas.aliyun.com/arthas-boot.jar
<span class="token function">java</span> <span class="token parameter variable">-jar</span> arthas-boot.jar
<span class="token function">watch</span> org.springframework.security.oauth2.client.authentication.OAuth2LoginAuthenticationProvider authenticate <span class="token string">&#39;params[0]&#39;</span> <span class="token parameter variable">-x</span> <span class="token number">4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241106203055523.png" alt=""></p><p>å¯ä»¥è¯å®æ˜¯ <code>redirectUri</code> ä¸ä¸€è‡´å¯¼è‡´çš„ã€‚</p><p><strong>æŠ“åŒ…æ’æŸ¥é—®é¢˜</strong>ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ç™»å½• Pod æ‰€åœ¨ Node èŠ‚ç‚¹ï¼ŒæŠ“åŒ…</span>
<span class="token assign-left variable">podName</span><span class="token operator">=</span>xxx
nsenter <span class="token parameter variable">-t</span> <span class="token variable"><span class="token variable">$(</span>nerdctl <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> $<span class="token punctuation">{</span>podName<span class="token punctuation">}</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> pause <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">&#39;{print $1}&#39;</span> <span class="token operator">|</span> <span class="token function">xargs</span> nerdctl inspect <span class="token parameter variable">-f</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>.State.Pid<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">)</span></span> <span class="token parameter variable">-n</span> tcpdump <span class="token parameter variable">-i</span> eth0 <span class="token parameter variable">-nne</span> <span class="token parameter variable">-C</span> <span class="token number">100</span> <span class="token parameter variable">-W</span> <span class="token number">30</span> <span class="token parameter variable">-w</span> /tmp/container.pcap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†åŒ…ä¼ åˆ°æœ¬åœ°ï¼Œé€šè¿‡ wireshark è¿›è¡Œåˆ†æ</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241106200836425.png" alt=""></p><p>é‡ç‚¹çœ‹ <strong>X-Forwarded</strong> ä¿¡æ¯ï¼Œå‘ç° Scheme æ˜¯ httpï¼ŒPort æ˜¯ 80 ï¼Œ æ‹¿çš„ K8s Ingress çš„å€¼ã€‚</p><p>æ‰€ä»¥ K8s Ingress æ²¡æœ‰ä½¿ç”¨ä¸Šå±‚çš„ X-Forwarded ä¿¡æ¯ã€‚</p><p>æ”¹è¿›ï¼šå¦‚æœ Nginx åœ¨å…¶ä»–7å±‚ä»£ç†æˆ–è´Ÿè½½å‡è¡¡åé¢ï¼Œå½“æœŸæœ›Nginxå°† <code>X-Forwarded-*</code> çš„å¤´ä¿¡æ¯ä¼ é€’ç»™åç«¯æœåŠ¡æ—¶ï¼Œåˆ™éœ€è¦å°†æ­¤å‚æ•°è®¾ä¸º true</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>  use-forwarded-headers: &quot;true&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ”¹å®Œï¼Œå†æŠ“åŒ…éªŒè¯ï¼š</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241106204434600.png" alt=""></p><p>å‘ç°è¿˜æ˜¯ä¸è¡Œï¼ŒScheme æ˜¯ httpsï¼Œå¯¹äº†ï¼Œä½†æ˜¯ Port è¿˜æ˜¯ 80ï¼Œ ä¹Ÿå°±æ„å‘³ç€ï¼Œå¤–å±‚ Nginxï¼Œæ²¡æœ‰æŠŠ Port ä¼ ä¸‹æ¥ã€‚</p><p>æœç´¢ Ingress Issue ï¼Œå‘ç°æœ‰ç±»ä¼¼çš„é—®é¢˜ï¼šProblem with HTTPS, CloudFlare and X-Forwarded-Port header https://github.com/kubernetes/ingress-nginx/issues/6358</p><p>ä»–ä½¿ç”¨çš„æ˜¯ CloudFlare äº§å“ï¼Œä¸æ”¯æŒåŠ  X-Forwarded-Port header ï¼Œ æˆ‘ä»¬ç”¨çš„è‡ªå»ºçš„ï¼Œå¯ä»¥ç›´æ¥å¢åŠ ä¸€ä¸ª headerï¼Œåœ¨å¤–å±‚ Nginx ä¸­æ–°å¢</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>    proxy_set_header X-Forwarded-Port <span class="token variable">$server_port</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>é—®é¢˜è§£å†³ï¼Œ enjoy</strong></p><h2 id="æ€»ç»“é—®é¢˜è§£å†³æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“é—®é¢˜è§£å†³æ–¹æ³•" aria-hidden="true">#</a> æ€»ç»“é—®é¢˜è§£å†³æ–¹æ³•</h2><p>è§£å†³æ–¹æ³•ä¸€ï¼šå¦‚ä¸Šè¿‡ç¨‹</p><p>1ï¼‰å¦‚æœ Nginx åœ¨å…¶ä»–7å±‚ä»£ç†æˆ–è´Ÿè½½å‡è¡¡åé¢ï¼Œå½“æœŸæœ›Nginxå°† <code>X-Forwarded-*</code> çš„å¤´ä¿¡æ¯ä¼ é€’ç»™åç«¯æœåŠ¡æ—¶ï¼ŒIngress æ–°å¢å‚æ•°ï¼Œ<code>use-forwarded-headers: &quot;true&quot;</code>ã€‚</p><p>2ï¼‰å¤–å±‚ Nginx ä¹Ÿé…ç½®å¥½ <code>X-Forwarded-Port</code>ç­‰ã€‚</p><p>è§£å†³æ–¹æ³•äºŒï¼š</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241106205159434.png" alt=""></p><p>è¿™é‡Œçš„ upstream æ¢æˆ https://$ip:443 å’Œ å¤–å±‚ä¿æŒä¸€è‡´å³å¯</p><p>è§£å†³æ–¹æ³•ä¸‰ï¼š</p><p>å¦‚æœåƒè¿™ä¸ª issue https://github.com/kubernetes/ingress-nginx/issues/6358 è¿™æ ·ï¼Œ å¤–å±‚ Nginxï¼Œ å’Œ K8s Ingress éƒ½ä¸æ–¹ä¾¿æ”¹çš„æƒ…å†µä¸‹ï¼Œåªèƒ½ä¿®æ”¹ Ingress çš„æ¨¡ç‰ˆäº†ï¼Œä¿®æ”¹æ¨¡ç‰ˆ<code>/etc/nginx/template</code> åï¼Œé‡æ–°æ‰“é•œåƒä½¿ç”¨ã€‚</p><p>æˆ‘æ˜¯ Clayï¼Œä¸‹æœŸè§ ğŸ‘‹</p><hr><blockquote><ul><li><p>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·ã€ŒSREè¿ç»´è¿›é˜¶ä¹‹è·¯ã€æˆ–å…³æ³¨æˆ‘çš„ Github https://github.com/clay-wangzhi/SreGuide æŸ¥çœ‹æœ€æ–°æ–‡ç« </p></li><li><p>æ¬¢è¿åŠ æˆ‘å¾®ä¿¡<code>sre-k8s-ai</code>ï¼Œä¸æˆ‘è®¨è®ºäº‘åŸç”Ÿã€ç¨³å®šæ€§ç›¸å…³å†…å®¹</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin-20240615194414355.png" alt="weixin" style="zoom:50%;">`,41),p=[r];function i(o,c){return s(),e("div",null,p)}const u=a(t,[["render",i],["__file","ingress-forward.html.vue"]]);export{u as default};
