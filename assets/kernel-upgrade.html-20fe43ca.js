import{_ as r}from"./plugin-vue_export-helper-c27b6911.js";import{r as l,o as i,c as t,a as e,b as n,d as a,e as o}from"./app-a3d23ff5.js";const c={},d=e("h1",{id:"内核版本升级",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#内核版本升级","aria-hidden":"true"},"#"),n(" 内核版本升级")],-1),p=e("h2",{id:"背景",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#背景","aria-hidden":"true"},"#"),n(" 背景")],-1),u=e("p",null,"k8s 目前使用的内核 版本为：4.9.220，存在以下bug：",-1),m={href:"https://mp.weixin.qq.com/s/AJJal8tbcUSbW_IYVA-sEw",target:"_blank",rel:"noopener noreferrer"},b=e("li",null,"https://github.com/fho/docker-samba-loop",-1),h={href:"https://github.com/moby/moby/issues/5618",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/coreos/bugs/issues/254",target:"_blank",rel:"noopener noreferrer"},g={href:"https://www.coolops.cn/archives/calico-xia-ru-he-qie-huan-shu-ju-mian-dao-ebpf",target:"_blank",rel:"noopener noreferrer"},_=o(`<p>现升级版本为：kernel-lt 5.4.196</p><h2 id="具体操作步骤" tabindex="-1"><a class="header-anchor" href="#具体操作步骤" aria-hidden="true">#</a> 具体操作步骤</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://mirrors.nju.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-5.4.196-1.el7.elrepo.x86_64.rpm
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> kernel-lt-5.4.196-1.el7.elrepo.x86_64.rpm
<span class="token comment"># 校验文件是否生成</span>
<span class="token function">ls</span> /boot/initramfs-5.4.196-1.el7.elrepo.x86_64.img
<span class="token function">awk</span> -F<span class="token punctuation">\\</span>&#39; <span class="token string">&#39;$1==&quot;menuentry &quot; {print $2}&#39;</span> /etc/grub2.cfg
grub2-set-default <span class="token string">&#39;CentOS Linux (5.4.196-1.el7.elrepo.x86_64) 7 (Core)&#39;</span>
grub2-editenv list
grub2-mkconfig <span class="token parameter variable">-o</span> /boot/grub2/grub.cfg
<span class="token function">shutdown</span> <span class="token parameter variable">-r</span> now
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>⚠️ 重新生成的 grub.cfg 文件，要看一下，是否是 /boot/efi/EFI/centos/grub.cfg</p></blockquote><h2 id="node节点平滑维护" tabindex="-1"><a class="header-anchor" href="#node节点平滑维护" aria-hidden="true">#</a> Node节点平滑维护</h2><p>通常情况下，如果要对K8S集群中的一台Node节点进行平滑维护，如升级或调整配置。正确的操作：</p><ul><li>cordon临时从K8S集群隔离出来，标识为SchedulingDisabled不可调度状态。</li><li>drain排干该节点上的pod资源到其他node节点上。</li><li>对该节点展开平滑维护操作，如升级或调整配置。</li><li>uncordon恢复，重新回到K8S集群，变回可调度状态。</li></ul><p>同时注意：为了确保drain驱逐pod的时候，容器应用服务不中断，必须满足：</p><ul><li>要驱逐的pod副本数量必须大于1</li><li>要配置&quot;反亲和策略&quot;，确保被驱逐的pod被调度到不同的Node节点上</li><li>deployment采用滚动更新，设置maxUnavailable为0，maxSurge为1</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 禁止调度</span>
kubectl cordon node-xxx
<span class="token comment"># 驱逐 pod</span>
kubectl drain node-xxx --ignore-daemonsets
<span class="token comment"># 升级完成后,恢复调度</span>
kubectl uncordon node-xxx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>升级问到的问题</p><p>1）pstore: unknown compression: deflate</p>`,12),k={href:"https://so.csdn.net/so/search?q=vim&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},f=o(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">GRUB_CMDLINE_LINUX</span><span class="token operator">=</span><span class="token string">&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet mgag200.modeset=0&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后重新生成grub</p><p>grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg 2）rpm -ivh 安装某个包时，文件不全</p><p>如果安装过程中，安装被中断，要卸载重装，不然安装的一些文件很可能少安装（initramfs）</p>`,4);function x(q,w){const s=l("ExternalLinkIcon");return i(),t("div",null,[d,p,u,e("ul",null,[e("li",null,[e("a",m,[n("CPU 限流"),a(s)])]),b,e("li",null,[e("a",h,[n("moby/moby#5618"),a(s)])]),e("li",null,[e("a",v,[n("coreos/bugs#254"),a(s)])]),e("li",null,[e("a",g,[n("无法支持 calico eBPF"),a(s)])])]),_,e("p",null,[e("a",k,[n("vim"),a(s)]),n(" /etc/default/grub 在 GRUB_CMDLINE_LINUX 最后添加 mgag200.modeset=0")]),f])}const S=r(c,[["render",x],["__file","kernel-upgrade.html.vue"]]);export{S as default};
