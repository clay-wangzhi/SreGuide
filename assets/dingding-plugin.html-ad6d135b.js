import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as i,c,a as n,b as s,d as t,e as p}from"./app-4d4f7d7e.js";const l={},u=p('<h1 id="_4-5-共享库之钉钉消息推送" tabindex="-1"><a class="header-anchor" href="#_4-5-共享库之钉钉消息推送" aria-hidden="true">#</a> 4.5 共享库之钉钉消息推送</h1><p>起因：执行完流水线后进行一定程度的消息推送，所以选择钉钉进行<code>jenkins</code>构建结构的消息推送</p><h2 id="下载配置相关依赖插件" tabindex="-1"><a class="header-anchor" href="#下载配置相关依赖插件" aria-hidden="true">#</a> 下载配置相关依赖插件</h2><p>相关环境：</p><ul><li><code>Jenkins</code> 2.277.3，安装文档见上篇</li><li><code>DingTalk</code> 插件 2.4.3</li><li><code>build user vars plugin</code> 插件 1.7</li></ul>',5),r={href:"https://plugins.jenkins.io/dingding-notifications",target:"_blank",rel:"noopener noreferrer"},d=n("blockquote",null,[n("p",null,"⚠️ 请确保你的 Jenkins 版本 >= 2.176.4")],-1),k={href:"https://jenkinsci.github.io/dingtalk-plugin/",target:"_blank",rel:"noopener noreferrer"},v=n("p",null,"找到 Jenkins 首页 >> 系统管理 >> 钉钉，我的配置如下图",-1),g=n("p",null,[n("img",{src:"https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20210426164341273.png",alt:"image-20210426164341273"})],-1),m=n("blockquote",null,[n("p",null,"⚠️ ​注意手动输入机器人的id，不要自动生成，否则重启后，robot的id将发生变化")],-1),b={href:"https://plugins.jenkins.io/build-user-vars-plugin",target:"_blank",rel:"noopener noreferrer"},h=p(`<p>在流水线中，使用wrap，获取BUILD_USER变量</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&#39;BuildUser&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,2),x=p(`<h2 id="创建配置共享库" tabindex="-1"><a class="header-anchor" href="#创建配置共享库" aria-hidden="true">#</a> 创建配置共享库</h2><h3 id="编写groovy脚本" tabindex="-1"><a class="header-anchor" href="#编写groovy脚本" aria-hidden="true">#</a> 编写Groovy脚本</h3><p>项目目录结构如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ tree jenkinslibrary
jenkinslibrary
├── README.md
└── src
    └── org
        └── devops
            └── dingmes.groovy

<span class="token number">3</span> directories, <span class="token number">2</span> files
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>dingme.groovy</code>文件内容如下</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code><span class="token keyword">package</span> org<span class="token punctuation">.</span>devops

<span class="token keyword">def</span> <span class="token function">GetChangeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MAX_MSG_LEN <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">def</span> changeString <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;&quot;</span></span>
    <span class="token keyword">def</span> changeLogSets <span class="token operator">=</span> currentBuild<span class="token punctuation">.</span>changeSets
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> changeLogSets<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">def</span> entries <span class="token operator">=</span> changeLogSets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>items
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">def</span> entry <span class="token operator">=</span> entries<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            truncated_msg <span class="token operator">=</span> entry<span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>MAX_MSG_LEN<span class="token punctuation">)</span>
            commitTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><span class="token punctuation">)</span>
            changeString <span class="token operator">+=</span> <span class="token interpolation-string"><span class="token string">&quot;&gt; - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">truncated_msg</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">entry<span class="token punctuation">.</span>author</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">commitTime</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]\\n&quot;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>changeString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        changeString <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;&gt; - No new changes&quot;</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> changeString
<span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">DingdingReq</span><span class="token punctuation">(</span>RobotID<span class="token punctuation">,</span> Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&#39;BuildUser&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">def</span> changeString <span class="token operator">=</span> <span class="token function">GetChangeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dingtalk <span class="token punctuation">(</span>
            robot<span class="token punctuation">:</span> RobotID<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">&#39;MARKDOWN&#39;</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">&#39;你有新的消息，请注意查收&#39;</span><span class="token punctuation">,</span>
            text<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token interpolation-string"><span class="token string">&quot;### 构建信息&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;&gt; - 应用名称：**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>JOB_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;&gt; - 构建结果：**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">Status</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;&gt; - 当前版本：**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>BUILD_NUMBER</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;&gt; - 构建发起：**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>BUILD_USER</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;&gt; - 持续时间：**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">currentBuild<span class="token punctuation">.</span>durationString</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;&gt; - 构建日志：[点击查看详情](</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>BUILD_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">console)&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;### 更新记录:&quot;</span></span><span class="token punctuation">,</span>
                <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">changeString</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            at<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">&#39;xxxxxxxxxxx&#39;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>文本中<code>xxxxxxxxxxx</code>请根据实际情况更换为钉钉群组里面，具体人的手机号，可以添加多个</p></blockquote><h3 id="在-jenkins-中配置将共享库" tabindex="-1"><a class="header-anchor" href="#在-jenkins-中配置将共享库" aria-hidden="true">#</a> 在 Jenkins 中配置将共享库</h3><p>找到 Jenkins 首页 &gt;&gt; 系统管理 &gt;&gt; Global Pipeline Libraries，我的配置如下图</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20210426171913350.png" alt="image-20210426171913350"></p><h3 id="在流水线中导入共享库" tabindex="-1"><a class="header-anchor" href="#在流水线中导入共享库" aria-hidden="true">#</a> 在流水线中导入共享库</h3><p>导入方法<code>@Library(&#39;pipeline-library-demo&#39;)_</code>，这样就可以使用共享库中的代码了</p><p>具体的 pipeline 脚本如下：</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code><span class="token shebang comment">#!groovy</span>

<span class="token annotation punctuation">@Library</span><span class="token punctuation">(</span><span class="token string">&#39;pipeline-library-demo&#39;</span><span class="token punctuation">)</span><span class="token number">_</span>

<span class="token comment">//func from shareibrary</span>
<span class="token keyword">def</span> dingmes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">org<span class="token punctuation">.</span>devops<span class="token punctuation">.</span>dingmes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//env</span>
String branchName <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;master&quot;</span></span>
String gitlabCredentialsId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;xxx&quot;</span></span>
String gitUrl <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;http://xxx/xxx/jenkinslibrary.git&quot;</span></span>
String robotId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;2e0e11c4-2211-4687-b317-cacf58197288&quot;</span></span>

pipeline <span class="token punctuation">{</span>
    agent any
    
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Git Clone&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                git branch<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">branchName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
                credentialsId<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">gitlabCredentialsId</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
                url<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">gitUrl</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    post <span class="token punctuation">{</span>
        success <span class="token punctuation">{</span>
            script <span class="token punctuation">{</span>
                dingmes<span class="token punctuation">.</span><span class="token function">DingdingReq</span><span class="token punctuation">(</span>robotId<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">&quot;构建成功 ✅&quot;</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        failure <span class="token punctuation">{</span>
            script <span class="token punctuation">{</span>
                dingmes<span class="token punctuation">.</span><span class="token function">DingdingReq</span><span class="token punctuation">(</span>robotId<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">&quot;构建失败 ❌&quot;</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此完成，构建效果如下图：</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20210426172713667.png" alt="image-20210426172713667"></p><h2 id="遇到的问题" tabindex="-1"><a class="header-anchor" href="#遇到的问题" aria-hidden="true">#</a> 遇到的问题</h2><ol><li><p><code>currentBuild.durationString</code>的值传递不进去，一开始先用<code>withEnv</code>包裹一下</p><p>后来找到原因 Groovy 在单引号的字符串里面是不支持插值的，所以要用双引号</p><p>单引号中的<code>env.JOB_NAME</code>会引用失败，双引号则引用成功</p><p>单、双引号引用<code>JOB_NAME</code>都引用成功</p><blockquote><p>推荐所有变量都用&quot;&quot;双引号</p><p>三引号也是一样，&#39;&#39;&#39; 三单引号不支持插值，&quot;&quot;&quot;三双引号支持插值</p></blockquote></li></ol><p>参考链接：https://www.ssgeek.com/post/jenkinssharelibrary-shi-jian-zhi-zi-ding-yi-tong-zhi-qi/</p>`,19);function y(q,_){const a=o("ExternalLinkIcon");return i(),c("div",null,[u,n("ol",null,[n("li",null,[n("p",null,[s("在Jenkins中安装钉钉插件"),n("a",r,[s("DingTalk"),t(a)])]),d]),n("li",null,[n("p",null,[s("钉钉机器人配置，"),n("a",k,[s("说明文档"),t(a)])]),v,g,m]),n("li",null,[n("p",null,[s("安装"),n("a",b,[s("build user vars plugin"),t(a)]),s("插件，插件可能有相关版本依赖，需要重启一下 Jenkins 才能继续安装")]),h])]),x])}const S=e(l,[["render",y],["__file","dingding-plugin.html.vue"]]);export{S as default};
