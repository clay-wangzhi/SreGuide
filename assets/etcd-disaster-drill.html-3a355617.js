import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{o as e,c as s,e as n}from"./app-4e885309.js";const t={},p=n(`<h1 id="etcd-é«˜å¯ç”¨æ•…éšœæ¼”ç»ƒ" tabindex="-1"><a class="header-anchor" href="#etcd-é«˜å¯ç”¨æ•…éšœæ¼”ç»ƒ" aria-hidden="true">#</a> Etcd é«˜å¯ç”¨æ•…éšœæ¼”ç»ƒ</h1><h2 id="ç›®çš„" tabindex="-1"><a class="header-anchor" href="#ç›®çš„" aria-hidden="true">#</a> ç›®çš„</h2><p>æœ¬æ¬¡æ¼”ç»ƒæ—¨åœ¨æµ‹è¯• Kubernetes çš„ etcd é«˜å¯ç”¨æ€§ï¼Œæ£€éªŒæ˜¯å¦èƒ½å¤Ÿåœ¨å…¶ä¸­ä¸€ä¸ª etcd èŠ‚ç‚¹å‘ç”Ÿæ•…éšœçš„æƒ…å†µä¸‹ï¼Œå…¶ä»– etcd èŠ‚ç‚¹èƒ½å¤Ÿæ¥ç®¡å…¶å·¥ä½œï¼Œç¡®ä¿é›†ç¾¤ä»èƒ½æ­£å¸¸è¿è¡Œã€‚</p><p>é›†ç¾¤æ¶æ„</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/kube-etcd.png" alt=""></p><h2 id="æ¼”ç»ƒåœºæ™¯" tabindex="-1"><a class="header-anchor" href="#æ¼”ç»ƒåœºæ™¯" aria-hidden="true">#</a> æ¼”ç»ƒåœºæ™¯</h2><p>åœ¨ä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å°†æ¨¡æ‹Ÿå…¶ä¸­ä¸€ä¸ª etcd èŠ‚ç‚¹çš„æ•…éšœï¼Œè§‚å¯Ÿå‰©ä½™çš„ etcd èŠ‚ç‚¹æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚</p><h2 id="æ¼”ç»ƒè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#æ¼”ç»ƒè¿‡ç¨‹" aria-hidden="true">#</a> æ¼”ç»ƒè¿‡ç¨‹</h2><ol><li><p>ç¡®è®¤é›†ç¾¤å½“å‰å¥åº·çŠ¶æ€</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl get componentstatuses <span class="token comment"># ç¡®è®¤æ‰€æœ‰ç»„ä»¶çŠ¶æ€å‡ä¸ºæ­£å¸¸</span>
kubectl <span class="token parameter variable">-n</span> kube-system get endpoints <span class="token operator">|</span> <span class="token function">grep</span> etcd <span class="token comment"># ç¡®è®¤ etcd Endpoints åˆ—è¡¨</span>
kubectl <span class="token parameter variable">-n</span> kube-system get pods <span class="token operator">|</span> <span class="token function">grep</span> etcd <span class="token comment"># ç¡®è®¤ etcd Pod çš„æ•°é‡</span>
<span class="token comment"># ç¡®è®¤etcd é›†ç¾¤çŠ¶æ€</span>
<span class="token assign-left variable">ETCD_CA_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span>
<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.crt&quot;</span>
<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.key&quot;</span>
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /usr/local/bin/etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span>https://127.0.0.1:2379 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> member list
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /usr/local/bin/etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST1}</span>,<span class="token variable">\${HOST2}</span>,<span class="token variable">\${HOST3}</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> endpoint health
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>åœæ­¢ M3 èŠ‚ç‚¹ etcd æœåŠ¡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/clay/etcdbak
<span class="token function">mv</span> /etc/kubernetes/manifests/etcd.yaml /home/clay/etcdbak/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ç¡®è®¤å‰©ä½™èŠ‚ç‚¹æ˜¯å¦èƒ½æ­£å¸¸æä¾›æœåŠ¡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># é‡å¤æ‰§è¡Œæ­¥éª¤ä¸€å‘½ä»¤</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨å…¶ä»– etcd èŠ‚ç‚¹ä¸Šæ‰§è¡Œ kubectl create å‘½ä»¤æµ‹è¯• Kubernetes é›†ç¾¤æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œä¾‹å¦‚ kubectl create deployment nginx</p><p>æŒç»­é€šè¿‡ vip + åŸŸåä¸¤ç§æ–¹å¼ï¼Œè°ƒç”¨ apiserver æœåŠ¡ï¼Œç»Ÿè®¡å½±å“æ—¶é•¿</p></li><li><p>å¯åŠ¨ M3 èŠ‚ç‚¹ etcd æœåŠ¡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mv</span> /home/clay/etcdbak/etcd.yaml /etc/kubernetes/manifests/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>ç¡®è®¤é›†ç¾¤å½“å‰å¥åº·çŠ¶æ€</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># é‡å¤æ‰§è¡Œæ­¥éª¤ä¸€å‘½ä»¤</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol><blockquote><p>ğŸ¶ å› ä¸ºç°æœ‰æ¶æ„ä¸º apiserver è°ƒç”¨æœ¬åœ° 127.0.0.1 çš„ etcd æœåŠ¡ï¼Œæ‰€ä»¥å½“ M3 èŠ‚ç‚¹ etcd æœåŠ¡åœæ­¢åï¼Œ M3 èŠ‚ç‚¹çš„ apiserver ä¹Ÿä¸èƒ½æ­£å¸¸æä¾›æœåŠ¡</p><p>æ‰€ä»¥ haproxy å’Œ nginx éƒ½å¿…è¦é…ç½®æ­£ç¡®çš„å¥åº·æ£€æŸ¥ç­–ç•¥ï¼Œå¯ä»¥è‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹</p></blockquote><h2 id="æ¼”ç»ƒç»“æœ" tabindex="-1"><a class="header-anchor" href="#æ¼”ç»ƒç»“æœ" aria-hidden="true">#</a> æ¼”ç»ƒç»“æœ</h2><p>åœ¨åœæ­¢ä¸€ä¸ª etcd èŠ‚ç‚¹çš„ etcd è¿›ç¨‹åï¼Œå…¶ä»– etcd èŠ‚ç‚¹èƒ½å¤Ÿé¡ºåˆ©æ¥ç®¡å…¶å·¥ä½œï¼Œç¡®ä¿ Kubernetes é›†ç¾¤çš„æ­£å¸¸è¿è¡Œã€‚å½“ç¬¬ä¸€ä¸ª etcd èŠ‚ç‚¹é‡æ–°åŠ å…¥é›†ç¾¤åï¼Œæ‰€æœ‰ etcd èŠ‚ç‚¹å‡èƒ½å¤Ÿæ¢å¤åˆ°å¥åº·çŠ¶æ€ï¼Œé›†ç¾¤ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚æ¼”ç»ƒç»“æœè¯æ˜ Kubernetes çš„ etcd å­ç³»ç»Ÿå…·æœ‰è¾ƒé«˜çš„å¯ç”¨æ€§ï¼Œå¯ä»¥æœ‰æ•ˆåœ°åº”å¯¹èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>é€šè¿‡æœ¬æ¬¡æ¼”ç»ƒï¼Œæˆ‘ä»¬éªŒè¯äº† Kubernetes çš„ etcd å­ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œå¹¶äº†è§£äº†åœ¨ä¸€ä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœçš„æƒ…å†µä¸‹ï¼Œå…¶ä»–èŠ‚ç‚¹æ˜¯å¦‚ä½•æ¥ç®¡å…¶å·¥ä½œçš„ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å»ºè®®å¯¹ Kubernetes é›†ç¾¤çš„ etcd å­ç³»ç»Ÿè¿›è¡Œé«˜å¯ç”¨æ€§æµ‹è¯•ï¼Œä»¥ç¡®ä¿é›†ç¾¤èƒ½å¤Ÿç¨³å®šã€å¯é åœ°è¿è¡Œã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜åº”å®šæœŸæ£€æŸ¥ Kubernetes é›†ç¾¤çš„å„ä¸ªç»„ä»¶çŠ¶æ€ï¼Œç¡®ä¿å…¶æ­£å¸¸è¿è¡Œï¼Œé¿å…å‡ºç°æ•…éšœå¯¼è‡´çš„æœåŠ¡ä¸­æ–­ã€‚</p>`,14),c=[p];function r(l,i){return e(),s("div",null,c)}const u=a(t,[["render",r],["__file","etcd-disaster-drill.html.vue"]]);export{u as default};
