import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as l,o as r,c as i,a as n,b as e,d as a,e as t}from"./app-7c13e092.js";const c={},p=t('<h1 id="coredns-æ¦‚è¿°åŠè¿ç»´å®è·µ" tabindex="-1"><a class="header-anchor" href="#coredns-æ¦‚è¿°åŠè¿ç»´å®è·µ" aria-hidden="true">#</a> CoreDNS æ¦‚è¿°åŠè¿ç»´å®è·µ</h1><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/coredns-1.png" alt=""></p><h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h2><h3 id="ä»€ä¹ˆæ˜¯-dns" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-dns" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯ DNS ?</h3><p><strong>åŸŸåç³»ç»Ÿ</strong>ï¼ˆè‹±è¯­ï¼š<strong>D</strong>omain <strong>N</strong>ame <strong>S</strong>ystemï¼Œç¼©å†™ï¼š<strong>DNS</strong>ï¼‰æ˜¯äº’è”ç½‘çš„ä¸€é¡¹æœåŠ¡ã€‚å®ƒä½œä¸ºå°†<strong>åŸŸå</strong>å’Œ<strong>IPåœ°å€</strong>ç›¸äº’æ˜ å°„çš„ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œèƒ½å¤Ÿä½¿äººæ›´æ–¹ä¾¿åœ°è®¿é—®äº’è”ç½‘ã€‚DNSä½¿ç”¨TCPå’ŒUDPç«¯å£53ã€‚</p><p>DNS ä¸ä»…æ–¹ä¾¿äº†äººä»¬è®¿é—®ä¸åŒçš„äº’è”ç½‘æœåŠ¡ï¼Œæ›´ä¸ºå¾ˆå¤šåº”ç”¨æä¾›äº†ï¼ŒåŠ¨æ€æœåŠ¡å‘ç°å’Œå…¨å±€è´Ÿè½½å‡è¡¡ï¼ˆGlobal Server Load Balanceï¼ŒGSLBï¼‰çš„æœºåˆ¶ã€‚è¿™æ ·ï¼ŒDNS å°±å¯ä»¥é€‰æ‹©ç¦»ç”¨æˆ·æœ€è¿‘çš„ IP æ¥æä¾›æœåŠ¡ã€‚å³ä½¿åç«¯æœåŠ¡çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œç”¨æˆ·ä¾ç„¶å¯ä»¥ç”¨ç›¸åŒåŸŸåæ¥è®¿é—®ã€‚</p><p>DNS åè®®åœ¨ TCP/IP æ ˆä¸­å±äº<strong>åº”ç”¨å±‚</strong>ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„ å®¢æˆ·ç«¯ - æœåŠ¡å™¨åº”ç”¨ï¼Œå®¢æˆ·ç«¯å‘èµ·åŸŸåæŸ¥è¯¢è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å¯¹è¯·æ±‚è¿›è¡Œåº”ç­”ã€‚</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240428172825007.png" alt=""></p><h3 id="coredns-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#coredns-ä»‹ç»" aria-hidden="true">#</a> CoreDNS ä»‹ç»</h3>',9),d={href:"https://cncf.io/",target:"_blank",rel:"noopener noreferrer"},u=t('<p>DNS æœåŠ¡å™¨æ”¯æŒæ­£å‘æŸ¥æ‰¾ï¼ˆA å’Œ AAAA è®°å½•ï¼‰ã€ç«¯å£å‘ç°ï¼ˆSRV è®°å½•ï¼‰ã€åå‘ IP åœ°å€å‘ç°ï¼ˆPTR è®°å½•ï¼‰ç­‰ã€‚</p><p>å¦‚æœ Pod çš„ <code>dnsPolicy</code> è®¾ç½®ä¸º <code>default</code>ï¼Œåˆ™å®ƒå°†ä» Pod è¿è¡Œæ‰€åœ¨èŠ‚ç‚¹ç»§æ‰¿åç§°è§£æé…ç½®ã€‚ Pod çš„ DNS è§£æè¡Œä¸ºåº”è¯¥ä¸èŠ‚ç‚¹ç›¸åŒã€‚</p><p>å¦‚æœä½ ä¸æƒ³è¿™æ ·åšï¼Œæˆ–è€…æƒ³è¦ä¸º Pod ä½¿ç”¨å…¶ä»– DNS é…ç½®ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ kubelet çš„ <code>--resolv-conf</code> æ ‡å¿—ã€‚</p><h3 id="pod-çš„-dns-ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#pod-çš„-dns-ç­–ç•¥" aria-hidden="true">#</a> Pod çš„ DNS ç­–ç•¥</h3><ul><li><strong>ClusterFirst</strong>ï¼šè¿™æ˜¯é»˜è®¤çš„DNSç­–ç•¥ï¼Œæ„å‘³ç€å½“Podéœ€è¦è¿›è¡ŒåŸŸåè§£ææ—¶ï¼Œé¦–å…ˆä¼šæŸ¥è¯¢é›†ç¾¤å†…éƒ¨çš„CoreDNSæœåŠ¡ã€‚é€šè¿‡CoreDNSæ¥åšåŸŸåè§£æï¼Œè¡¨ç¤ºPodçš„/etc/resolv.confæ–‡ä»¶è¢«è‡ªåŠ¨é…ç½®æŒ‡å‘kube-dnsæœåŠ¡åœ°å€ã€‚</li><li><strong>None</strong>ï¼šä½¿ç”¨è¯¥ç­–ç•¥ï¼ŒKubernetesä¼šå¿½ç•¥é›†ç¾¤çš„DNSç­–ç•¥ã€‚éœ€è¦æ‚¨æä¾›<strong>dnsConfig</strong>å­—æ®µæ¥æŒ‡å®šDNSé…ç½®ä¿¡æ¯ï¼Œå¦åˆ™Podå¯èƒ½æ— æ³•æ­£ç¡®è§£æä»»ä½•åŸŸåã€‚</li><li><strong>Default</strong>ï¼šPodç›´æ¥ç»§æ‰¿é›†ç¾¤èŠ‚ç‚¹çš„åŸŸåè§£æé…ç½®ã€‚</li><li><strong>ClusterFirstWithHostNet</strong>ï¼šå¼ºåˆ¶åœ¨hostNetworkç½‘ç»œæ¨¡å¼ä¸‹ä½¿ç”¨ClusterFirstç­–ç•¥ï¼ˆé»˜è®¤ä½¿ç”¨Defaultç­–ç•¥ï¼‰ã€‚</li></ul><h3 id="kubernetesé›†ç¾¤ä¸­dnsåŸŸåè§£æåŸç†-clusterfirst-ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#kubernetesé›†ç¾¤ä¸­dnsåŸŸåè§£æåŸç†-clusterfirst-ç­–ç•¥" aria-hidden="true">#</a> Kubernetesé›†ç¾¤ä¸­DNSåŸŸåè§£æåŸç†ï¼ˆClusterFirst ç­–ç•¥ï¼‰</h3><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/CAEQQRiBgICHx5qL9RgiIDIwYjgyM2QwNWIzMzRiNmZiYmUwM2VmZjE2NDAwNDQy3963382_20230830144006.372.svg" alt=""></p><p>1ï¼‰ä¸šåŠ¡Podï¼ˆPod Clientï¼‰è¯•å›¾è®¿é—®NginxæœåŠ¡ï¼ˆService Nginxï¼‰æ—¶ï¼Œå…ˆä¼šè¯·æ±‚æœ¬åœ°DNSé…ç½®æ–‡ä»¶ï¼ˆ/etc/resolv.confï¼‰ä¸­æŒ‡å‘çš„DNSæœåŠ¡å™¨ï¼ˆnameserver 172.21.0.10ï¼Œå³Service kube-dnsï¼‰è·å–æœåŠ¡IPåœ°å€ï¼Œå¾—åˆ°è§£æç»“æœä¸º172.21.0.30çš„IPåœ°å€ã€‚</p><p>2ï¼‰ä¸šåŠ¡Podï¼ˆPod Clientï¼‰å†ç›´æ¥å‘èµ·å¾€è¯¥IPåœ°å€çš„è¯·æ±‚ï¼Œè¯·æ±‚æœ€ç»ˆç»è¿‡NginxæœåŠ¡ï¼ˆService Nginxï¼‰è½¬å‘åˆ°è¾¾åç«¯çš„Nginxå®¹å™¨ï¼ˆPod Nginx-1å’ŒPod Nginx-2ï¼‰ä¸Šã€‚</p><h2 id="è¿ç»´å®è·µ" tabindex="-1"><a class="header-anchor" href="#è¿ç»´å®è·µ" aria-hidden="true">#</a> è¿ç»´å®è·µ</h2><h3 id="coredns-configmap-é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#coredns-configmap-é€‰é¡¹" aria-hidden="true">#</a> CoreDNS ConfigMap é€‰é¡¹</h3>',11),k={href:"https://coredns.io/2017/07/23/corefile-explained/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/",target:"_blank",rel:"noopener noreferrer"},m=t(`<p>åœ¨ Kubernetes ä¸­ï¼ŒCoreDNS å®‰è£…æ—¶ä½¿ç”¨å¦‚ä¸‹é»˜è®¤ Corefile é…ç½®ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),h={href:"https://coredns.io/plugins/",target:"_blank",rel:"noopener noreferrer"},b={href:"https://coredns.io/plugins/errors/",target:"_blank",rel:"noopener noreferrer"},g={href:"https://coredns.io/plugins/health/",target:"_blank",rel:"noopener noreferrer"},f=n("code",null,"http://localhost:8080/health",-1),_=n("code",null,"lameduck",-1),N={href:"https://coredns.io/plugins/ready/",target:"_blank",rel:"noopener noreferrer"},y={href:"https://coredns.io/plugins/kubernetes/",target:"_blank",rel:"noopener noreferrer"},S={href:"https://coredns.io/plugins/kubernetes/",target:"_blank",rel:"noopener noreferrer"},D=t("<ul><li><p>ä½ å¯ä»¥ä½¿ç”¨ <code>ttl</code> æ¥å®šåˆ¶å“åº”çš„ TTLã€‚é»˜è®¤å€¼æ˜¯ 5 ç§’é’Ÿã€‚TTL çš„æœ€å°å€¼å¯ä»¥æ˜¯ 0 ç§’é’Ÿï¼Œ æœ€å¤§å€¼ä¸º 3600 ç§’ã€‚å°† TTL è®¾ç½®ä¸º 0 å¯ä»¥ç¦æ­¢å¯¹ DNS è®°å½•è¿›è¡Œç¼“å­˜ã€‚</p></li><li><p><code>pods insecure</code> é€‰é¡¹æ˜¯ä¸ºäº†ä¸ kube-dns å‘åå…¼å®¹ã€‚</p></li><li><p>ä½ å¯ä»¥ä½¿ç”¨ <code>pods verified</code> é€‰é¡¹ï¼Œè¯¥é€‰é¡¹ä½¿å¾—ä»…åœ¨ç›¸åŒåå­—ç©ºé—´ä¸­å­˜åœ¨å…·æœ‰åŒ¹é… IP çš„ Pod æ—¶æ‰è¿”å› A è®°å½•ã€‚</p></li><li><p>å¦‚æœä½ ä¸ä½¿ç”¨ Pod è®°å½•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>pods disabled</code> é€‰é¡¹ã€‚</p></li></ul>",1),C={href:"https://coredns.io/plugins/prometheus/",target:"_blank",rel:"noopener noreferrer"},P={href:"https://prometheus.io/",target:"_blank",rel:"noopener noreferrer"},x=n("code",null,"http://localhost:9153/metrics",-1),I={href:"https://coredns.io/plugins/forward/",target:"_blank",rel:"noopener noreferrer"},q={href:"https://coredns.io/plugins/cache/",target:"_blank",rel:"noopener noreferrer"},A={href:"https://coredns.io/plugins/loop/",target:"_blank",rel:"noopener noreferrer"},L={href:"https://coredns.io/plugins/reload",target:"_blank",rel:"noopener noreferrer"},w={href:"https://coredns.io/plugins/loadbalance",target:"_blank",rel:"noopener noreferrer"},E=t(`<p>ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹ ConfigMap æ¥æ›´æ”¹é»˜è®¤çš„ CoreDNS è¡Œä¸ºã€‚</p><blockquote><p>å¯é€‰æ’ä»¶ï¼š</p><p>logï¼šè®°å½•è§£ææ—¥å¿—</p></blockquote><h3 id="coredns-æœåŠ¡ç«¯ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#coredns-æœåŠ¡ç«¯ä¼˜åŒ–" aria-hidden="true">#</a> CoreDNS æœåŠ¡ç«¯ä¼˜åŒ–</h3><p><strong>é…ç½® Pod æ‰“æ•£</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>app
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>dns
            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åˆç†è®¾ç½®å‰¯æœ¬æ•°</strong></p><p>1ï¼‰80èŠ‚ç‚¹ä»¥ä¸‹</p><p>å‰¯æœ¬æ•° = min ( max ( ceil (QPS/10000), ceil (é›†ç¾¤èŠ‚ç‚¹æ•°/8) ), 10 )</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æ‰‹åŠ¨è°ƒæ•´ CoreDNS å‰¯æœ¬æ•°</span>
kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token punctuation">{</span>target<span class="token punctuation">}</span> deployment/coredns <span class="token parameter variable">-n</span> kube-system <span class="token comment">#{target} ç›®æ ‡å‰¯æœ¬æ•°é‡</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ç¤ºä¾‹ï¼š</p><p>é›†ç¾¤èŠ‚ç‚¹æ•°ä¸º10ï¼ŒDNS æœåŠ¡è¯·æ±‚ QPS ä¸º22000ï¼Œåˆ™å‰¯æœ¬æ•°ä¸º3ã€‚</p><p>é›†ç¾¤èŠ‚ç‚¹æ•°ä¸º30ï¼ŒDNS æœåŠ¡è¯·æ±‚ QPS ä¸º15000ï¼Œåˆ™å‰¯æœ¬æ•°ä¸º4ã€‚</p></blockquote><p>2ï¼‰80èŠ‚ç‚¹ä»¥ä¸Šï¼Œå®‰è£… NodeLocal DNSCache</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ä¸‹è½½ YAML æ–‡ä»¶</span>
<span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml
<span class="token comment"># ä¿®æ”¹å˜é‡</span>
<span class="token assign-left variable">kubedns</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span>kubectl get svc kube-dns <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.spec.clusterIP<span class="token punctuation">}</span><span class="token variable">\`</span></span>
<span class="token assign-left variable">domain</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span><span class="token function">grep</span> clusterDomain <span class="token string">&#39;/var/lib/kubelet/config.yaml&#39;</span> <span class="token operator">|</span> <span class="token function">awk</span>  <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">\`</span></span>
<span class="token assign-left variable">localdns</span><span class="token operator">=</span><span class="token string">&quot;169.254.20.10&quot;</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s/__PILLAR__LOCAL__DNS__/<span class="token variable">$localdns</span>/g; s/__PILLAR__DNS__DOMAIN__/<span class="token variable">$domain</span>/g; s/,__PILLAR__DNS__SERVER__//g; s/__PILLAR__CLUSTER__DNS__/<span class="token variable">$kubedns</span>/g&quot;</span> nodelocaldns.yaml
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s#registry.k8s.io/dns/k8s-dns-node-cache:1.22.28#registry.cn-hangzhou.aliyuncs.com/clay-wangzhi/registry.k8s.io.dns.k8s-dns-node-cache:1.22.28#g&#39;</span> nodelocaldns.yaml
<span class="token comment"># å®‰è£…</span>
kubectl create <span class="token parameter variable">-f</span> nodelocaldns.yaml
<span class="token comment"># ä¿®æ”¹ kubelet é‡å¯</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;sed -i &quot;</span>s/<span class="token variable">$kubedns</span>/<span class="token variable">$localdns</span>/g<span class="token string">&quot; /var/lib/kubelet/config.yaml&quot;</span>
<span class="token comment"># åœ¨æ¯å° Node èŠ‚ç‚¹ï¼Œä½¿ç”¨ä¸Šé¢å‘½ä»¤çš„è¾“å‡ºç»“æœæ›¿æ¢ dns ip , ç„¶åé‡å¯</span>
systemctl restart kubelet.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®¢æˆ·ç«¯ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯ä¼˜åŒ–" aria-hidden="true">#</a> å®¢æˆ·ç«¯ä¼˜åŒ–</h3><p>åœ¨å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥åšé€‚å½“çš„ä¼˜åŒ–é…ç½®ï¼Œæ¥æå‡ DNS çš„ä½¿ç”¨ä½“éªŒã€‚</p><ol><li><p><strong>ä¿®æ”¹ ndots å€¼</strong></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes é›†ç¾¤ä¸­çš„åŸŸåè§£æå¾€å¾€éœ€è¦ç»è¿‡å¤šæ¬¡è¯·æ±‚æ‰èƒ½è§£æåˆ°ã€‚æŸ¥çœ‹ pod å†… çš„ <code>/etc/resolv.conf</code> å¯ä»¥çŸ¥é“ <code>ndots</code> é€‰é¡¹é»˜è®¤ä¸º 5ã€‚ä¾‹å¦‚ï¼Œåœ¨ debug å‘½åç©ºé—´æŸ¥è¯¢ <code>kubernetes.default.svc.cluster.local</code> è¿™ä¸ª serviceï¼š</p><p>åŸŸåä¸­æœ‰ 4 ä¸ª <code>.</code> ï¼Œå°äº 5ï¼Œå°è¯•æ‹¼æ¥ä¸Šç¬¬ä¸€ä¸ª search è¿›è¡ŒæŸ¥è¯¢ï¼Œå³<code>kubernetes.default.svc.cluster.local.debug.svc.cluster.local</code> ï¼ŒæŸ¥ä¸åˆ°è¯¥åŸŸåã€‚</p><p>ç»§ç»­å°è¯• <code>kubernetes.default.svc.cluster.local.svc.cluster.local</code> ï¼ŒæŸ¥ä¸åˆ°è¯¥åŸŸåã€‚</p><p>ç»§ç»­å°è¯• <code>kubernetes.default.svc.cluster.local.cluster.local</code> ï¼Œä»ç„¶æŸ¥ä¸åˆ°è¯¥åŸŸåã€‚</p><p>å°è¯•ä¸åŠ åç¼€ï¼Œå³ <code>kubernetes.default.svc.cluster.local</code> ï¼ŒæŸ¥è¯¢æˆåŠŸï¼Œè¿”å›å“åº”çš„ ClusterIPã€‚</p><p>ä¸Šé¢ä¸€ä¸ªç®€å•çš„ service åŸŸåè§£æéœ€è¦ç»è¿‡ 4 è½®è§£ææ‰èƒ½æˆåŠŸï¼Œé›†ç¾¤ä¸­å……æ–¥ç€å¤§é‡æ— ç”¨çš„ DNS è¯·æ±‚ã€‚å› æ­¤éœ€è¦æ ¹æ®ä¸šåŠ¡é…ç½®çš„è®¿é—®æ–¹å¼æ¥ä¸ºå…¶è®¾ç½®åˆç†çš„ ndots æ¥é™ä½æŸ¥è¯¢æ¬¡æ•°ï¼š</p></li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">dnsConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ndots
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p><strong>ä¼˜åŒ–ä¸šåŠ¡è®¿é—®æœåŠ¡çš„åŸŸåé…ç½®</strong>ï¼š</p><p>Pod è®¿é—®æœ¬å‘½åç©ºé—´çš„ Serviceï¼Œä½¿ç”¨ <code>&lt;service-name&gt;</code> è®¿é—®ã€‚</p><p>Pod è®¿é—®å…¶å®ƒå‘½åç©ºé—´çš„ Serviceï¼Œä½¿ç”¨ <code>&lt;service-name&gt;.&lt;namespace-name&gt;</code> è®¿é—®ã€‚</p><p>Pod è®¿é—®å¤–éƒ¨åŸŸåï¼Œä½¿ç”¨ FQDN ç±»å‹åŸŸåè®¿é—®ï¼Œåœ¨åŸŸåæœ€åæ·»åŠ  <code>.</code> ä»¥å‡å°‘æ— æ•ˆæœç´¢ã€‚</p></li><li><p><strong>ä¿®æ”¹ timeoutã€attempts</strong> glibc çš„ resolver åº“è®¿é—®ä¸€ä¸ª name server çš„è¶…æ—¶æ—¶é—´é»˜è®¤ä¸º5ç§’ï¼Œé’ˆå¯¹ /etc/resolv.conf ä¸­åˆ—å‡ºçš„ä¸€ç»„ name serverï¼Œé»˜è®¤æœ€å¤šå°è¯•ï¼ˆattemptsï¼‰2æ¬¡ï¼Œå¦‚ /etc/resolv.conf ä¸­é…ç½®ä¸¤ä¸ª name serverï¼Œå½“æ‰€æœ‰ name server éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ€»è¶…æ—¶æ—¶é—´ä¸º20ç§’ï¼Œç„¶è€Œï¼Œè¿™å¯¹äºè®¸å¤šä¸šåŠ¡æ¥è¯´è¿‡äºä¿å®ˆã€‚å¯ä»¥æ ¹æ®ä¸šåŠ¡å®é™…éœ€è¦ï¼Œä¸º Pod è®¾ç½®åˆç†çš„ DNS è¶…æ—¶é…ç½®ï¼Œä»¥é™ä½è¶…æ—¶æ—¶é—´ï¼Œé¿å… DNS æœåŠ¡çŸ­æ—¶ä¸å¯ç”¨å¯¼è‡´ä¸šåŠ¡ååé‡çš„æ˜¾è‘—ä¸‹é™ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p></li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">dnsConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> timeout
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> attempts
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="coredns-ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#coredns-ç›‘æ§" aria-hidden="true">#</a> CoreDNS ç›‘æ§</h3><p>ç”¨è‡ªå¸¦çš„ç›‘æ§å¤§ç›˜å³å¯ï¼Œé‡ç‚¹å…³æ³¨ Requests (total)ã€Responses (by rcode)ã€Responses (duration) è¿™å‡ ä¸ªæŒ‡æ ‡å³å¯ï¼Œè¿›è¡Œå®¹é‡æ‰©å®¹ï¼Œæˆ–ç»“åˆæ—¥å¿—è¿›ä¸€æ­¥é—®é¢˜å®šä½ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p>ç»´åŸºç™¾ç§‘ï¼šhttps://zh.wikipedia.org/wiki/%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F</p><p>è‡ªå®šä¹‰ DNS æœåŠ¡ï¼šhttps://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-custom-nameservers/</p><p>DNSæ¦‚è¿°ï¼šhttps://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/dns-overview</p><p>TKE DNS æœ€ä½³å®è·µï¼šhttps://cloud.tencent.com/document/product/457/78005</p><p>åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ NodeLocal DNSCacheï¼šhttps://kubernetes.io/zh-cn/docs/tasks/administer-cluster/nodelocaldns/</p><p>æˆ‘æ˜¯ Clayï¼Œä¸‹æœŸè§ ğŸ‘‹</p><hr><blockquote><ul><li><p>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·ã€ŒSREè¿ç»´è¿›é˜¶ä¹‹è·¯ã€æˆ–å…³æ³¨æˆ‘çš„ Github https://github.com/clay-wangzhi/wiki æŸ¥çœ‹æœ€æ–°æ–‡ç« </p></li><li><p>æ¬¢è¿åŠ æˆ‘å¾®ä¿¡<code>sre-k8s-ai</code>ï¼Œä¸æˆ‘è®¨è®ºäº‘åŸç”Ÿã€ç¨³å®šæ€§ç›¸å…³å†…å®¹</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin-20240220180036567.png" alt="weixin" style="zoom:50%;">`,30);function R(T,M){const s=l("ExternalLinkIcon");return r(),i("div",null,[p,n("p",null,[e("CoreDNSæ˜¯Kubernetesé›†ç¾¤ä¸­è´Ÿè´£DNSè§£æçš„ç»„ä»¶ï¼Œèƒ½å¤Ÿæ”¯æŒè§£æé›†ç¾¤å†…éƒ¨è‡ªå®šä¹‰æœåŠ¡åŸŸåå’Œé›†ç¾¤å¤–éƒ¨åŸŸåã€‚CoreDNSå…·å¤‡ä¸°å¯Œçš„æ’ä»¶é›†ï¼Œåœ¨é›†ç¾¤å±‚é¢æ”¯æŒè‡ªå»ºDNSã€è‡ªå®šä¹‰hostsã€CNAMEã€rewriteç­‰éœ€æ±‚ã€‚ä¸Kubernetesä¸€æ ·ï¼ŒCoreDNSé¡¹ç›®ç”±"),n("a",d,[e("CNCF"),a(s)]),e("æ‰˜ç®¡ã€‚")]),u,n("p",null,[e("CoreDNS æ˜¯æ¨¡å—åŒ–ä¸”å¯æ’æ‹”çš„ DNS æœåŠ¡å™¨ï¼Œæ¯ä¸ªæ’ä»¶éƒ½ä¸º CoreDNS æ·»åŠ äº†æ–°åŠŸèƒ½ã€‚ å¯ä»¥é€šè¿‡ç»´æŠ¤ "),n("a",k,[e("Corefile"),a(s)]),e("ï¼Œå³ CoreDNS é…ç½®æ–‡ä»¶ï¼Œ æ¥é…ç½® CoreDNS æœåŠ¡å™¨ã€‚ä½œä¸ºä¸€ä¸ªé›†ç¾¤ç®¡ç†å‘˜ï¼Œä½ å¯ä»¥ä¿®æ”¹ CoreDNS Corefile çš„ "),n("a",v,[e("ConfigMap"),a(s)]),e("ï¼Œ ä»¥æ›´æ”¹ DNS æœåŠ¡å‘ç°é’ˆå¯¹è¯¥é›†ç¾¤çš„å·¥ä½œæ–¹å¼ã€‚")]),m,n("p",null,[e("Corefile é…ç½®åŒ…æ‹¬ä»¥ä¸‹ CoreDNS "),n("a",h,[e("æ’ä»¶"),a(s)]),e("ï¼š")]),n("ul",null,[n("li",null,[n("p",null,[n("a",b,[e("errors"),a(s)]),e("ï¼šé”™è¯¯è®°å½•åˆ°æ ‡å‡†è¾“å‡ºã€‚")])]),n("li",null,[n("p",null,[n("a",g,[e("health"),a(s)]),e("ï¼šåœ¨ "),f,e(" å¤„æä¾› CoreDNS çš„å¥åº·æŠ¥å‘Šã€‚ åœ¨è¿™ä¸ªæ‰©å±•è¯­æ³•ä¸­ï¼Œ"),_,e(" ä¼šä½¿æ­¤è¿›ç¨‹ä¸å¥åº·ï¼Œç­‰å¾… 5 ç§’åè¿›ç¨‹è¢«å…³é—­ã€‚")])]),n("li",null,[n("p",null,[n("a",N,[e("ready"),a(s)]),e("ï¼šåœ¨ç«¯å£ 8181 ä¸Šæä¾›çš„ä¸€ä¸ª HTTP ç«¯ç‚¹ï¼Œ å½“æ‰€æœ‰èƒ½å¤Ÿè¡¨è¾¾è‡ªèº«å°±ç»ªçš„æ’ä»¶éƒ½å·²å°±ç»ªæ—¶ï¼Œåœ¨æ­¤ç«¯ç‚¹è¿”å› 200 OKã€‚")])]),n("li",null,[n("p",null,[n("a",y,[e("kubernetes"),a(s)]),e("ï¼šCoreDNS å°†åŸºäºæœåŠ¡å’Œ Pod çš„ IP æ¥åº”ç­” DNS æŸ¥è¯¢ã€‚ ä½ å¯ä»¥åœ¨ CoreDNS ç½‘ç«™æ‰¾åˆ°æœ‰å…³æ­¤æ’ä»¶çš„"),n("a",S,[e("æ›´å¤šç»†èŠ‚"),a(s)]),e("ã€‚")]),D]),n("li",null,[n("p",null,[n("a",C,[e("prometheus"),a(s)]),e("ï¼šCoreDNS çš„åº¦é‡æŒ‡æ ‡å€¼ä»¥ "),n("a",P,[e("Prometheus"),a(s)]),e(" æ ¼å¼ï¼ˆä¹Ÿç§°ä¸º OpenMetricsï¼‰åœ¨ "),x,e(" ä¸Šæä¾›ã€‚")])]),n("li",null,[n("p",null,[n("a",I,[e("forward"),a(s)]),e(": ä¸åœ¨ Kubernetes é›†ç¾¤åŸŸå†…çš„ä»»ä½•æŸ¥è¯¢éƒ½å°†è½¬å‘åˆ°é¢„å®šä¹‰çš„è§£æå™¨ (/etc/resolv.conf)ã€‚")])]),n("li",null,[n("p",null,[n("a",q,[e("cache"),a(s)]),e("ï¼šå¯ç”¨å‰ç«¯ç¼“å­˜ã€‚")])]),n("li",null,[n("p",null,[n("a",A,[e("loop"),a(s)]),e("ï¼šæ£€æµ‹ç®€å•çš„è½¬å‘ç¯ï¼Œå¦‚æœå‘ç°æ­»å¾ªç¯ï¼Œåˆ™ä¸­æ­¢ CoreDNS è¿›ç¨‹ã€‚")])]),n("li",null,[n("p",null,[n("a",L,[e("reload"),a(s)]),e("ï¼šå…è®¸è‡ªåŠ¨é‡æ–°åŠ è½½å·²æ›´æ”¹çš„ Corefileã€‚ ç¼–è¾‘ ConfigMap é…ç½®åï¼Œè¯·ç­‰å¾…ä¸¤åˆ†é’Ÿï¼Œä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚")])]),n("li",null,[n("p",null,[n("a",w,[e("loadbalance"),a(s)]),e("ï¼šè¿™æ˜¯ä¸€ä¸ªè½®è½¬å¼ DNS è´Ÿè½½å‡è¡¡å™¨ï¼Œ å®ƒåœ¨åº”ç­”ä¸­éšæœºåˆ†é… Aã€AAAA å’Œ MX è®°å½•çš„é¡ºåºã€‚")])])]),E])}const K=o(c,[["render",R],["__file","coredns.html.vue"]]);export{K as default};
