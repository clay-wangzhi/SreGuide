(window.webpackJsonp=window.webpackJsonp||[]).push([[294],{998:function(e,s,a){"use strict";a.r(s);var n=a(1),t=Object(n.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"使用-kubesphere3-1-1-监控功能遇到的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-kubesphere3-1-1-监控功能遇到的问题"}},[e._v("#")]),e._v(" 使用 kubesphere3.1.1 监控功能遇到的问题")]),e._v(" "),a("h2",{attrs:{id:"接入自定义-prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接入自定义-prometheus"}},[e._v("#")]),e._v(" 接入自定义 Prometheus")]),e._v(" "),a("blockquote",[a("p",[e._v("⚠️")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("node-exporter 和 kube-state-metrics 两个组件的版本一定要 kubeSphere 吻合")])]),e._v(" "),a("li",[a("p",[e._v("如果使用helm部署的， prometheus-rules.yaml 和 prometheus-rulesEtcd.yaml 两个rules的配置文件需要额外添加一些 labels和annotations")]),e._v(" "),a("blockquote",[a("p",[e._v("简单来说，类似标签选择器，定义的PrometheusRule资源对象，需要带有一些Labels，具体哪些可以参考默认生成的PrometheusRule，然后新建的也给加上")])])])])]),e._v(" "),a("p",[e._v("千呼万唤始出来，KubeSphere 3.1.1 终于可以接入自定义 Prometheus 了，以前虽然也支持集成自己的prometheus,但是我们来看下KubeSphere 3.1.1 之前集成自己的prometheus的步骤")]),e._v(" "),a("ol",[a("li",[e._v("卸载 KubeSphere 的自定义 Prometheus 堆栈")]),e._v(" "),a("li",[e._v("安装您自己的 Prometheus 堆栈")]),e._v(" "),a("li",[e._v("将 KubeSphere 自定义组件安装至您的 Prometheus 堆栈")]),e._v(" "),a("li",[e._v("更改 KubeSphere 的 "),a("code",[e._v("monitoring endpoint")])])]),e._v(" "),a("p",[e._v("这个步骤，给我的感觉就一个，脱裤子放屁，一点都不优雅，接下来我们试一下使用最新的KubeSphere 3.1.1直接接入自定义的Prometheus")]),e._v(" "),a("p",[e._v("首先这个kubernetes集群里已经安装了prometheus-operator ，位于monitoring 这个namaspace")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716003034486.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716003034486.png",alt:"image-20210716003034486"}}),a("OutboundLink")],1)]),e._v(" "),a("h3",{attrs:{id:"最小化部署kubesphere"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最小化部署kubesphere"}},[e._v("#")]),e._v(" 最小化部署kubesphere")]),e._v(" "),a("p",[e._v("下载配置文件")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("wget https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/kubesphere-installer.yaml\nwget https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/cluster-configuration.yaml\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("官方默认提供的cluster-configuration.yaml是一个最小化安装的配置文件，主要修改monitoring 中的type和endpoint：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    monitoring:\n      type: external   # 设置使用自定义的prometheus\n      endpoint: http://prometheus-operated.monitoring.svc:9090 # Prometheus 地址\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("p",[e._v("注意上述定义的"),a("code",[e._v("storageClass")]),e._v("要根据自己实际情况填写。")]),e._v(" "),a("p",[e._v("部署这两个文件")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl apply -f kubesphere-installer.yaml\nkubectl apply -f cluster-configuration.yaml\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("我们可以使用如下命令检查安装日志：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716010631751.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716010631751.png",alt:"image-20210716010631751"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("安装服务日志最后出现如下错误，可以暂时不用处理，这个后面会提到：")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716011208355.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716011208355.png",alt:"image-20210716011208355"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("服务会部署一个类型为"),a("code",[e._v("nodePort")]),e._v("类型的service来作为访问入口")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[root@master-01 kubesphere]# kubectl get pod,svc -n kubesphere-system \nNAME                                         READY   STATUS      RESTARTS   AGE\npod/ks-apiserver-6f79d49f66-4p88s            1/1     Running     0          105s\npod/ks-console-74cf8b9487-56gxm              1/1     Running     0          3m\npod/ks-controller-manager-668f5fd585-zzd8h   1/1     Running     0          105s\npod/ks-installer-7bd6b699df-pjjmf            1/1     Running     0          6m50s\npod/minio-597cb64f44-stwz6                   1/1     Running     0          4m16s\npod/openpitrix-import-job-2dk99              0/1     Completed   0          2m12s\n\nNAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nservice/ks-apiserver            ClusterIP   10.105.13.140    <none>        80/TCP         3h50m\nservice/ks-console              NodePort    10.105.229.139   <none>        80:30880/TCP   3h50m\nservice/ks-controller-manager   ClusterIP   10.106.17.200    <none>        443/TCP        3h50m\nservice/minio                   ClusterIP   10.102.76.218    <none>        9000/TCP       4m16s\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br")])]),a("p",[e._v("我们可以使用默认帐户和密码 "),a("code",[e._v("(admin/P@88w0rd)")]),e._v(" 访问 Web 控制台。")]),e._v(" "),a("h3",{attrs:{id:"将-kubesphere-自定义组件安装至您的-prometheus-堆栈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#将-kubesphere-自定义组件安装至您的-prometheus-堆栈"}},[e._v("#")]),e._v(" 将 KubeSphere 自定义组件安装至您的 Prometheus 堆栈")]),e._v(" "),a("p",[e._v("KubeSphere 3.0 使用 Prometheus Operator 来管理 Prometheus/Alertmanager 配置和生命周期、ServiceMonitor（用于管理抓取配置）和 PrometheusRule（用于管理 Prometheus 记录/告警规则）。")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716011553759.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716011553759.png",alt:"image-20210716011553759"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("我们此时访问web控制台会发现展示监控数据相关的页面均无法正常显示，想要正常显示监控数据，我们需要部署kubesphere提供的prometheus-rules.yaml"),a("code",[e._v("和")]),e._v("prometheus-rulesEtcd.yaml")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("git clone https://github.com/kubesphere/kube-prometheus.git\ncd kube-prometheus/kustomize\nsed -i 's/kubesphere-monitoring-system/monitoring/g' prometheus-rulesEtcd.yaml\nsed -i 's/kubesphere-monitoring-system/monitoring/g' prometheus-rules.yaml\nkubectl apply -f prometheus-rules.yaml -f prometheus-rulesEtcd.yaml\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("部署后，稍等一两分钟页面即可正常显示监控数据")]),e._v(" "),a("h3",{attrs:{id:"已知问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#已知问题"}},[e._v("#")]),e._v(" 已知问题")]),e._v(" "),a("p",[a("strong",[e._v("问题一")])]),e._v(" "),a("p",[e._v("点击监控告警下的自定义监控页面会提示找不到api ，这个就和我们前面安装日志最后日志出现的报错有关系")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716020743998.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716020743998.png",alt:"image-20210716020743998"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("使用如下命令部署缺少的crd资源")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl apply -f https://raw.githubusercontent.com/kubesphere/monitoring-dashboard/master/config/crd/bases/monitoring.kubesphere.io_clusterdashboards.yaml\nkubectl apply -f https://raw.githubusercontent.com/kubesphere/monitoring-dashboard/master/config/crd/bases/monitoring.kubesphere.io_dashboards.yaml\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("部署完成后需要执行如下命令重启"),a("code",[e._v("ks-apiserver")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl -n kubesphere-system rollout restart deploy/ks-apiserver\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("重启完成后，访问页面如下")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716021427587.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716021427587.png",alt:"image-20210716021427587"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("点击创建，系统内置了几个默认的模板，我们这里添加一个redis的dashboard")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716021543542.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716021543542.png",alt:"image-20210716021543542"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716021557850.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716021557850.png",alt:"image-20210716021557850"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("自定义监控模板可参考：")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://kubesphere.com.cn/docs/project-user-guide/custom-application-monitoring/visualization/overview/#%E5%88%9B%E5%BB%BA%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://kubesphere.com.cn/docs/project-user-guide/custom-application-monitoring/visualization/overview/#%E5%88%9B%E5%BB%BA%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("https://github.com/kubesphere/monitoring-dashboard")])]),e._v(" "),a("p",[a("strong",[e._v("问题二")])]),e._v(" "),a("p",[e._v("监控告警下的告警策略和告警消息无法创建自定义策略")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716023858088.png",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://hugo-doc-img.oss-cn-shanghai.aliyuncs.com/img/image-20210716023858088.png",alt:"image-20210716023858088"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("参考：")]),e._v(" "),a("p",[e._v("https://github.com/kubesphere/kubesphere/issues/3880")]),e._v(" "),a("h2",{attrs:{id:"使用-kubesphere-自带监控-监控二进制部署的k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-kubesphere-自带监控-监控二进制部署的k8s"}},[e._v("#")]),e._v(" 使用 kubesphere 自带监控 监控二进制部署的k8s")]),e._v(" "),a("h3",{attrs:{id:"kubesphere监控外部etcd集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubesphere监控外部etcd集群"}},[e._v("#")]),e._v(" kubesphere监控外部etcd集群")]),e._v(" "),a("p",[e._v("1）创建集群 Etcd 的证书 Secret")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  \\\n--from-file=etcd-client-ca.crt=/etc/kubernetes/ssl/ca.pem  \\\n--from-file=etcd-client.crt=/etc/kubernetes/ssl/kubernetes.pem  \\\n--from-file=etcd-client.key=/etc/kubernetes/ssl/kubernetes-key.pem\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("blockquote",[a("p",[e._v("证书路径根据实际情况来改")])]),e._v(" "),a("p",[e._v("2）编辑 ClusterConfiguration 开启可插拔的功能组件:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("  etcd:\n    monitoring: true\n    endpointIps: 192.168.135.29,192.168.135.157,192.168.135.47\n    port: 2379\n    tlsEnable: true\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("3）解决 找不到证书")]),e._v(" "),a("p",[a("code",[e._v("kubectl edit prometheuses.monitoring.coreos.com -n kubesphere-monitoring-system k8s")]),e._v("\nsecurityContext前添加")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("secrets:\n- kube-etcd-client-certs\nsecurityContext:\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("p",[e._v("4）按功能需求编辑配置文件之后，退出等待生效即可，如长时间未生效请使用如下命令查看相关日志:")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("kubectl logs -n kubesphere-system "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("kubectl get pod -n kubesphere-system -l "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("ks-install -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("jsonpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'{.items[0].metadata.name}'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v(" -f\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"kubesphere监控外部controller-manager和scheduler"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubesphere监控外部controller-manager和scheduler"}},[e._v("#")]),e._v(" kubesphere监控外部controller-manager和scheduler")]),e._v(" "),a("p",[e._v("二进制安装的k8s，在使用operator安装的Prometheus，默认是监控不到controller-manager和scheduler，需要另行配置这两个组件。原因在于servicemonitor是通过匹配service中的label来添加监控的，但是二进制安装的k8s中，kube-system这个namespace中没有controller-manager和scheduler的service")]),e._v(" "),a("p",[e._v("查看kube-controller-manager的servicemonitor")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# kubectl -n kubesphere-monitoring-system get servicemonitors.monitoring.coreos.com kube-controller-manager -o yaml | tail -15")]),e._v("\n    - action: keep\n      regex: up\n      sourceLabels:\n      - __name__\n    port: http-metrics\n    scheme: http\n    tlsConfig:\n      insecureSkipVerify: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),e._v("\n  jobLabel: k8s-app\n  namespaceSelector:\n    matchNames:\n    - kube-system\n  selector:\n    matchLabels:\n      k8s-app: kube-controller-manager\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br")])]),a("ul",[a("li",[e._v("其需要在kube-system下匹配一个含有k8s-app=kube-controller-manager的service")]),e._v(" "),a("li",[e._v("修改其scheme为http，默认为https")])]),e._v(" "),a("p",[e._v("kube-controller-manager这个标签的"),a("code",[e._v("service")]),e._v("和"),a("code",[e._v("endpoints")]),e._v("在kube-system这个namespace是没有的，所有Prometheus无法获取controller-manager的信息，所以需要创建controller-manager的service和endpoint")]),e._v(" "),a("p",[e._v("1）删除旧的svc，ep")]),e._v(" "),a("p",[e._v("2）创建新的svc，ep")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# cat controller-service.yaml ")]),e._v("\napiVersion: v1\nkind: Service\nmetadata:\n  name: kube-controller-manager-svc\n  namespace: kube-system\n  labels:\n    k8s-app: kube-controller-manager\nspec:\n  ports:\n  - port: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10252")]),e._v("\n    name: http-metrics\n    protocol: TCP\n  type: ClusterIP\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# cat controller-endpoint.yaml ")]),e._v("\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: kube-controller-manager-svc\n  namespace: kube-system\n  labels:\n    k8s-app: kube-controller-manager\nsubsets:\n  - addresses:\n    - ip: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".135.214\n    - ip: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".135.175\n    - ip: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".135.218\n    ports:\n    - name: http-metrics\n      port: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10252")]),e._v("\n      protocol: TCP\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("kubectl apply -f controller-service.yaml controller-endpoint.yaml \nkubectl get svc,ep -n kube-system -l k8s-app"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("kube-controller-manager\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("同理修改scheduler的相关配置，就能监控scheduler的信息")]),e._v(" "),a("p",[e._v("yaml 文件如下")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# cat scheduler-service.yaml ")]),e._v("\napiVersion: v1\nkind: Service\nmetadata:\n  name: kube-scheduler-svc\n  namespace: kube-system\n  labels:\n    k8s-app: kube-scheduler\nspec:\n  ports:\n  - port: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10251")]),e._v("\n    name: http-metrics\n    protocol: TCP\n  type: ClusterIP\n  \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# cat scheduler-endpoint.yaml ")]),e._v("\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: kube-scheduler-svc\n  namespace: kube-system\n  labels:\n    k8s-app: kube-scheduler\nsubsets:\n  - addresses:\n    - ip: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".135.214\n    - ip: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".135.175\n    - ip: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".135.218\n    ports:\n    - name: http-metrics\n      port: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10251")]),e._v("\n      protocol: TCP\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br"),a("span",{staticClass:"line-number"},[e._v("20")]),a("br"),a("span",{staticClass:"line-number"},[e._v("21")]),a("br"),a("span",{staticClass:"line-number"},[e._v("22")]),a("br"),a("span",{staticClass:"line-number"},[e._v("23")]),a("br"),a("span",{staticClass:"line-number"},[e._v("24")]),a("br"),a("span",{staticClass:"line-number"},[e._v("25")]),a("br"),a("span",{staticClass:"line-number"},[e._v("26")]),a("br"),a("span",{staticClass:"line-number"},[e._v("27")]),a("br"),a("span",{staticClass:"line-number"},[e._v("28")]),a("br"),a("span",{staticClass:"line-number"},[e._v("29")]),a("br"),a("span",{staticClass:"line-number"},[e._v("30")]),a("br"),a("span",{staticClass:"line-number"},[e._v("31")]),a("br"),a("span",{staticClass:"line-number"},[e._v("32")]),a("br")])]),a("h2",{attrs:{id:"其他问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他问题"}},[e._v("#")]),e._v(" 其他问题")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("问题一：How to fix the error undefined variable “$labels”in Prometheus?")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("问题原因：使用helm模板")])]),e._v(" "),a("li",[a("p",[e._v("解决办法：将 "),a("code",[e._v("{{")]),e._v(" 和 "),a("code",[e._v("}}")]),e._v("更改为如下格式")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('"{{`{{`}}  {{`}}`}}"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])])])])])]),e._v(" "),a("h2",{attrs:{id:"参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[e._v("#")]),e._v(" 参考链接")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://kubesphere.com.cn/docs/faq/observability/byop/",target:"_blank",rel:"noopener noreferrer"}},[e._v("集成您自己的 Prometheus | kubesphere官方文档"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://www.lishuai.fun/2021/07/16/kubesphere-external-prometheus/",target:"_blank",rel:"noopener noreferrer"}},[e._v("kubesphere 3.1.1 接入自定义 Prometheus | 李帅"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/kubesphere/ks-installer/blob/master/README_zh.md#%E5%AE%89%E8%A3%85%E5%8F%AF%E6%8F%92%E6%8B%94%E5%8A%9F%E8%83%BD%E7%BB%84%E4%BB%B6",target:"_blank",rel:"noopener noreferrer"}},[e._v("ks 安装可插拔功能组件 | github"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://kubesphere.com.cn/forum/d/2349-etcd",target:"_blank",rel:"noopener noreferrer"}},[e._v("开启etcd监控时无数据 | kubesphere开发者社区"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://stackoverflow.com/questions/64693812/how-to-fix-the-error-undefined-variable-labelsin-prometheus",target:"_blank",rel:"noopener noreferrer"}},[e._v("How to fix the error undefined variable “$labels”in Prometheus?"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/wzy_168/article/details/103290235",target:"_blank",rel:"noopener noreferrer"}},[e._v("prometheus-operator使用【自定义PrometheusRule】| CSDN"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/bigberg/p/14009940.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Prometheus operator | CSDN bigberg"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=t.exports}}]);