(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{573:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"_17-io-模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_17-io-模型"}},[s._v("#")]),s._v(" 17 IO 模型")]),s._v(" "),a("h2",{attrs:{id:"重要概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重要概念"}},[s._v("#")]),s._v(" 重要概念")]),s._v(" "),a("h3",{attrs:{id:"同步、异步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同步、异步"}},[s._v("#")]),s._v(" 同步、异步")]),s._v(" "),a("p",[s._v("函数或方法被调用的时候，调用者是否得到"),a("strong",[s._v("最终结果")]),s._v("的。\n直接得到最终结果结果的，就是同步调用；\n不直接得到最终结果的，就是异步调用。")]),s._v(" "),a("h3",{attrs:{id:"阻塞、非阻塞"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#阻塞、非阻塞"}},[s._v("#")]),s._v(" 阻塞、非阻塞")]),s._v(" "),a("p",[s._v("函数或方法调用的时候，是否立刻返回。\n立即返回就是非阻塞调用；\n不立即返回就是阻塞调用。")]),s._v(" "),a("h3",{attrs:{id:"区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#区别"}},[s._v("#")]),s._v(" 区别")]),s._v(" "),a("p",[s._v("同步、异步，与阻塞、非阻塞不相关。\n同步、异步强调的是，是否得到（最终的）"),a("strong",[s._v("结果")]),s._v("；\n阻塞、非阻塞强调是时间，是否"),a("strong",[s._v("等待")]),s._v("。")]),s._v(" "),a("p",[s._v("同步与异步区别在于：调用者是否得到了想要的最终结果。\n同步就是一直要执行到返回最终结果；\n异步就是直接返回了，但是返回的不是最终结果。调用者不能通过这种调用得到结果，以后可以通过被调用者提供的某种方式（被调用者通知调用者、调用者反复查询、回调），来取回最终结果。")]),s._v(" "),a("p",[s._v("阻塞与非阻塞的区别在于，调用者是否还能干其他事。\n阻塞，调用者就只能干等；\n非阻塞，调用者可以先去忙会别的，不用一直等。")]),s._v(" "),a("h3",{attrs:{id:"联系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#联系"}},[s._v("#")]),s._v(" 联系")]),s._v(" "),a("p",[s._v("同步阻塞，我啥事不干，就等你打饭打给我。打到饭是结果，而且我啥事不干一直等，同步加阻塞。\n同步非阻塞，我等着你打饭给我，饭没好，我不等，但是我无事可做，反复看饭好了没有。打饭是结果，但是我不一直等。")]),s._v(" "),a("p",[s._v("异步阻塞，我要打饭，你说等叫号，并没有返回饭给我，我啥事不干，就干等着饭好了你叫我。例如，取了号什么不干就等叫自己的号。\n异步非阻塞，我要打饭，你给我号，你说等叫号，并没有返回饭给我，我去看电视、玩手机，饭打好了叫我。")]),s._v(" "),a("h2",{attrs:{id:"io两个阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#io两个阶段"}},[s._v("#")]),s._v(" IO两个阶段")]),s._v(" "),a("p",[s._v("IO过程分两阶段：\n1、数据准备阶段。从设备读取数据到内核空间的缓冲区（淘米，把米放饭锅里煮饭）\n2、内核空间复制回用户空间进程缓冲区阶段（盛饭，从内核这个饭锅里面把饭装到碗里来）")]),s._v(" "),a("p",[s._v("系统调用——read函数、recv函数等")]),s._v(" "),a("h2",{attrs:{id:"同步-io-模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同步-io-模型"}},[s._v("#")]),s._v(" 同步 IO 模型")]),s._v(" "),a("p",[s._v("同步IO模型包括 阻塞IO、非阻塞IO、IO多路复用")]),s._v(" "),a("h3",{attrs:{id:"阻塞-io"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#阻塞-io"}},[s._v("#")]),s._v(" 阻塞 IO")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/block_io.png",alt:"block_io"}})]),s._v(" "),a("h3",{attrs:{id:"非阻塞-io"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#非阻塞-io"}},[s._v("#")]),s._v(" 非阻塞 IO")]),s._v(" "),a("p",[s._v("进程调用 recvfrom 操作，如果 IO 设备没有准备好，立即返回 ERROR，进程不阻塞。用户可以再次发起系统调用（可以轮询），如果内核已经准备好，就阻塞，然后复制数据到用户空间。")]),s._v(" "),a("p",[s._v("第一阶段数据没有准备好，可以先忙别的，等会再来看看。检查数据是否准备好了的过程是非阻塞的。")]),s._v(" "),a("p",[s._v("第二阶段是阻塞的，即内核空间和用户空间之间复制数据是阻塞的。")]),s._v(" "),a("p",[s._v("淘米、蒸饭我不阻塞等，反复来询问，一直没有拿到饭。盛饭过程我等着你装好饭，但是要等到盛好饭才算完事，这是同步的，结果就是盛好饭。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/unblock-io.png",alt:"unblock-io"}})]),s._v(" "),a("h3",{attrs:{id:"io多路复用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#io多路复用"}},[s._v("#")]),s._v(" IO多路复用")]),s._v(" "),a("p",[s._v("也称 Event-driven IO。")]),s._v(" "),a("p",[s._v("所谓 IO 多路复用，就是同时监控多个 IO，有一个准备好了，就不需要等了开始处理，提高了同时处理 IO 的能力。\nselect几乎所有操作系统平台都支持，poll是对的select的升级。")]),s._v(" "),a("p",[s._v("epoll，Linux系统内核2.5+开始支持，对select和poll的增强，在监视的基础上，增加回调机制。BSD、\nMac平台有kqueue，Windows有iocp。")]),s._v(" "),a("p",[s._v("以 select 为例，将关注的 IO 操作告诉 select 函数并调用，进程阻塞，内核“监视” select 关注的文件描述符  fd，被关注的任何一个 fd 对应的IO准备好了数据，select 返回。再使用 read 将数据复制到用户进程。")]),s._v(" "),a("p",[s._v("select举例：\n食堂供应很多菜（众多的IO），你需要吃某三菜一汤，大师傅（操作系统）说要现做，需要你等，好多人都在等菜，谁先好不知道，你只好等待大师傅叫。你的其中一样菜好了，大师傅叫你，说你点的菜有好的了，你得自己遍历找找看哪一样才好了，请服务员把做好的菜打给你。\nepoll是有菜准备好了，大师傅喊你去几号窗口直接打菜，不用自己找菜了。")]),s._v(" "),a("p",[s._v("一般情况下，select 最多能监听1024个 fd（可以修改），但是由于select采用轮询的方式，当管理的 IO 多了，每次都要遍历全部fd，效率低下。\nepoll 没有管理的 fd 的上限，且是回调机制，不需遍历，效率很高。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/io-more-road.png",alt:"io-more-road"}})]),s._v(" "),a("h3",{attrs:{id:"信号驱动io"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#信号驱动io"}},[s._v("#")]),s._v(" 信号驱动IO")]),s._v(" "),a("p",[s._v("进程在 IO 访问时，先通过 sigaction 系统调用，提交一个信号处理函数，立即返回。进程不阻塞。")]),s._v(" "),a("p",[s._v("当内核准备好数据后，产生一个 SIGIO 信号并投递给信号处理函数。可以在此函数中调用 recvfrom 函数\n操作数据从内核空间复制到用户空间，这段过程进程阻塞。")]),s._v(" "),a("h2",{attrs:{id:"异步-io"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异步-io"}},[s._v("#")]),s._v(" 异步 IO")]),s._v(" "),a("p",[s._v("进程发起异步 IO 请求，立即返回。内核完成 IO 的两个阶段，内核给进程发一个信号。")]),s._v(" "),a("p",[s._v("举例，来打饭，跟大师傅说饭好了叫你，饭菜准备好了，窗口服务员把饭盛好了打电话叫你。两阶段都是异步的。在整个过程中，进程都可以忙别的，等好了才过来。\n举例，今天不想出去到饭店吃饭了，点外卖，饭菜在饭店做好了（第一阶段），快递员从饭店送到你家门口（第二阶段）。\nLinux 的 aio 的系统调用，内核从版本2.6开始支持")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/io-async.png",alt:"io-async"}})]),s._v(" "),a("p",[s._v("前4个都是同步 IO，因为核心操作 recv 函数调用时，进程阻塞直到拿到最终结果为止。")]),s._v(" "),a("p",[s._v("而异步 IO 进程全程不阻塞。")]),s._v(" "),a("h2",{attrs:{id:"python-中-io多路复用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#python-中-io多路复用"}},[s._v("#")]),s._v(" Python 中 IO多路复用")]),s._v(" "),a("p",[s._v("IO多路复用")]),s._v(" "),a("ul",[a("li",[s._v("大多数操作系统都支持 select 和 poll")]),s._v(" "),a("li",[s._v("Linux 2.5+ 支持 epoll")]),s._v(" "),a("li",[s._v("BSD、Mac支持kqueue")]),s._v(" "),a("li",[s._v("Solaris 实现了/dev/poll")]),s._v(" "),a("li",[s._v("Windows的IOCP")])]),s._v(" "),a("p",[s._v("Python 的 select 库实现了 select、poll 系统调用，这个基本上操作系统都支持。对Linux内核2.5+支持了 epoll。")]),s._v(" "),a("p",[s._v("开发中的选择\n1、完全跨平台，使用 select、poll。但是性能较差\n2、针对不同操作系统自行选择支持的技术，这样做会提高 IO 处理的性能")]),s._v(" "),a("p",[s._v("select 维护一个文件描述符数据结构，单个进程使用有上限，通常是1024，线性扫描这个数据结构。效率低。")]),s._v(" "),a("p",[s._v("pool 和 select 的区别是内部数据结构使用链表，没有这个最大限制，但是依然是线性遍历才知道哪个设备就绪了。\nepoll 使用事件通知机制，使用回调机制提高效率。\nselect/poll 还要从内核空间复制消息到用户空间，而 epoll 通过内核空间和用户空间共享一块内存来减少复制。")]),s._v(" "),a("p",[a("strong",[s._v("selectors 库")])]),s._v(" "),a("p",[s._v("3.4 版本提供 selectors 库，高级 IO 复用库。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("类层次结构︰\nBaseSelector\n+-- SelectSelector  实现select\n+-- PollSelector   实现poll\n+-- EpollSelector   实现epoll\n+-- DevpollSelector  实现devpoll\n+-- KqueueSelector  实现kqueue\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("selectors.DefaultSelector 返回当前平台最有效、性能最高的实现。")]),s._v(" "),a("p",[s._v("但是，由于没有实现 Windows 下的 IOCP，所以，Windows 下只能退化为 select。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在selects模块源码最下面有如下代码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Choose the best implementation, roughly:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    epoll|kqueue|devpoll > poll > select.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# select() also can't accept a FD > FD_SETSIZE (usually around 1024)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'KqueueSelector'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("globals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    DefaultSelector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" KqueueSelector\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elif")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'EpollSelector'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("globals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    DefaultSelector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" EpollSelector\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elif")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DevpollSelector'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("globals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    DefaultSelector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" DevpollSelector\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elif")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PollSelector'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("globals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    DefaultSelector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" PollSelector\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    DefaultSelector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" SelectSelector\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("事件注册")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SelectSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_BaseSelectorImpl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""Select-based selector."""')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("register")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fileobj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" SelectorKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[s._v("为 selector 注册一个文件对象，监视它的 IO 事件。返回 "),a("strong",[s._v("SelectKey")]),s._v(" 对象。")]),s._v(" "),a("li",[s._v("fileobj 被监视文件对象，例如socket对象")]),s._v(" "),a("li",[s._v("events 事件，该文件对象必须等待的事件")]),s._v(" "),a("li",[s._v("data 可选的与此文件对象相关联的不透明数据，例如，关联用来存储每个客户端的会话 ID，关联方法。通过这个参数在关注的事件产生后让selector干什么事。")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Event 常量")]),s._v(" "),a("th",[s._v("含义")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("EVENT_READ")]),s._v(" "),a("td",[s._v("可读 0b01，内核已经准备好输入设备，可以开始读了")])]),s._v(" "),a("tr",[a("td",[s._v("EVENT_WRITE")]),s._v(" "),a("td",[s._v("可写 0b10，内核准备好了，可以往里写了")])])])]),s._v(" "),a("p",[s._v("selectors.SelectorKey 有4个属性：")]),s._v(" "),a("ol",[a("li",[s._v("fileobj 注册的文件对象")]),s._v(" "),a("li",[s._v("fd 文件描述符")]),s._v(" "),a("li",[s._v("events 等待上面的文件描述符的文件对象的事件")]),s._v(" "),a("li",[s._v("data 注册时关联的数据")])]),s._v(" "),a("p",[a("strong",[s._v("练习：IO 多路复用 TCP Server")])]),s._v(" "),a("p",[s._v("完成一个 TCP Server，能够接受客户端请求并回应客户端消息。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" selectors\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" threading\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" socket\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logging\n\nFORMAT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(asctime)s %(threadName)s %(thread)d %(message)s"')]),s._v("\nlogging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("basicConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("FORMAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" level"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建本系统最优Selector")]),s._v("\nselector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selectors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DefaultSelector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nsock "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# TCP Server")]),s._v("\nsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bind"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'127.0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9999")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlogging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setblocking"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意：建议非阻塞")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回调函数，sock的读事件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 形参自定义")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("accept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""mask: 事件掩码"""')]),s._v("\n    conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" raddr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("accept"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setblocking"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 非阻塞")]),s._v("\n\n    logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new client socket {} in accept.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注册sock的被关注事件，返回SelectorKey对象")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# key记录了fileobj, fileobj的fd, events, data")]),s._v("\nkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("register"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" selectors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("EVENT_READ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" accept"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlogging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始循环")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听注册的对象的事件，发生被关注事件则返回events")]),s._v("\n    events "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("select"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# [(key, mask)]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示那个关注的对象的某事件发生了")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# key.data => accept; key.fileobj => sock")]),s._v("\n        callback "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data\n        callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fileobj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br")])]),a("p",[s._v("上面的代码完成了 Server socket 的读事件的监听。注意，select() 方法会阻塞到监控的对象的等待的事件有发生（监听的读或者写就绪）。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" selectors\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" threading\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" socket\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logging\n\nFORMAT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(asctime)s %(threadName)s %(thread)d %(message)s"')]),s._v("\nlogging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("basicConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("FORMAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" level"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建本系统最优Selector")]),s._v("\nselector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selectors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DefaultSelector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nsock "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# TCP Server")]),s._v("\nsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bind"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'127.0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9999")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlogging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setblocking"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意：建议非阻塞")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回调函数，sock的读事件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 形参自定义")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("accept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""mask: 事件掩码"""')]),s._v("\n    conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" raddr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("accept"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setblocking"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 非阻塞")]),s._v("\n\n    logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new client socket {} in accept.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("register"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" selectors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("EVENT_READ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" read"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回调函数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    data "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Your msg = {} ~~~"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("decode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("send"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("encode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注册sock的被关注事件，返回SelectorKey对象")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# key记录了fileobj, fileobj的fd, events, data")]),s._v("\nkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("register"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" selectors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("EVENT_READ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" accept"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlogging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始循环")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听注册的对象的事件，发生被关注事件则返回events")]),s._v("\n    events "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" selector"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("select"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# [(key, mask)]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示那个关注的对象的某事件发生了")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# key.data => accept; key.fileobj => sock")]),s._v("\n        callback "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data\n        callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fileobj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n\n\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);