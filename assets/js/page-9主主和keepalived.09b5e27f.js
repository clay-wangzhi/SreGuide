(window.webpackJsonp=window.webpackJsonp||[]).push([[208],{1159:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"_9-主主和keepalived"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-主主和keepalived"}},[s._v("#")]),s._v(" 9 主主和keepalived")]),s._v(" "),n("h2",{attrs:{id:"keepalived简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#keepalived简介"}},[s._v("#")]),s._v(" keepalived简介")]),s._v(" "),n("p",[s._v("keepalived是vrrp协议的实现，原生设计目的是为了高可用ipvs服务，keepalived能够配置文件中的定义生成ipvs规则，并能够对各RS的健康状态进行检测；通过共用的虚拟IP地址对外提供服务；每个热备组内同一时刻只有一台主服务器提供服务，其他服务器处于冗余状态，若当前在线的服务器宕机，其虚拟IP地址将会被其他服务器接替（优先级决定接替顺序），实现高可用为后端主机提供服务。")]),s._v(" "),n("p",[s._v("VRRP全称Virtual Router Redundancy Protocol，即"),n("a",{attrs:{href:"http://en.wikipedia.org/wiki/VRRP",target:"_blank",rel:"noopener noreferrer"}},[s._v("虚拟路由冗余协议"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("p",[s._v("虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据"),n("a",{attrs:{href:"http://tools.ietf.org/html/rfc5798#section-5.1",target:"_blank",rel:"noopener noreferrer"}},[s._v("VRRP的优先级"),n("OutboundLink")],1),s._v("来"),n("a",{attrs:{href:"http://en.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol#Elections_of_master_routers",target:"_blank",rel:"noopener noreferrer"}},[s._v("选举一个backup当master"),n("OutboundLink")],1),s._v("。这样的话就可以保证路由器的高可用了。")]),s._v(" "),n("h2",{attrs:{id:"keepalived组件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#keepalived组件"}},[s._v("#")]),s._v(" keepalived组件")]),s._v(" "),n("p",[s._v("Keepalived组件介绍")]),s._v(" "),n("p",[n("img",{attrs:{src:a(632),alt:"wKiom1gVgVqxP0nVAADi2pjRuog301.png"}})]),s._v(" "),n("ul",[n("li",[n("p",[s._v("core：keepalived核心组件，主进程的启动和维护，全局配置等。")])]),s._v(" "),n("li",[n("p",[s._v("vrrp stack：keepalived是基于vrrp协议实现高可用vps服务，vrrp则为相关子进程为其提供服务")])]),s._v(" "),n("li",[n("p",[s._v("check：检测keepalived的健康状态相关进程")])]),s._v(" "),n("li",[n("p",[s._v("system call:系统调用")]),s._v(" "),n("p",[s._v("watch dog:监控check和vrrp进程的看管者，check负责检测器子进程的健康状态，当其检测到master上的服务不可用时则通告vrrp将其转移至backup服务器上。")])])]),s._v(" "),n("h2",{attrs:{id:"mysql主主搭建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mysql主主搭建"}},[s._v("#")]),s._v(" mysql主主搭建")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("下载二进制bin文件")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://clay-wangzhi.com/mysql-download/mysql-boost-5.7.20-bin.tar.gz\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" mysql-boost-5.7.20-bin.tar.gz /opt/software/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("下载roles")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone -b dev-clay https://github.com/clay-wangzhi/Ansible-roles.git\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -r Ansible-roles/mysql57/ /etc/ansible/roles/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("编写playbook执行")]),s._v(" "),n("p",[n("code",[s._v("cat /etc/ansible/playbooks/mysql_replication_ga.yml")])]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.xx.xx.47\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql57'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'master'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rep_47'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.xx.xx.48\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql57'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'master'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rep_48'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.xx.xx.47\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql57'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_auto_increment_offset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_auto_increment_increment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定为slave角色")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_master")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'172.xx.xx.48'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_master_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rep_48'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.xx.xx.48\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql57'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_auto_increment_offset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_auto_increment_increment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定为slave角色")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_master")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'172.xx.xx.47'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_master_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql57_replication_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rep_47'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("p",[s._v("执行playbook")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("ansible-playbook mysql_replication_ga.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])])])}),[],!1,null,null,null);t.default=e.exports},632:function(s,t,a){s.exports=a.p+"assets/img/wKiom1gVgVqxP0nVAADi2pjRuog301.6d7b7a18.png"}}]);