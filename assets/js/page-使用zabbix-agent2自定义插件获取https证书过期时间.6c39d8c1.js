(window.webpackJsonp=window.webpackJsonp||[]).push([[315],{1248:function(s,n,a){"use strict";a.r(n);var e=a(1),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用zabbix-agent2自定义插件获取https证书过期时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用zabbix-agent2自定义插件获取https证书过期时间"}},[s._v("#")]),s._v(" 使用zabbix-agent2自定义插件获取https证书过期时间")]),s._v(" "),a("blockquote",[a("p",[s._v("转载自: "),a("a",{attrs:{href:"https://mp.weixin.qq.com/s/Sw0WubPH7luEY_kaVsoPkg",target:"_blank",rel:"noopener noreferrer"}},[s._v("公众号运维开发故事 | wanger"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"需求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[s._v("#")]),s._v(" 需求")]),s._v(" "),a("p",[s._v("对经常维护网站的人来说，要经常跟https的证书打交道。一般https证书的有效期是一年，证书一旦过期，公司的损失会非常大。去年网易邮箱因为https证书忘记续期，导致大量用户无法正常使用邮箱就是个典型案例。什么时候想起来才去手动查一下也不现实，最好的方法是把过期时间监控起来，距离一定期限自动发送通知。")]),s._v(" "),a("p",[s._v("可以使用Zabbix或者Prometheus的ssl_exporter来进行监控，在Zabbix4.4版本以前可以使用自定义脚本的方式，在Zabbix4.4之后出现了zabbix-agent2，除了官方自带的插件也可以通过自定义插件的方式来满足我们的监控需求。本文介绍如何使用zabbix-agent2自定义插件来实现获取https证书过期时间的需求。")]),s._v(" "),a("h2",{attrs:{id:"zabbix-agent2自定义https-expire插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zabbix-agent2自定义https-expire插件"}},[s._v("#")]),s._v(" zabbix-agent2自定义https_expire插件")]),s._v(" "),a("p",[s._v("之前介绍过如何"),a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI3NTQ1ODEyMQ==&mid=2247489848&idx=2&sn=7be7f66ba2c4dcc1e9c2c410dffea6d1&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用自定义插件来实现对mqtt的监控"),a("OutboundLink")],1),s._v("，只不过当时使用的Watcher接口来将新数据主动push给server端，这次将通过实现Exporter接口来采集数据，再次提供官方文档和Zabbix认证专家米宏翻译的"),a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI3NTQ1ODEyMQ==&mid=2247485564&idx=2&sn=e736e1c8f2dbb444bc0b9fbf786b75d5&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方博文"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("p",[s._v("这里我再介绍一下自定义插件的一些标准规范")]),s._v(" "),a("p",[s._v("１.　插件必须导入"),a("code",[s._v("zabbix.com/pkg/plugin")]),s._v("软件包。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import "zabbix.com/pkg/plugin"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2.　插件必须定义结构并嵌入该"),a("code",[s._v("plugin.Base")]),s._v("结构。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("type Plugin struct {\n    plugin.Base\n}\nvar impl Plugin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("3.　一个插件必须实现一个或多个插件接口。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('func (p *Plugin) Export(key string, params []string, ctx plugin.ContextProvider) (result interface{}, err error) {\n    if len(params) > 0 {\n        p.Debugf("received %d parameters while expected none", len(params))\n        return nil, errors.New("Too many parameters")\n    }\n    return time.Now().Format(time.RFC3339)\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("4.　插件必须在初始化期间注册自己。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('func init() {\n    plugin.RegisterMetrics(&impl, "Time", "system.time", "Returns time string in RFC 3999 format.")\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("ssl_expire代码不多，插件由尼古拉·拖拉基斯基·王二编写，完整代码可以去github查看")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('func (p *Plugin) Configure(global *plugin.GlobalOptions, options interface{}) {\n if err = conf.Unmarshal(options, &p.options); err != nil {\n  p.Errf("cannot unmarshal configuration options: %s", err)\n }\n\n if p.options.Timeout == 0 {\n  p.options.Timeout = global.Timeout\n }\n p.client = newClient(p.options.Timeout)\n\n}\n\nfunc (p *Plugin) Validate(options interface{}) error {\n\n return conf.Unmarshal(options, &opts)\n}\n\nfunc checkParamnums(params []string) error {\n if len(params) > paramnums {\n  err:=errors.New("Too many parameters.")\n  return zbxerr.ErrorTooFewParameters.Wrap(err)\n } else if len(params) ==0 {\n  err:=errors.New("Missing URL parameters.")\n  return zbxerr.ErrorTooFewParameters.Wrap(err)\n }\n return nil\n}\n\nfunc checkParams(params []string) (string, error) {\n if strings.HasPrefix(params[0], "http://") {\n  errorsting:=fmt.Sprintf("Target is using http scheme: %s", params[0])\n  err:=errors.New(errorsting)\n  return "",zbxerr.ErrorInvalidParams.Wrap(err)\n }\n\n if !strings.HasPrefix(params[0], "https://") {\n  params[0] = "https://" + params[0]\n }\n return string(params[0]),nil\n}\nfunc (cli *client) Query(url string) (int64, error) {\n resp, err := cli.client.Get(url)\n if err != nil {\n  impl.Debugf("cannot fetch data: %s", err)\n  err:=errors.New("cannot fetch data")\n  return 0, zbxerr.ErrorCannotFetchData.Wrap(err)\n }\n defer resp.Body.Close()\n certInfo:=resp.TLS.PeerCertificates[0]\n expiredays:=(certInfo.NotAfter.Unix()-time.Now().Unix())/60/60/24\n return expiredays,nil\n}\n\n// Export implements the Exporter interface.\nfunc (p *Plugin) Export(key string, params []string, ctx plugin.ContextProvider) (interface{}, error) {\n if err = checkParamnums(params); err != nil {\n  return nil, err\n }\n urls,err:= checkParams(params)\n if err!= nil {\n  return nil,err\n }\n body, err := p.client.Query(urls)\n if err!=nil{\n  return nil, err\n }\n return body,nil\n\n}\nfunc init() {\n plugin.RegisterMetrics(&impl, pluginName,\n  "https_expire", "Returns the number of days between the HTTPS certificate expiration time and the current date.")\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br")])]),a("h2",{attrs:{id:"下载zabbix-agent2源码并将自定义插件编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载zabbix-agent2源码并将自定义插件编译"}},[s._v("#")]),s._v(" 下载zabbix agent2源码并将自定义插件编译")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum install golang\ngit clone https://git.zabbix.com/scm/zbx/zabbix.git --depth 1 zabbix-agent2\ncd zabbix-agent2\ngit submodule add https://github.com/cxf210/ssl_expire.git src/go/plugins/https_expire\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"导入https-expire插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#导入https-expire插件"}},[s._v("#")]),s._v(" 导入https_expire插件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vi src/go/plugins/plugins_linux.go\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("添加最后一行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('        _ "zabbix.com/plugins/ceph"\n        _ "zabbix.com/plugins/docker"\n        _ "zabbix.com/plugins/kernel"\n        _ "zabbix.com/plugins/log"\n        _ "zabbix.com/plugins/memcached"\n        _ "zabbix.com/plugins/modbus"\n        _ "zabbix.com/plugins/mqtt"\n        _ "zabbix.com/plugins/mysql"\n        _ "zabbix.com/plugins/net/netif"\n        _ "zabbix.com/plugins/net/tcp"\n        ...\n        _ "zabbix.com/plugins/https_expire"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"编译安装zabbix-agent2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译安装zabbix-agent2"}},[s._v("#")]),s._v(" 编译安装zabbix agent2")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum install automake autoconf pcre* -y\n./bootstrap.sh \npushd . \ncd src/go/ \ngo mod vendor \npopd \n./configure --enable-agent2 --enable-static \nmake install\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"编辑配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编辑配置文件"}},[s._v("#")]),s._v(" 编辑配置文件")]),s._v(" "),a("p",[s._v("这里我调整了日志级别，方便前台调试 可选参数 Plugins.Https_expire.Timeout = 5")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('egrep -v "^$|^#" conf/zabbix_agent2.conf  \nLogType=console\nLogFile=/tmp/zabbix_agent2.log\nDebugLevel=4\nServer=172.17.0.5\nPlugins.Https_expire.Timeout=5\nHostname=node2\nControlSocket=/tmp/agent.sock\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"启动zabbix-agent2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动zabbix-agent2"}},[s._v("#")]),s._v(" 启动Zabbix_agent2")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("cd /root/zabbix_agent/src/go/bin\nzabbix_agent2 -c conf/zabbix_agent2.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/agent21.png",alt:"图片"}})]),s._v(" "),a("h2",{attrs:{id:"zabbix创建监控项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zabbix创建监控项"}},[s._v("#")]),s._v(" Zabbix创建监控项")]),s._v(" "),a("p",[s._v("键值示例如下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('https_expire["www.xyzabbix.cn"]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('https_expire["https://www.xyzabbix.cn"]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/agent22.png",alt:"图片"}})]),s._v(" "),a("p",[s._v("查看最新数据，这个证书还有四十天过期")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/agent23.png",alt:"图片"}})]),s._v(" "),a("p",[s._v("我是用的阿里云ssl证书，可以看到确实离过期时间还有四十天，今天是2021.3.7")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/agent24.png",alt:"图片"}})]),s._v(" "),a("p",[s._v("可以创建一个触发器，在还有一个月的时候发送报警通知。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/agent25.png",alt:"图片"}})])])}),[],!1,null,null,null);n.default=t.exports}}]);