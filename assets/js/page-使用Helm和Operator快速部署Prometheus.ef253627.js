(window.webpackJsonp=window.webpackJsonp||[]).push([[289],{993:function(e,s,a){"use strict";a.r(s);var t=a(1),r=Object(t.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"使用-helm-和-operator-快速部署-prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-helm-和-operator-快速部署-prometheus"}},[e._v("#")]),e._v(" 使用 Helm 和 Operator 快速部署 Prometheus")]),e._v(" "),a("p",[e._v("随着"),a("code",[e._v("heapster")]),e._v("项目停止更新并慢慢被"),a("code",[e._v("metrics-server")]),e._v("取代，集群监控这项任务也将最终转移。"),a("code",[e._v("prometheus")]),e._v("的监控理念、数据结构设计其实相当精简，包括其非常灵活的查询语言；但是对于初学者来说，想要在k8s集群中实践搭建一套相对可用的部署却比较麻烦，由此还产生了不少专门的项目（如："),a("a",{attrs:{href:"https://github.com/coreos/prometheus-operator",target:"_blank",rel:"noopener noreferrer"}},[e._v("prometheus-operator"),a("OutboundLink")],1),e._v("）。")]),e._v(" "),a("p",[a("code",[e._v("Helm")]),e._v("致力于成为k8s集群的应用包管理工具，希望像linux 系统的"),a("code",[e._v("RPM")]),e._v(" "),a("code",[e._v("DPKG")]),e._v("那样成功；确实在k8s上部署复杂一点的应用很麻烦，需要管理很多yaml文件（configmap,controller,service,rbac,pv,pvc等等），而helm能够整齐管理这些文档：版本控制，参数化安装，方便的打包与分享等。")]),e._v(" "),a("ul",[a("li",[e._v("建议积累一定k8s经验以后再去使用helm；对于初学者来说手工去配置那些yaml文件对于快速学习k8s的设计理念和运行原理非常有帮助，而不是直接去使用helm，面对又一层封装与复杂度。")])]),e._v(" "),a("p",[e._v("Operator 用于管理 Kubernetes 的有状态分布式应用。")]),e._v(" "),a("h2",{attrs:{id:"安装-helm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-helm"}},[e._v("#")]),e._v(" 安装 Helm")]),e._v(" "),a("p",[e._v("在官方repo下载"),a("a",{attrs:{href:"https://github.com/helm/helm/releases",target:"_blank",rel:"noopener noreferrer"}},[e._v("release版本"),a("OutboundLink")],1),e._v("中自带的二进制文件即可（以Linux amd64为例）")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("wget")]),e._v(" https://get.helm.sh/helm-v3.6.1-linux-amd64.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("tar")]),e._v(" -xvf helm-v3.6.1-linux-amd64.tar.gz \n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("mv")]),e._v(" ./linux-amd64/helm /usr/bin\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("ul",[a("li",[e._v("启用官方 charts 仓库")])]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" stable https://charts.helm.sh/stable\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备"}},[e._v("#")]),e._v(" 准备")]),e._v(" "),a("p",[e._v("创建名称空间")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl create ns monitoring\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("下载镜像源")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("helm pull stable/prometheus-operator\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("解压")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("tar -xvf prometheus-operator-9.3.2.tgz\nrm -f prometheus-operator-9.3.2.tgz\ncd prometheus-operator/\ncp values.yaml{,.bak}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("修改一些参数"),a("code",[e._v("vim values.yaml")])]),e._v(" "),a("ul",[a("li",[a("p",[e._v("修改ControllerManager")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721111652787.png",alt:"image-20200721111652787"}})])]),e._v(" "),a("li",[a("p",[e._v("修改etcd，增加证书认证")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl create secret generic etcd-certs -n monitoring --from-file=/etc/kubernetes/ssl/ca.pem --from-file=/etc/kubernetes/ssl/kubernetes-key.pem --from-file=/etc/kubernetes/ssl/kubernetes.pem\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721112626079.png",alt:"image-20200721112626079"}})]),e._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721112701363.png",alt:"image-20200721112701363"}})])]),e._v(" "),a("li",[a("p",[e._v("修改Scheduler")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721112954847.png",alt:"image-20200721112954847"}})])]),e._v(" "),a("li",[a("p",[e._v("修改Proxy")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-2020072111314751.png",alt:"image-20200721113147517"}})])]),e._v(" "),a("li",[a("p",[e._v("暴露服务，将"),a("code",[e._v("grafana、prometheus、alertmanager")]),e._v("中service的暴露方式改为"),a("code",[e._v("NodePort")])]),e._v(" "),a("p",[a("code",[e._v("prometheus、alertmanager")]),e._v("，找到service 的type改为NodePort即可")]),e._v(" "),a("p",[a("code",[e._v("grafana")]),e._v("，找到service后，新增以下两行")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    type: NodePort\n    nodePort: 30524\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])])])]),e._v(" "),a("h2",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[e._v("#")]),e._v(" 安装")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("helm install  prometheus-operator --namespace=monitoring ./\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("查找 grafana admin 账户密码")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('kubectl get secret --namespace monitoring  prometheus-operator-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"验证安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证安装"}},[e._v("#")]),e._v(" 验证安装")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# 查看相关pod和svc\n$ kubectl get pod,svc -n monitoring \nNAME                                                          READY   STATUS    RESTARTS   AGE\npod/alertmanager-prometheus-operator-alertmanager-0           2/2     Running   0          5m54s\npod/prometheus-operator-grafana-7769fc4f77-2wpxk              2/2     Running   0          10m\npod/prometheus-operator-kube-state-metrics-69fcc8d48c-vlxv6   1/1     Running   0          10m\npod/prometheus-operator-operator-c68d5d4cc-b2m77              2/2     Running   0          10m\npod/prometheus-operator-prometheus-node-exporter-gxmsp        1/1     Running   0          10m\npod/prometheus-operator-prometheus-node-exporter-jb9qm        1/1     Running   0          10m\npod/prometheus-operator-prometheus-node-exporter-ld4c4        1/1     Running   0          10m\npod/prometheus-operator-prometheus-node-exporter-tr2vg        1/1     Running   0          10m\npod/prometheus-operator-prometheus-node-exporter-x9ss4        1/1     Running   0          10m\npod/prometheus-operator-prometheus-node-exporter-xrg7s        1/1     Running   0          10m\npod/prometheus-prometheus-operator-prometheus-0               3/3     Running   1          5m44s\n\nNAME                                                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\nservice/alertmanager-operated                          ClusterIP   None            <none>        9093/TCP,9094/TCP,9094/UDP   5m54s\nservice/prometheus-operated                            ClusterIP   None            <none>        9090/TCP                     5m44s\nservice/prometheus-operator-alertmanager               NodePort    10.68.148.209   <none>        9093:30903/TCP               10m\nservice/prometheus-operator-grafana                    NodePort    10.68.154.126   <none>        80:30524/TCP                 10m\nservice/prometheus-operator-kube-state-metrics         ClusterIP   10.68.166.79    <none>        8080/TCP                     10m\nservice/prometheus-operator-operator                   ClusterIP   10.68.42.82     <none>        8080/TCP,443/TCP             10m\nservice/prometheus-operator-prometheus                 NodePort    10.68.2.85      <none>        9090:30090/TCP               10m\nservice/prometheus-operator-prometheus-node-exporter   ClusterIP   10.68.85.233    <none>        9100/TCP                     10m\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br"),a("span",{staticClass:"line-number"},[e._v("20")]),a("br"),a("span",{staticClass:"line-number"},[e._v("21")]),a("br"),a("span",{staticClass:"line-number"},[e._v("22")]),a("br"),a("span",{staticClass:"line-number"},[e._v("23")]),a("br"),a("span",{staticClass:"line-number"},[e._v("24")]),a("br")])]),a("ul",[a("li",[e._v("访问prometheus的web界面："),a("code",[e._v("http://$NodeIP:30090")])]),e._v(" "),a("li",[e._v("访问alertmanager的web界面："),a("code",[e._v("http://$NodeIP:30903")])]),e._v(" "),a("li",[e._v("访问grafana的web界面："),a("code",[e._v("http://$NodeIP:30524")]),e._v(" (默认用户密码 admin:prom-operator，可在web界面修改)")])]),e._v(" "),a("h2",{attrs:{id:"管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管理"}},[e._v("#")]),e._v(" 管理")]),e._v(" "),a("h2",{attrs:{id:"管理操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管理操作"}},[e._v("#")]),e._v(" 管理操作")]),e._v(" "),a("ul",[a("li",[e._v("升级（修改配置）：修改配置请在``等文件中进行，保存后执行：")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ helm upgrade prometheus-operator -n monitoring ./\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("ul",[a("li",[e._v("回退：具体可以参考"),a("code",[e._v("helm help rollback")]),e._v("文档")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# 查看历史找到版本号\n$ helm history prometheus-operator -n monitoring\n$ helm rollback prometheus-operator [REVISION] -n monitoring\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("ul",[a("li",[e._v("删除")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ helm delete prometheus-operator -n monitoring\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"增加钉钉告警"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#增加钉钉告警"}},[e._v("#")]),e._v(" 增加钉钉告警")]),e._v(" "),a("p",[e._v("使用 PrometheusAlert全家桶 进行钉钉告警")]),e._v(" "),a("blockquote",[a("p",[e._v("文档：https://feiyu563.gitbook.io/prometheusalert/")])]),e._v(" "),a("p",[e._v("自定义模板如下，如何自定义模板，详见文档：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('{{ $var := .externalURL}}{{ range $k,$v:=.alerts }}\n{{if eq $v.status "resolved"}}\n## [Prometheus恢复信息]({{$v.generatorURL}})\n\n> <font color="info">告警名称</font>：[{{$v.labels.alertname}}]({{$var}})\n\n> <font color="info">告警级别</font>：{{$v.labels.severity}}\n\n> <font color="info">当前状态</font>：{{$v.status}}\n\n> <font color="info">告警分组</font>：{{$v.labels.team}}\n\n> <font color="info">开始时间</font>：{{GetCSTtime $v.startsAt}}\n\n> <font color="info">结束时间</font>：{{GetCSTtime $v.endsAt}}\n\n> <font color="info">实例地址</font>：{{$v.labels.instance}}\n\n**{{$v.annotations.message}}**\n{{else}}\n## [ <font color="#FF0000">Prometheus告警信息</font>]({{$v.generatorURL}})\n> <font color="#FF0000">告警名称</font>：[{{$v.labels.alertname}}]({{$var}})\n\n> <font color="#FF0000">告警级别</font>：{{$v.labels.severity}}\n\n> <font color="#FF0000">当前状态</font>：{{$v.status}}\n\n> <font color="#FF0000">告警分组</font>：{{$v.labels.team}}\n\n> <font color="#FF0000">开始时间</font>：{{GetCSTtime $v.startsAt}}\n\n> <font color="#FF0000">实例地址</font>：{{$v.labels.instance}}\n\n{{$v.annotations.message}}\n{{end}}\n{{ end }}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br"),a("span",{staticClass:"line-number"},[e._v("20")]),a("br"),a("span",{staticClass:"line-number"},[e._v("21")]),a("br"),a("span",{staticClass:"line-number"},[e._v("22")]),a("br"),a("span",{staticClass:"line-number"},[e._v("23")]),a("br"),a("span",{staticClass:"line-number"},[e._v("24")]),a("br"),a("span",{staticClass:"line-number"},[e._v("25")]),a("br"),a("span",{staticClass:"line-number"},[e._v("26")]),a("br"),a("span",{staticClass:"line-number"},[e._v("27")]),a("br"),a("span",{staticClass:"line-number"},[e._v("28")]),a("br"),a("span",{staticClass:"line-number"},[e._v("29")]),a("br"),a("span",{staticClass:"line-number"},[e._v("30")]),a("br"),a("span",{staticClass:"line-number"},[e._v("31")]),a("br"),a("span",{staticClass:"line-number"},[e._v("32")]),a("br"),a("span",{staticClass:"line-number"},[e._v("33")]),a("br"),a("span",{staticClass:"line-number"},[e._v("34")]),a("br"),a("span",{staticClass:"line-number"},[e._v("35")]),a("br"),a("span",{staticClass:"line-number"},[e._v("36")]),a("br")])]),a("p",[e._v("跑通 PrometheusAlert 后，修改 values.yaml 配置文件")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20210713205650167.png",alt:"image-20210713205650167"}})]),e._v(" "),a("p",[e._v("注释掉一个etcd alert rules "),a("code",[e._v("templates/prometheus/rules/etcd.yaml")]),e._v("和"),a("code",[e._v("templates/prometheus/rules-1.14/etcd.yaml")]),e._v("文件，不确定是误报还是bug，etcdHighNumberOfFailedGRPCRequests")]),e._v(" "),a("ul",[a("li",[e._v("升级")])]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ helm upgrade prometheus-operator -n monitoring ./\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);