(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{1245:function(s,n,a){"use strict";a.r(n);var e=a(1),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("由于我的"),a("code",[s._v("jenkins")]),s._v("和"),a("code",[s._v("ansible")]),s._v("没有安装在一台主机上，所以，现在利用"),a("code",[s._v("rsync+inotify")]),s._v("实现"),a("code",[s._v("jenkins")]),s._v("的工作目录，同步到"),a("code",[s._v("ansible")]),s._v("主机上")]),s._v(" "),a("p",[s._v("环境如下：")]),s._v(" "),a("p",[s._v("inotify-master IP :192.168.162.175")]),s._v(" "),a("p",[s._v("inotify-slave IP:192.168.162.119")]),s._v(" "),a("h2",{attrs:{id:"_1-inotify-slave部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-inotify-slave部署"}},[s._v("#")]),s._v(" 1 inotify slave部署")]),s._v(" "),a("h3",{attrs:{id:"_1-1-安装rsync"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-安装rsync"}},[s._v("#")]),s._v(" 1.1 安装rsync")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum install rsync –y\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1-2-添加用户和模块目录-并更改用户和组"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-添加用户和模块目录-并更改用户和组"}},[s._v("#")]),s._v(" 1.2  添加用户和模块目录，并更改用户和组")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("useradd rsync –s /sbin/nologin –M\nmkdir -p /var/lib/jenkins/workspace\nchown rsync.rsync /var/lib/jenkins/workspace\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_1-3-修改配置文件-etc-rsyncd-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-修改配置文件-etc-rsyncd-conf"}},[s._v("#")]),s._v(" 1.3 修改配置文件"),a("code",[s._v("/etc/rsyncd.conf")])]),s._v(" "),a("p",[s._v("内容如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# egrep -v "^#|^$" /etc/rsyncd.conf\nuid = rsync\ngid = rsync\nuse chroot = no\nmax connections = 200\ntimeout = 300\nfake super = yes \npid file = /var/run/rsyncd.pid\nlock file = /var/run/rsync.lock\nlog file = /var/log/rsyncd.log\nignore errors\nread only = false\nlist = false\nhosts allow = 192.168.162.0/24\nauth users = rsync_backup\nsecrets file = /etc/rsync.password\n[jenkinsbackup]\ncomment = "jenkinsbackup dir by clay"\npath = /var/lib/jenkins/workspace\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"_1-4-配置虚拟用户的密码文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-配置虚拟用户的密码文件"}},[s._v("#")]),s._v(" 1.4 配置虚拟用户的密码文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# cat rsync.password \nrsync_backup:clay123\n# chmod 600 /etc/rsync.password \n# rsync --daemon\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"_2-inotify-master部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-inotify-master部署"}},[s._v("#")]),s._v(" 2 inotify master部署")]),s._v(" "),a("h3",{attrs:{id:"_2-1-安装inotify-3-14"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-安装inotify-3-14"}},[s._v("#")]),s._v(" 2.1 安装inotify 3.14")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# cd /opt\n# wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz\n# tar zxf inotify-tools-3.14.tar.gz\n# cd inotify-tools-3.14\n# ./configure --prefix=/usr/local/inotify\n# make && sudo make install\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"_2-2-创建rsync服务的密码文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-创建rsync服务的密码文件"}},[s._v("#")]),s._v(" 2.2 创建rsync服务的密码文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# cat /etc/rsync.password \nclay123\n# chmod 600 /etc/rsync.password\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_2-3-编写执行脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-编写执行脚本"}},[s._v("#")]),s._v(" 2.3 编写执行脚本")]),s._v(" "),a("p",[a("code",[s._v("vim /usr/local/inotify.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#!/bin/bash\nHOST=192.168.162.119\nSRC=/var/lib/jenkins/workspace\nDEST=jenkinsbackup\nUSER=rsync_backup\nRSYNC_PASSFILE=/etc/rsync.password\nINOTIFY_HMOE=/usr/local/inotify\n\nif [ ! -e "${SRC}" ] \\\n  || [ ! -e "${RSYNC_PASSFILE}" ] \\\n  || [ ! -e "${INOTIFY_HMOE}/bin/inotifywait" ] \\\n  || [ ! -e "/usr/bin/rsync" ]; then\n  echo "Check File and Folder"\n  exit 1\nfi\n\n${INOTIFY_HMOE}/bin/inotifywait -mrq --timefmt \'%d/%m/%y %H:%M\' \\\n  --format \'%T %w%f\' -e close_write,delete,create,attrib ${SRC} \\\n  | while read file; do\n  cd ${SRC}\n  rsync -aruz -R --delete ./  --timeout=100 ${USER}@${HOST}::${DEST} \\\n    --password-file=${RSYNC_PASSFILE} >/dev/null 2>&1\ndone\nexit 0\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h3",{attrs:{id:"_2-4-将脚本加入后台执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-将脚本加入后台执行"}},[s._v("#")]),s._v(" 2.4 将脚本加入后台执行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# sh inotify.sh &\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v("主要参考链接：https://www.cnblogs.com/jefflee168/p/6795201.html")]),s._v(" "),a("p",[s._v("补充链接：https://www.cnblogs.com/clsn/p/7707822.html")])])])}),[],!1,null,null,null);n.default=t.exports}}]);