(window.webpackJsonp=window.webpackJsonp||[]).push([[272],{1228:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"elk借助安装ansible"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#elk借助安装ansible"}},[s._v("#")]),s._v(" elk借助安装ansible")]),s._v(" "),n("h2",{attrs:{id:"ansible配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ansible配置"}},[s._v("#")]),s._v(" ansible配置")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改主机名")]),s._v("\nhostnamectl set-hostname elk_ans\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生产密钥对，生成后将公钥导入到私有云主机中，创建新主机时使用")]),s._v("\nssh-keygen -t rsa -f ~/.ssh/id_rsa -N "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum 安装")]),s._v("\nyum -y "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ansible\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改主机列表为yaml格式")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /etc/ansible/hosts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(",.yml"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优化配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/ansible/ansible.cfg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(",.bak"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/ansible.cfg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[defaults]\ninventory      = /etc/ansible/hosts.yml\nroles_path    = /etc/ansible/roles\nhost_key_checking = False\ndeprecation_warnings = False\nretry_files_enabled = False\n[inventory]\n[privilege_escalation]\n[paramiko_connection]\n[ssh_connection]\nssh_args = -C -o ControlMaster=auto -o ControlPersist=5d\n[persistent_connection]\n[accelerate]\n[selinux]\n[colors]\n[diff]\nEOF")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编写ansible主机清单")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_master1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.125 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_master2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.214 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_master3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.62 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_data1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.160 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_data2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.73 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_data3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.105 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_ingest1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.8 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_ingest2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.187 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("es_ingest3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.189 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kibana1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.178 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kibana2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.196 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kibana3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.198 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logstash1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.89 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logstash2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.30 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logstash3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.96 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kafka1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.32 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kafka2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.22 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kafka3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".135.51\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/hosts.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nall:\n  children:\n    elasticsearch:\n      children:\n        es_master:\n        es_data:\n        es_ingest:\n    es_master:\n      hosts:\n        es_master1:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_master1}")]),s._v("\n        es_master2:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_master2}")]),s._v("\n        es_master3:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_master3}")]),s._v("\n    es_data:\n      hosts:\n        es_data1:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_data1}")]),s._v("\n        es_data2:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_data2}")]),s._v("\n        es_data3:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_data3}")]),s._v("\n    es_ingest:\n      hosts:\n        es_ingest1:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_ingest1}")]),s._v("\n        es_ingest2:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_ingest2}")]),s._v("\n        es_ingest3:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${es_ingest3}")]),s._v("\n    kibana:\n      hosts:\n        kibana1:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${kibana1}")]),s._v("\n        kibana2:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${kibana2}")]),s._v("\n        kibana3:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${kibana3}")]),s._v("\n    logstash:\n      hosts:\n        logstash1:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${logstash1}")]),s._v("\n        logstash2:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${logstash2}")]),s._v("\n        logstash3:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${logstash3}")]),s._v("\n    kafka:\n      hosts:\n        kafka1:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${kafka1}")]),s._v("\n          zookeeper_id: 1\n        kafka2:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${kafka2}")]),s._v("\n          zookeeper_id: 2\n        kafka3:\n          ansible_host: "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${kafka3}")]),s._v("\n          zookeeper_id: 3\nEOF")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 镜像yum源有问题得，替换下yum源")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" clay_wangzhi.sysinit\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/ansible/playbooks/vars\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/sysinit.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n---\n- hosts: all\n  roles:\n    - clay_wangzhi.sysinit\nEOF")]),s._v("\nansible all -m shell -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rm -rf /etc/yum.repos.d/bak/"')]),s._v("\nansible-playbook /etc/ansible/playbooks/sysinit.yml --tags upgrade_repo\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h2",{attrs:{id:"安装-elasticsearch"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-elasticsearch"}},[s._v("#")]),s._v(" 安装 Elasticsearch")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载roles")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" elastic.elasticsearch,v7.11.2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编写playbook")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/elasticsearch.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n---\n# 注意修改yum源为清华源\n- hosts: es_master\n  roles:\n    - role: elastic.elasticsearch\n  vars:\n    node_master: true\n    node_data: false\n  vars_files:\n    - vars/es_vars.yml\n\n- hosts: es_data\n  roles:\n    - role: elastic.elasticsearch\n  vars:\n    node_master: false\n    node_data: true\n  vars_files:\n    - vars/es_vars.yml\n\n- hosts: es_ingest\n  roles:\n    - role: elastic.elasticsearch\n  vars:\n    node_master: false\n    node_data: false\n  vars_files:\n    - vars/es_vars.yml\nEOF")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新增var_files")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/vars/es_vars.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nes_heap_size: "4g"\nes_api_host: "{{ansible_ssh_host}}"\nes_data_dirs:\n  - "/opt/elasticsearch/data"\nes_log_dir: "/opt/elasticsearch/logs"\nes_config:\n  cluster.name: "suncar-es"\n  node.name: "{{inventory_hostname}}"\n  network.host: "{{ansible_ssh_host}}"\n  cluster.initial_master_nodes: \'["{{hostvars[groups["es_master"][0]].ansible_host}}"{% for host in groups["es_master"][1:] %}, "{{hostvars[host].ansible_host}}"{% endfor %}]\'\n  discovery.seed_hosts: \'["{{hostvars[groups["es_master"][0]].ansible_host}}:9300"{% for host in groups["es_master"][1:] %}, "{{hostvars[host].ansible_host}}:9300"{% endfor %}]\'\n  http.port: 9200\n  node.master: "{{node_master}}"\n  node.data: "{{node_data}}"\n  bootstrap.memory_lock: true\n  gateway.recover_after_nodes: 2\n  xpack.monitoring.collection.enabled: true\n  http.cors.enabled: true\n  http.cors.allow-origin: "*"\nEOF')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改roles文件，修改yum源为清华源")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/roles/elastic.elasticsearch/templates/elasticsearch.repo "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[elasticsearch-7.x]\nname=Elasticsearch repository for 7.x packages\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/\ngpgcheck=0\nenabled=1\nEOF")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改es yml配置文件,将安全功能开启，并自己设置密码")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/ansible/roles/elastic.elasticsearch/templates/elasticsearch.yml.j2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("{% if es_enable_xpack and es_api_basic_auth_username is defined and es_api_basic_auth_password is defined %}   #将这一行改为下面\n{% if not oss_version %}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("blockquote",[n("p",[s._v("执行playbook前，首先要进行数据磁盘的挂载，挂载到数据目录，es数据节点磁盘占用很大")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nansible-playbook /etc/ansible/playbooks/elasticsearch.yml \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible安装完成后，初始化es通信的密码，在任意es_master1节点执行")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("JAVA_HOME")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/share/elasticsearch/jdk/\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/share/elasticsearch/\nbin/elasticsearch-setup-passwords interactive\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("strong",[s._v("配置Node间SSL")])]),s._v(" "),n("p",[s._v("注意：这里是指配置ES集群节点间transport的SSL认证，对于ES节点的HTTP API接口并没有配置，所以通过API访问ES时不需要提供证书。")]),s._v(" "),n("p",[s._v("参考官网:")]),s._v(" "),n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/ssl-tls.html")]),s._v(" "),n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/7.4/configuring-tls.html")]),s._v(" "),n("p",[s._v("创建SSL/TLS证书：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/share/elasticsearch/bin\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("JAVA_HOME")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/share/elasticsearch/jdk/\n./elasticsearch-certutil ca -v   //一路回车\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12  //一路回车\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" elastic-* /etc/elasticsearch/\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/elasticsearch/\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" elasticsearch.elasticsearch *.p12\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("操作完成后，把证书传到剩余节点，修改剩余节点的配置文件，并重启")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将证书传到 ansible /tmp 目录下")]),s._v("\nansible elasticsearch -m copy -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"src=/tmp/elastic-certificates.p12 dest=/etc/elasticsearch/ owner=elasticsearch group=elasticsearch"')]),s._v(" \nansible elasticsearch -m copy -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"src=/tmp/elastic-stack-ca.p12 dest=/etc/elasticsearch/ owner=elasticsearch group=elasticsearch"')]),s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改/etc/elasticsearch/elasticsearch.yml 配置文件")]),s._v("\nansible elasticsearch -m lineinfile -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"path=/etc/elasticsearch/elasticsearch.yml line='xpack.security.transport.ssl.enabled: true"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("xpack.security.transport.ssl.verification_mode: certificate"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/elastic-certificates.p12"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/elastic-certificates.p12'\"")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启es")]),s._v("\nansible elasticsearch -m "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name=elasticsearch state=restarted"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("blockquote",[n("p",[s._v("在此过程中，所有节点必须全部更新完，否则之前的用户名和密码将会认证失败")]),s._v(" "),n("p",[s._v("更新完成之后，集群的健康检查为yellow，不要着急，等待它自己自动恢复成green，当es中数据较多时会出现")])]),s._v(" "),n("blockquote",[n("p",[s._v("Kibana，logstash，kafka的安装可以同时进行，提高效率")])]),s._v(" "),n("h2",{attrs:{id:"安装-kibana"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-kibana"}},[s._v("#")]),s._v(" 安装 Kibana")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载roles")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" clay_wangzhi.kibana\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编写playbook，根据实际情况，填写用户名，密码")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k_username")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("elastic "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k_pass")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("E"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2021")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/kibana.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n- hosts: kibana\n  roles:\n    - clay_wangzhi.kibana\n  vars:\n    kibana_version: "7.x"\n    kibana_dversion: "7.11.2"\n    kibana_server_host: "{{ansible_ssh_host}}"\n    kibana_server_name: "{{inventory_hostname}}"\n    kibana_elasticsearch_url: \'["http://{{hostvars[groups["es_ingest"][0]].ansible_host}}:9200"{% for host in groups["es_ingest"][1:] %}, "http://{{hostvars[host].ansible_host}}:9200"{% endfor %}]\'\n    kibana_elasticsearch_username: "'),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k_username}")]),s._v('"\n    kibana_elasticsearch_password: "'),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k_pass}")]),s._v('"\nEOF')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nansible-playbook /etc/ansible/playbooks/kibana.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("blockquote",[n("p",[s._v("TODO：Kibana7.11.x 版本具有告警功能，已经GA了，后续可以看一下")])]),s._v(" "),n("h2",{attrs:{id:"安装-logstash"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-logstash"}},[s._v("#")]),s._v(" 安装 logstash")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载roles")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" clay_wangzhi.logstash\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编写playbook，根据实际情况，填写用户名，密码")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("l_username")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("elastic "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("l_pass")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("E"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2021")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/logstash.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n- hosts: logstash\n  roles:\n    - clay_wangzhi.logstash\n  vars:\n    logstash_version: \'7.x\'\n    logstash_dversion: \'7.11.2\'\n    logstash_elasticsearch_hosts: \'["http://{{hostvars[groups["es_ingest"][0]].ansible_host}}:9200"{% for host in groups["es_ingest"][1:] %}, "http://{{hostvars[host].ansible_host}}:9200"{% endfor %}]\'\n    es_user: "'),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${l_username}")]),s._v('"\n    es_pass: "'),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${l_pass}")]),s._v('"\n    kafka_topic: "h5-jar"\n    kafka_group_id: "suncar-h5"\nEOF')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nansible-playbook /etc/ansible/playbooks/logstash.yml \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kafka 还未安装，先停止logstash")]),s._v("\nansible logstash -m "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name=logstash state=stopped"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("blockquote",[n("p",[s._v("TODO: logstash 的playbook后期有空，可以优化一下")])]),s._v(" "),n("h2",{attrs:{id:"安装-kafka"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-kafka"}},[s._v("#")]),s._v(" 安装 kafka")]),s._v(" "),n("p",[s._v("kafka集群依赖zookeeper，先安装zookeeper集群")]),s._v(" "),n("blockquote",[n("p",[s._v("由于下载源有问题，需要手工注释掉了下载的task，我事先把压缩包下载到了ansible控制节点，先传到各个客户端")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('ansible kafka -m copy -a "src=/tmp/zookeeper-3.4.14.tar.gz dest=/tmp/"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("p",[n("strong",[s._v("安装zookeeper")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载roles")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" clay_wangzhi.zookeeper\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编写playbook")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/zookeeper.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n---\n- hosts: kafka\n  roles:\n  - role: clay_wangzhi.zookeeper\n    zookeeper_version: 3.4.14\n    zookeeper_mirror: "https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper"\n    zookeeper_servers: "{{groups[\'kafka\']}}"\n    zookeeper_environment:\n      "JAVA_HOME": "/opt/jdk1.8.0_144"\nEOF')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nansible-playbook /etc/ansible/playbooks/zookeeper.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[n("strong",[s._v("安装kafka")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载roles")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" clay_wangzhi.kafka\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/kafka.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n---\n- hosts: kafka\n  roles:\n    - clay_wangzhi.kafka\nEOF")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("blockquote",[n("p",[s._v("执行playbook前，首先要进行数据磁盘的挂载，挂载到数据目录，kafka数据节点磁盘占用很大")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nansible-playbook /etc/ansible/playbooks/kafka.yml\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动logstash，上面停止了")]),s._v("\nansible logstash -m "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name=logstash state=started"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"安装-filebeat"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-filebeat"}},[s._v("#")]),s._v(" 安装 filebeat")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 添加filebeat主机到主机清单\n    filebeat:\n      hosts:\n        192.168.124.3:\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载roles")]),s._v("\nansible-galaxy "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" elastic.beats,v7.11.2\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编写playbook，beat_conf 请根据实际情况来填写")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/playbooks/filebeat.yml "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n---\n- hosts: filebeat\n  roles:\n    - elastic.beats\n  vars:\n    beat: filebeat\n    beat_conf:\n      filebeat:\n        inputs:\n          - type: log\n            enabled: true\n            paths:\n              - /home/ncar/service/webapps/logs/ShengDaGFHD/ShengDaGFHD.log\n            multiline.pattern: \'^[0-9]{4}-[0-9]{2}-[0-9]{2}\'\n            multiline.negate: true\n            multiline.match: after\n            tags: ["jar"]\n            fields:\n              type: h5-jar\n              ip: "{{inventory_hostname}}"\n              service_name: shengdasxgh\n      processors:\n        - drop_fields:\n            fields: ["agent", "ecs.version", "host.name"]\n    \n    output_conf:\n      kafka:\n        hosts: \'["{{hostvars[groups["kafka"][0]].ansible_host}}:9092"{% for host in groups["kafka"][1:] %}, "{{hostvars[host].ansible_host}}:9092"{% endfor %}]\'\n        topic: \'h5-jar\'\nEOF')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改roles文件，修改yum源为清华源")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ansible/roles/elastic.beats/templates/beats.repo.j2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[filebeat-7.x]\nname=Elasticsearch repository for 7.x packages\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/\ngpgcheck=0\nenabled=1\nEOF")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nansible-playbook /etc/ansible/playbooks/filebeat.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);