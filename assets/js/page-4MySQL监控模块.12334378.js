(window.webpackJsonp=window.webpackJsonp||[]).push([[147],{1178:function(s,a,e){"use strict";e.r(a);var t=e(1),r=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"_4-mysql监控模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-mysql监控模块"}},[s._v("#")]),s._v(" 4 MySQL监控模块")]),s._v(" "),e("blockquote",[e("p",[s._v("zabbix旧版本可以用，新版本建议用官方模板")])]),s._v(" "),e("h2",{attrs:{id:"template-db-mysql简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#template-db-mysql简介"}},[s._v("#")]),s._v(" Template DB MySQL简介")]),s._v(" "),e("h3",{attrs:{id:"应用集"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#应用集"}},[s._v("#")]),s._v(" 应用集")]),s._v(" "),e("p",[s._v("MySQL")]),s._v(" "),e("h3",{attrs:{id:"监控项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控项"}},[s._v("#")]),s._v(" 监控项")]),s._v(" "),e("ol",[e("li",[s._v("MySQL begin operations per second（MySQL每秒开始操作）")]),s._v(" "),e("li",[s._v("MySQL bytes received per second（从所有客户端接收的字节数）")]),s._v(" "),e("li",[s._v("MySQL bytes sent per second（发送到所有客户端的字节数）")]),s._v(" "),e("li",[s._v("MySQL commit operations per second（MySQL每秒提交操作）")]),s._v(" "),e("li",[s._v("MySQL delete operations per second（MySQL每秒删除操作）")]),s._v(" "),e("li",[s._v("MySQL insert operations per second（MySQL每秒插入操作）")]),s._v(" "),e("li",[s._v("MySQL queries per second（MySQL每秒查询）")]),s._v(" "),e("li",[s._v("MySQL rollback operations per second（MySQL每秒回滚操作）")]),s._v(" "),e("li",[s._v("MySQL select operations per second（MySQL每秒选择操作）")]),s._v(" "),e("li",[s._v("MySQL slow queries（MySQL慢查询）")]),s._v(" "),e("li",[s._v("MySQL status（MySQL的存活状态）")]),s._v(" "),e("li",[s._v("MySQL update operations per second（MySQL每秒更新操作）")]),s._v(" "),e("li",[s._v("MySQL uptime（MySQL正常运行时间）")]),s._v(" "),e("li",[s._v("MySQL version（MySQL的版本信息）")])]),s._v(" "),e("h3",{attrs:{id:"触发器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#触发器"}},[s._v("#")]),s._v(" 触发器")]),s._v(" "),e("p",[s._v("MySQL is down")]),s._v(" "),e("p",[s._v("表达式：{Template DB MySQL:mysql.ping.last(0)}=0")]),s._v(" "),e("h3",{attrs:{id:"图形"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#图形"}},[s._v("#")]),s._v(" 图形")]),s._v(" "),e("ol",[e("li",[s._v("MySQL operations（MySQL业务操作）")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/mysql图形1.png",alt:""}})]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("MySQL bandwidth（MySQL带宽）")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/mysql图形2.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"聚合图形"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#聚合图形"}},[s._v("#")]),s._v(" 聚合图形")]),s._v(" "),e("p",[s._v("MySQL performance（MySQL性能）")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/mysql图形3.png",alt:""}})]),s._v(" "),e("h2",{attrs:{id:"实现mysql模板监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现mysql模板监控"}},[s._v("#")]),s._v(" 实现MySQL模板监控")]),s._v(" "),e("h3",{attrs:{id:"mysql监控授权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mysql监控授权"}},[s._v("#")]),s._v(" MySQL监控授权")]),s._v(" "),e("p",[s._v("配置mysql的客户端，创建一个用户来获取mysql的相关数据，使用mysql账号密码登陆数据库")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("> grant all on *.* to monitor@'localhost' identified by 'W***';\n> flush privileges;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"修改zabbix-agent配置文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改zabbix-agent配置文件"}},[s._v("#")]),s._v(" 修改zabbix_agent配置文件")]),s._v(" "),e("ol",[e("li",[s._v("设置完帐户之后在被监控端新建/etc/zabbix/etc/.my.cnf以提供Zabbix Agent访问数据库，内容类似如下")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#vim /etc/zabbix/etc/.my.cnf\n[mysql]\nhost=localhost\nuser=monitor\npassword=W***\nsocket=/var/lib/mysql/mysql.sock\n[mysqladmin]\nhost=localhost\nuser=monitor\npassword=W***\nsocket=/var/lib/mysql/mysql.sock\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ul",[e("li",[s._v("注意：agent安装路径/etc/zabbix/,etc目录若不存在，需要自已创建，创建.my.cnf,为隐藏文件。W***为mysql的密码。")])]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("修改模板中的mysql路径/etc/zabbix/zabbix_agentd.d，将以下三个目录补全")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#vim userparameter_mysql.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/mysql配置.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"重启agent服务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#重启agent服务"}},[s._v("#")]),s._v(" 重启agent服务")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("service zabbix_agentd restart\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"zabbix-web设置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zabbix-web设置"}},[s._v("#")]),s._v(" zabbix-web设置")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/mysqlweb.png",alt:""}})]),s._v(" "),e("h2",{attrs:{id:"修改模板添加主从和连接数监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改模板添加主从和连接数监控"}},[s._v("#")]),s._v(" 修改模板添加主从和连接数监控")]),s._v(" "),e("h3",{attrs:{id:"主从状态监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从状态监控"}},[s._v("#")]),s._v(" 主从状态监控")]),s._v(" "),e("ol",[e("li",[s._v("在"),e("code",[s._v("/opt/monitor")]),s._v("目录下添加主从监控脚本")])]),s._v(" "),e("p",[s._v("vim mysql_slave.sh")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#!/usr/bin/env bash\nuser=\'monitor\'\npasswd=\n# Seconds_Behind_Master 阈值\ntho=1000\n\n# rs为Yes成功数,sbr为同步时间差\nrs=$(mysql -u"$user" -p"$passwd" -e "show slave status\\G;" 2>/dev/null | grep Running | awk \'{print $2}\' | grep -c Yes)\nsbr=$(mysql -u"$user" -p"$passwd" -e "show slave status\\G;" 2>/dev/null | grep Seconds_Behind_Master | awk -F\':\' \'{print $2}\')\n\n# 判断主从状态是否正常,0代表正常,1代表异常\nif [ "$rs" -eq 2 -a "$sbr" -le "$tho" ];then\n    echo 0\nelse\n    echo $(date +"%Y-%m-%d %H:%M:%S") "Yes成功数为$rs" "延时时间为$sbr" >> /var/log/zabbix/mysql_slave.log\n    echo 1\nfi\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("在zabbix_agentd.conf中添加自定义key")])]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("etc/zabbix/zabbix_agentd.conf")]),s._v("中新加")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("UserParameter=mysql.replication,/opt/monitor/mysql_slave.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("重启agent服务")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("service zabbix_agentd restart\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("在mysql模板中新增监控项，新增触发器，返回值不是0时，报警。")])]),s._v(" "),e("ul",[e("li",[s._v("注意：当监控非主从mysql时，把此项监控禁用掉")])]),s._v(" "),e("h2",{attrs:{id:"连接数监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#连接数监控"}},[s._v("#")]),s._v(" 连接数监控")]),s._v(" "),e("ol",[e("li",[s._v("在zabbix_agentd.conf中添加自定义key")])]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("etc/zabbix/zabbix_agentd.conf")]),s._v("中新加")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("UserParameter=mysql.linknum, ss -an | grep 3306 | grep -c ESTAB\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("重启agent服务")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("service zabbix_agentd restart\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("添加监控项和触发器")])])])}),[],!1,null,null,null);a.default=r.exports}}]);