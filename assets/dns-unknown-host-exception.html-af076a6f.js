import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as a,c as s,e}from"./app-7187cc90.js";const c={},i=e(`<h1 id="高并发下报错-java-net-unknownhostexception-案例分析" tabindex="-1"><a class="header-anchor" href="#高并发下报错-java-net-unknownhostexception-案例分析" aria-hidden="true">#</a> 高并发下报错 &quot;java.net.UnknownHostException&quot; 案例分析</h1><h2 id="流量走向" tabindex="-1"><a class="header-anchor" href="#流量走向" aria-hidden="true">#</a> 流量走向</h2><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118194858350.png" alt=""></p><h2 id="错误日志" tabindex="-1"><a class="header-anchor" href="#错误日志" aria-hidden="true">#</a> 错误日志</h2><p><strong>Client 报错</strong></p><p>应用的报错日志为：<code>java.net.UnknownHostException:</code></p><p><strong>代理服务报错</strong></p><p>查看 <code>Nginx</code> 的 <code>access</code> 、 <code>error</code> 日志</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">tail</span> <span class="token parameter variable">-f</span> xxx_dns_error.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118193148851.png" alt=""></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">tail</span> <span class="token parameter variable">-f</span> stream-test-udp-dns_access.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;$5!=200&#39;</span>
<span class="token comment"># 无异常</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看操作系统日志</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>journalctl <span class="token parameter variable">-f</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118193436883.png" alt=""></p><p><strong>DNS 服务端报错</strong>： 无</p><h2 id="分析" tabindex="-1"><a class="header-anchor" href="#分析" aria-hidden="true">#</a> 分析</h2><p>错误关键词 <code>Operation not permitted</code>、<code>nf_conntrack: table full, dropping packet</code>，问题出现在 代理层，<code>conntrack table</code>满了。</p><p>查看当前 <code>nf_conntrack_count</code> 和 <code>nf_conntrack_max</code> 值</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sysctl</span> net.netfilter.nf_conntrack_count
<span class="token function">sysctl</span> net.netfilter.nf_conntrack_max
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118194015232.png" alt=""></p><p>确实满了， 调大呗，每次增加50% ，观察一下，直至有空闲</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 在 /etc/sysctl.conf 文件中新增一行</span>
<span class="token assign-left variable">net.netfilter.nf_conntrack_max</span><span class="token operator">=</span><span class="token punctuation">[</span>新的值<span class="token punctuation">]</span>
<span class="token comment"># 应用</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调整完后，再次查看相关日志，发现系统日志无新报错，但是 <code>Nginx</code> 的 <code>access</code> 、 <code>error</code> 日志有新的报错，接着盘他，报错如下：</p><p><code>error</code> 日志</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118195505182.png" alt=""></p><p><code>access</code> 日志</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118195648741.png" alt=""></p><h2 id="再分析" tabindex="-1"><a class="header-anchor" href="#再分析" aria-hidden="true">#</a> 再分析</h2><p>错误关键词<code>Resource temporarily unavailable</code>，给的不具体啊，一步步排查吧</p><p><strong>检查系统资源限制</strong>：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 文件描述符限制</span>
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span>
<span class="token function">sysctl</span> fs.file-max
<span class="token comment"># 查看已使用的文件描述符数量,这个文件显示了三个值：当前打开的文件描述符数、分配的文件描述符数（一般为0），以及系统允许的文件描述符最大值。</span>
<span class="token function">cat</span> /proc/sys/fs/file-nr

<span class="token comment"># 检查进程或线程限制</span>
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-u</span>
<span class="token function">cat</span> /etc/security/limits.conf
<span class="token function">cat</span> /etc/security/limits.d/20-nproc.conf
<span class="token function">cat</span> /proc/sys/kernel/pid_max
<span class="token function">cat</span> /proc/sys/kernel/threads-max

<span class="token comment"># 查看当前线程数</span>
<span class="token function">ps</span> <span class="token parameter variable">-eLf</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上检查均正常。</p><p><strong>检查网络问题</strong></p><p>因为是 UDP 协议，所以 全连接（<code>net.core.somaxconn</code>）、半连接（<code>net.ipv4.tcp_max_syn_backlog</code>）、应用 backlog 可以忽略</p><p>查看 本地端口范围限制：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sysctl</span> net.ipv4.ip_local_port_range
<span class="token comment"># 结果为默认配置：net.ipv4.ip_local_port_range = 32768	60999</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看观察当前 UDP 连接数：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">watch</span> <span class="token parameter variable">-n</span> <span class="token number">0.5</span> <span class="token string">&quot;ss -s | grep -i udp&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>观察了一会，发现接近 28232 ，又满了，emo了</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241118202020493.png" alt=""></p><p>再调大呗。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 在 /etc/sysctl.conf 文件中新增一行</span>
<span class="token assign-left variable">net.ipv4.ip_local_port_range</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token number">65535</span>
<span class="token comment"># 应用</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调整完后，再次观察，应用日志、系统日志，网络均正常， 客户端访问不再报错。</p><p>Nice~~</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结：</h2><p>本次高并发下，调整了两个内核参数： <code>net.netfilter.nf_conntrack_max</code> 和 <code>net.ipv4.ip_local_port_range</code></p><p>我是 Clay，下期见 👋</p><hr><blockquote><ul><li><p>欢迎订阅我的公众号「SRE运维进阶之路」或关注我的 Github https://github.com/clay-wangzhi/SreGuide 查看最新文章</p></li><li><p>欢迎加我微信<code>sre-k8s-ai</code>，与我讨论云原生、稳定性相关内容</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin-20240615194414355.png" alt="weixin" style="zoom:50%;">`,50),l=[i];function t(o,p){return a(),s("div",null,l)}const m=n(c,[["render",t],["__file","dns-unknown-host-exception.html.vue"]]);export{m as default};
