import{_ as r}from"./plugin-vue_export-helper-c27b6911.js";import{r as n,o,c,a as e,b as d,d as t,e as s}from"./app-be40ec11.js";const h={},i=s('<h1 id="卸载-rancher-导致-node-被清空" tabindex="-1"><a class="header-anchor" href="#卸载-rancher-导致-node-被清空" aria-hidden="true">#</a> 卸载 rancher 导致 node 被清空</h1><h2 id="问题描述" tabindex="-1"><a class="header-anchor" href="#问题描述" aria-hidden="true">#</a> 问题描述</h2><p>集群的节点突然全都不见了 (<code>kubectl get node</code> 为空)，导致集群瘫痪，但实际上节点对应的宿主机都还在。因为集群没开审计，所以也不太好查 node 是被什么删除的。</p><h2 id="快速恢复" tabindex="-1"><a class="header-anchor" href="#快速恢复" aria-hidden="true">#</a> 快速恢复</h2><p>由于当时没有排查出来问题，当时批量重启了服务器，自动拉起 kubelet 重新注册 node，故障恢复。其实只是 k8s node 资源被删除，重启 kubelet 服务，自动注册即可。</p><h2 id="根因分析-5-why" tabindex="-1"><a class="header-anchor" href="#根因分析-5-why" aria-hidden="true">#</a> 根因分析（5 why）</h2><p>从 kube-apiserver 日志中可以看到，DELETE node 的操作，导致 node 被清空</p><p><strong>哪里调用的 删除接口？</strong></p><p>node 被清空前，查看 history，发现有卸载 rancher 的操作，很可疑，调查发现，rancher 自定义crd <code>nodes.management.cattle.io</code>，有操控 node 的嫌疑，而这个crd 只在 <code>local</code> namespace 发现资源，所以判断是卸载 rancher 的脚步中，有直接删除 <code>local</code>的操作</p><h2 id="教训" tabindex="-1"><a class="header-anchor" href="#教训" aria-hidden="true">#</a> 教训</h2><p>操作类似的 k8s web 管理平台，尤其删删除卸载时，务必小心，没有把握不要操作，网上的脚步慎用，最好用官方提供的卸载方式，恰巧当时 rancher 官方的卸载方式好久没有维护了，说多了都是泪。。。</p><p><strong>参考链接：</strong></p>',12),l={href:"https://imroc.cc/kubernetes/troubleshooting/cases/cluster/delete-rancher-ns-causing-node-disappear.html#%E8%AF%AF%E5%88%A0-rancher-%E7%9A%84-namespace-%E5%AF%BC%E8%87%B4-node-%E8%A2%AB%E6%B8%85%E7%A9%BA",target:"_blank",rel:"noopener noreferrer"};function p(u,_){const a=n("ExternalLinkIcon");return o(),c("div",null,[i,e("ul",null,[e("li",null,[e("a",l,[d("误删 rancher 的 namespace 导致 node 被清空"),t(a)])])])])}const b=r(h,[["render",p],["__file","delete-rancher-causing-node-disappear.html.vue"]]);export{b as default};
