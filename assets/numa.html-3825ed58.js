import{_ as r}from"./plugin-vue_export-helper-c27b6911.js";import{r as i,o as t,c as d,b as e,d as s,e as n,a as l}from"./app-679550bc.js";const c={},o=l(`<h1 id="cpu-绑核" tabindex="-1"><a class="header-anchor" href="#cpu-绑核" aria-hidden="true">#</a> CPU 绑核</h1><p>背景：算法集群，跑的应用为CPU 密集型应用，k8s 原来的 CPU调度算法为 CFS（基于时间片的），会产生限流，从而影响性能，影响 响应时间，所有改为 CPU 绑核</p><h2 id="内核启动-numa" tabindex="-1"><a class="header-anchor" href="#内核启动-numa" aria-hidden="true">#</a> 内核启动 NUMA</h2><p>修改 <code>/etc/default/grub</code> 中<code>numa=off</code> 改为<code>numa=on</code></p><p>重新生成<code>grub.cfg</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>grub2-mkconfig <span class="token parameter variable">-o</span> /boot/efi/EFI/centos/grub.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重启检验</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">shutdown</span> <span class="token parameter variable">-r</span> now
lscpu <span class="token operator">|</span> <span class="token function">grep</span> NUMA
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="k8s-绑核配置步骤" tabindex="-1"><a class="header-anchor" href="#k8s-绑核配置步骤" aria-hidden="true">#</a> k8s 绑核配置步骤</h2><p>前提条件</p><ul><li>k8s 1.18 版本以上</li></ul><p>1） 修改 kubelet 配置文件（Node 节点）</p><p><code>vim /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code>，修改前后对比</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>9a10,11
&gt; ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service
&gt; ExecStartPre=/usr/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice/kubelet.service
11c13,14
&lt; ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
---
&gt; #ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
&gt; ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS --kube-reserved=cpu=2,memory=250Mi --cpu-manager-policy=static --feature-gates=CPUManager=true --topology-manager-policy=single-numa-node
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）删除旧的 CPU 管理器状态文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">rm</span> <span class="token parameter variable">-f</span> /var/lib/kubelet/cpu_manager_state
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>3）重启 kubelet</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl daemon-reload
systemctl restart kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="验证-pod-是否绑核成功" tabindex="-1"><a class="header-anchor" href="#验证-pod-是否绑核成功" aria-hidden="true">#</a> 验证 pod 是否绑核成功</h2><p>1）将 工作负载 设置为 Guaranteed Pod， 即 设置limit 和 request ，并相等，CPU 为整数</p><p>2）验证</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> inspect xxx <span class="token operator">|</span> <span class="token function">grep</span> Cpuset
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>参考链接：</p>`,23),u={href:"https://bbs.huaweicloud.com/blogs/181224",target:"_blank",rel:"noopener noreferrer"},p={href:"https://imroc.cc/kubernetes/best-practices/performance-optimization/cpu.html#cpu-%E7%BB%91%E6%A0%B8",target:"_blank",rel:"noopener noreferrer"};function b(m,v){const a=i("ExternalLinkIcon");return t(),d("div",null,[o,e("ul",null,[e("li",null,[e("a",u,[s("鲲鹏Kubernetes平台如何使用CPU Manager + Topology Manager达成最佳绑核实例"),n(a)])]),e("li",null,[e("a",p,[s("CPU 绑核"),n(a)])])])])}const _=r(c,[["render",b],["__file","numa.html.vue"]]);export{_ as default};
