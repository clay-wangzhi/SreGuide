import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{o as n,c as s,e}from"./app-6b705441.js";const t={},l=e(`<h1 id="k8s-è´Ÿè½½æ„ŸçŸ¥è°ƒåº¦å®è·µ-koordinator-crane" tabindex="-1"><a class="header-anchor" href="#k8s-è´Ÿè½½æ„ŸçŸ¥è°ƒåº¦å®è·µ-koordinator-crane" aria-hidden="true">#</a> K8s è´Ÿè½½æ„ŸçŸ¥è°ƒåº¦å®è·µï¼ˆkoordinator &amp; craneï¼‰</h1><p>ä¸Šç¯‡ â€œæ·±å…¥äº†è§£ kube-schedulerâ€ ï¼Œå·²ç»çŸ¥é“ kube-scheduler çš„å·¥ä½œæµç¨‹ï¼Œä»¥åŠå¦‚ä½•å®ç°è‡ªå®šä¹‰æ’ä»¶ã€‚koordinator å’Œ crane éƒ½æ˜¯åŸºäºScheduler Framework è¿›è¡Œå®ç°çš„ è´Ÿè½½æ„ŸçŸ¥æ’ä»¶ã€‚æœ¬æ–‡ä¸å†èµ˜è¿°ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸Šç¯‡æ–‡ç« ã€‚</p><h2 id="èƒŒæ™¯" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯" aria-hidden="true">#</a> èƒŒæ™¯</h2><p>åŸç”Ÿ Kubernetes è°ƒåº¦å™¨ä»…åŸºäºèµ„æºçš„ Request è¿›è¡Œè°ƒåº¦ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒèµ„æºçš„çœŸå®ä½¿ç”¨ç‡å’Œç”³è¯·ç‡å¾€å¾€ç›¸å·®å·¨å¤§ï¼Œé€ æˆ<strong>èµ„æºæµªè´¹</strong>çš„åŒæ—¶ä¹Ÿä¼šé€ æˆèŠ‚ç‚¹çš„è´Ÿ<strong>è½½ä¸å‡è¡¡</strong>ã€‚</p><h2 id="å¼€æºæ–¹æ¡ˆå¯¹æ¯”-koordinator-vs-crane" tabindex="-1"><a class="header-anchor" href="#å¼€æºæ–¹æ¡ˆå¯¹æ¯”-koordinator-vs-crane" aria-hidden="true">#</a> å¼€æºæ–¹æ¡ˆå¯¹æ¯” koordinator VS crane</h2><p><strong>crane-scheduler æ¶æ„</strong></p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241024143748739.png" style="zoom:67%;"><blockquote><p>å‰ç½®æ¡ä»¶æ˜¯å®‰è£…äº† Prometheus ï¼Œ ä» Prometheus ä¸­è·å–æ•°æ®ã€‚</p></blockquote><p><strong>koord-scheduler æ¶æ„</strong></p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241024144013602.png" alt=""></p><blockquote><p>ç›‘æ§æŒ‡æ ‡æ˜¯ä» koordlet ä¸­è·å–ï¼Œ koordlet æ˜¯ä¸€ä¸ª daemonset ç±»å‹çš„æ’ä»¶ï¼Œè´Ÿè´£æ”¶é›†æŒ‡æ ‡ï¼Œå¹¶å­˜å‚¨åœ¨æœ¬åœ° Prometheus ä¸­</p></blockquote><p><strong>å¯¹æ¯”</strong></p><table><thead><tr><th></th><th>crane-scheduler</th><th>koord-scheduler</th></tr></thead><tbody><tr><td>æŒ‡æ ‡æ”¶é›†å‘¨æœŸ</td><td>ä¾èµ–äºå¤–ç½® Prometheus çš„æ”¶é›†å‘¨æœŸï¼Œé»˜è®¤ä¸º 30s ï¼ˆé¢—ç²’åº¦è¾ƒç²—ï¼Œä¸å®¹æ˜“æ”¶é›†åˆ°çªåˆºï¼‰</td><td>ds æ–¹å¼ çš„ koordlet æ’ä»¶æ”¶é›†ï¼Œ ç›¸å½“äºæ¯ä¸ª Node èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª Prometheusï¼Œ æ”¶é›†å‘¨æœŸé»˜è®¤ä¸º 1s</td></tr><tr><td>æ•°å€¼ç±»å‹</td><td>avg ã€max</td><td>avgã€p50ã€p90ã€p95ã€p99</td></tr><tr><td>åœ¨ç¦»çº¿æ··éƒ¨</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ<br>åœ¨çº¿ Pod(LSE/LSR/LSï¼‰å’Œç¦»çº¿ Podï¼ˆBEï¼‰</td></tr><tr><td>hotValue èµ„æºé¢„ä¼°</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>ä½¿ç”¨ç‡ åˆ†æ¯</td><td>å®¿ä¸»æœº Total èµ„æºï¼ˆä¸åˆç†ï¼‰</td><td>Node allocatable (åˆç†)</td></tr></tbody></table><p>ç»¼ä¸Šï¼Œé€‰ç”¨ koord-scheduler ã€‚</p><h2 id="koordinator-ä½¿ç”¨å®è·µ" tabindex="-1"><a class="header-anchor" href="#koordinator-ä½¿ç”¨å®è·µ" aria-hidden="true">#</a> koordinator ä½¿ç”¨å®è·µ</h2><p>æ–°å¢ UsageAggregatedDuration ä¸º 18h çš„æ—¶é—´æ®µ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token parameter variable">-n</span> koordinator-system edit  cm slo-controller-config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">colocation-config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    {
      &quot;enable&quot;: true,
      &quot;metricAggregatePolicy&quot;: {
        &quot;durations&quot;: [
          &quot;5m&quot;,
          &quot;10m&quot;,
          &quot;30m&quot;,
          &quot;24h&quot;
        ]
      }
    }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¿®æ”¹ koordlet ä¸­ Prometheus çš„å­˜å‚¨æ—¶é—´</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token parameter variable">-n</span> koordinator-system edit ds koordlet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>addr=<span class="token punctuation">:</span><span class="token number">9316</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>cgroup<span class="token punctuation">-</span>root<span class="token punctuation">-</span>dir=/host<span class="token punctuation">-</span>cgroup/
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>logtostderr=true
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tsdb<span class="token punctuation">-</span>retention<span class="token punctuation">-</span>duration=18h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>å¯ä»¥ä½¿ç”¨promtool å·¥å…·è¿›å…¥ Pod æŸ¥çœ‹æ•°æ®ï¼š ./promtool tsdb list /metric-data/</p></blockquote><p>ä¿®æ”¹ é˜ˆå€¼ è§¦å‘è§„åˆ™ï¼Œ éœ€è¦é‡å¯ koord-scheduler æ‰ç”Ÿæ•ˆã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token parameter variable">-n</span> koordinator-system edit cm  koord-scheduler-config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>            <span class="token key atrule">aggregated</span><span class="token punctuation">:</span>
              <span class="token key atrule">usageThresholds</span><span class="token punctuation">:</span>
                <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">55</span>
                <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token number">85</span>
              <span class="token key atrule">usageAggregationType</span><span class="token punctuation">:</span> <span class="token string">&quot;p99&quot;</span>
              <span class="token key atrule">scoreAggregationType</span><span class="token punctuation">:</span> <span class="token string">&quot;p99&quot;</span>
            <span class="token key atrule">estimatedScalingFactors</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">85</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token number">70</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token parameter variable">-n</span> koordinator-system rollout restart deployment koord-scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è€ƒè™‘åˆ° å…¬æœ‰äº‘èµ„æº å¯èƒ½æœ‰è‡ªå·±çš„ è°ƒåº¦å®ç°ï¼Œ æ‰€ä»¥åªæ”¹ IDC æœºæˆ¿çš„è°ƒåº¦å™¨ï¼Œå¢åŠ  mutatingwebhook è¿›è¡Œæ‹¦æˆªä¿®æ”¹ï¼Œæœ‰é—®é¢˜å¯ä»¥å¿«é€Ÿå›é€€ã€‚</p><p>ç”Ÿæ•ˆæ–¹å¼ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl label ns <span class="token variable">\${NsName}</span> koordinator-injection<span class="token operator">=</span>enabled
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å›é€€æ–¹å¼ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl label ns <span class="token variable">\${NsName}</span> koordinator-injection-
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æºä»£ç åœ°å€ï¼šhttps://github.com/koordinator-sh/koordinator</p><p>é­”æ”¹ä»£ç åœ°å€ï¼šhttps://github.com/clay-wangzhi/koordinator</p><p>é­”æ”¹ä»£ç  å¿«é€Ÿéƒ¨ç½²ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/clay-wangzhi/koordinator
<span class="token builtin class-name">cd</span> koordinator/manifests
kubectl apply <span class="token parameter variable">-f</span> setup/
kubectl apply <span class="token parameter variable">-f</span> koordlet/
kubectl apply <span class="token parameter variable">-f</span> koord-scheduler/
kubectl apply <span class="token parameter variable">-f</span> koord-manager/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•" aria-hidden="true">#</a> æµ‹è¯•</h2><p>1ï¼‰ æ‰¾å‡º è´Ÿè½½è¾ƒé«˜çš„ Node</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token function">top</span> <span class="token function">node</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-nk</span> <span class="token number">3</span>
kubectl get nodemetrics.slo.koordinator.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰ ç»™ä¸€ä¸ª è´Ÿè½½è¾ƒé«˜çš„ Node + å‡ ä¸ª è´Ÿè½½æ­£å¸¸çš„ Node æ‰“æ ‡ç­¾</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl label <span class="token function">node</span> <span class="token variable"><span class="token variable">$(</span>NodeName<span class="token variable">)</span></span> <span class="token assign-left variable">test</span><span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>3ï¼‰æ‰¾åˆ°åº”ç”¨æ‰€åœ¨ Nsï¼Œæ‰“æ ‡ï¼Œè®¾ç½® SchedulerName ä¸º koord-scheduler æ˜¯é€šè¿‡ mutatingwebhook å®ç°çš„</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl label ns <span class="token variable">\${NsName}</span> koordinator-injection<span class="token operator">=</span>enabled
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>4ï¼‰æ‰¾ä¸€ä¸ªåº”ç”¨ï¼ŒåŠ ä¸ŠèŠ‚ç‚¹äº²å’Œæ€§ å’Œ Pod åäº²å’Œæ€§ï¼Œ å¹¶æŠŠå‰¯æœ¬æ•° è®¾ç½®ä¸º å’Œ æ‰“æ ‡çš„ Node æ•° ç›¸ç­‰</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> test
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token string">&quot;true&quot;</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> appid
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> $(AppidName)
            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5ï¼‰æŸ¥çœ‹ç»“æœï¼Œå½“æœ‰ä¸€ä¸ª Pod å¤„äº Pending ï¼Œä¸”æ—¶é—´ Reson åŒ…æ¶µå¦‚ä¸‹å­—æ ·ï¼Œä»£è¡¨è®¾ç½®æˆåŠŸ</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20241024172736806.png" alt=""></p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li>Crane-Scheduler:çœŸå®å·¥ä½œè´Ÿè½½æ„ŸçŸ¥çš„è°ƒåº¦å™¨è®¾è®¡ä¸å®ç°ï¼šhttps://cloud.tencent.com/developer/article/2296515?areaId=106005</li><li>koordinator è´Ÿè½½æ„ŸçŸ¥è°ƒåº¦ï¼šhttps://koordinator.sh/zh-Hans/docs/user-manuals/load-aware-scheduling</li></ul><p>æˆ‘æ˜¯ Clayï¼Œä¸‹æœŸè§ ğŸ‘‹</p><hr><blockquote><ul><li><p>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·ã€ŒSREè¿ç»´è¿›é˜¶ä¹‹è·¯ã€æˆ–å…³æ³¨æˆ‘çš„ Github https://github.com/clay-wangzhi/SreGuide æŸ¥çœ‹æœ€æ–°æ–‡ç« </p></li><li><p>æ¬¢è¿åŠ æˆ‘å¾®ä¿¡<code>sre-k8s-ai</code>ï¼Œä¸æˆ‘è®¨è®ºäº‘åŸç”Ÿã€ç¨³å®šæ€§ç›¸å…³å†…å®¹</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin-20240615194414355.png" alt="weixin" style="zoom:50%;">`,52),i=[l];function o(c,r){return n(),s("div",null,i)}const u=a(t,[["render",o],["__file","loadaware-scheduler.html.vue"]]);export{u as default};
