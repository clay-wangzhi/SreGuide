import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as n,a as e}from"./app-6e2a3b53.js";const t={},p=e('<h1 id="etcd-故障排查" tabindex="-1"><a class="header-anchor" href="#etcd-故障排查" aria-hidden="true">#</a> Etcd 故障排查</h1><h2 id="etcd-磁盘空间爆满解决方案" tabindex="-1"><a class="header-anchor" href="#etcd-磁盘空间爆满解决方案" aria-hidden="true">#</a> Etcd 磁盘空间爆满解决方案</h2><blockquote><p>etcd默认的空间配额限制为2G，超出空间配额限制就会影响服务，所以需要定期清理</p></blockquote><p>设置环境变量</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCD_CA_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span>\n<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.crt&quot;</span>\n<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.key&quot;</span>\n<span class="token assign-left variable">HOST_1</span><span class="token operator">=</span>https://xxx.xxx.xxx.xxx:2379\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看集群状态" tabindex="-1"><a class="header-anchor" href="#查看集群状态" aria-hidden="true">#</a> 查看集群状态</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> --write-out<span class="token operator">=</span>table endpoint status\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看ETCD集群报警情况</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> alarm list\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>输出为：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>meberID:XXXXXXXXXXXXXXX alarm:NOSPACE\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>此处 <code>alarm</code> 提示 <code>NOSPACE</code>，需要升级 ETCD 集群的空间（默认为2G的磁盘使用空间），或者压缩老数据，升级空间后，需要使用 etcd命令，取消此报警信息，否则集群依旧无法使用</p></blockquote><h3 id="解决方案一-增加etcd的容量" tabindex="-1"><a class="header-anchor" href="#解决方案一-增加etcd的容量" aria-hidden="true">#</a> 解决方案一：增加etcd的容量</h3><p>修改 etcd.yaml 文件，由2G--&gt;8G,增加以下三个参数</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>- --auto-compaction-mode<span class="token operator">=</span>revision\n- --auto-compaction-retention<span class="token operator">=</span><span class="token number">1000</span>\n- --quota-backend-bytes<span class="token operator">=</span><span class="token number">8589934592</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>auto-compaction-mode=revision 按版本号压缩</p><p>auto-compaction-retention=1000 保留近1000个revision，每5分钟自动压缩 ”latest revision” - 1000</p><p>quota-backend-bytes 设置etcd最大容量为8G</p></blockquote><p>修改后重启</p><h3 id="解决方案二-压缩老数据清理" tabindex="-1"><a class="header-anchor" href="#解决方案二-压缩老数据清理" aria-hidden="true">#</a> 解决方案二：压缩老数据清理</h3><h4 id="压缩老数据" tabindex="-1"><a class="header-anchor" href="#压缩老数据" aria-hidden="true">#</a> 压缩老数据</h4><ul><li>获取当前etcd数据的修订版本(revision)</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">rev</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl  <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> endpoint status --write-out<span class="token operator">=</span><span class="token string">&quot;json&quot;</span> <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token parameter variable">-o</span> <span class="token string">&#39;&quot;revision&quot;:[0-9]*&#39;</span> <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token parameter variable">-o</span> <span class="token string">&#39;[0-9].*&#39;</span><span class="token variable">)</span></span>\n<span class="token builtin class-name">echo</span> <span class="token variable">$rev</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>整合压缩旧版本数据</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> compact <span class="token variable">$rev</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>执行碎片整理</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> defrag\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="解除告警" tabindex="-1"><a class="header-anchor" href="#解除告警" aria-hidden="true">#</a> 解除告警</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> alarm disarm\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="验证可以添加新数据" tabindex="-1"><a class="header-anchor" href="#验证可以添加新数据" aria-hidden="true">#</a> 验证可以添加新数据</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>\n  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${HOST_1}</span>&quot;</span> put newkeytestfornospace <span class="token number">123</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>⚠️ auto compact只会压缩key space，不会释放物理存储空间。所以需要定期的执行defrag</p></blockquote>',30),o=[p];function r(l,c){return s(),n("div",null,o)}const u=a(t,[["render",r],["__file","etcd-space.html.vue"]]);export{u as default};
