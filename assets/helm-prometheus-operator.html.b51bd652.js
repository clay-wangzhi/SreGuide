import{_ as r,r as t,c as l,a as e,e as a,F as o,b as n,d as p,o as i}from"./app.e298a435.js";const c={},m=e("h1",{id:"\u4F7F\u7528-helm-\u548C-operator-\u5FEB\u901F\u90E8\u7F72-prometheus",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#\u4F7F\u7528-helm-\u548C-operator-\u5FEB\u901F\u90E8\u7F72-prometheus","aria-hidden":"true"},"#"),n(" \u4F7F\u7528 Helm \u548C Operator \u5FEB\u901F\u90E8\u7F72 Prometheus")],-1),u=n("\u968F\u7740"),d=e("code",null,"heapster",-1),b=n("\u9879\u76EE\u505C\u6B62\u66F4\u65B0\u5E76\u6162\u6162\u88AB"),g=e("code",null,"metrics-server",-1),h=n("\u53D6\u4EE3\uFF0C\u96C6\u7FA4\u76D1\u63A7\u8FD9\u9879\u4EFB\u52A1\u4E5F\u5C06\u6700\u7EC8\u8F6C\u79FB\u3002"),v=e("code",null,"prometheus",-1),x=n("\u7684\u76D1\u63A7\u7406\u5FF5\u3001\u6570\u636E\u7ED3\u6784\u8BBE\u8BA1\u5176\u5B9E\u76F8\u5F53\u7CBE\u7B80\uFF0C\u5305\u62EC\u5176\u975E\u5E38\u7075\u6D3B\u7684\u67E5\u8BE2\u8BED\u8A00\uFF1B\u4F46\u662F\u5BF9\u4E8E\u521D\u5B66\u8005\u6765\u8BF4\uFF0C\u60F3\u8981\u5728k8s\u96C6\u7FA4\u4E2D\u5B9E\u8DF5\u642D\u5EFA\u4E00\u5957\u76F8\u5BF9\u53EF\u7528\u7684\u90E8\u7F72\u5374\u6BD4\u8F83\u9EBB\u70E6\uFF0C\u7531\u6B64\u8FD8\u4EA7\u751F\u4E86\u4E0D\u5C11\u4E13\u95E8\u7684\u9879\u76EE\uFF08\u5982\uFF1A"),f={href:"https://github.com/coreos/prometheus-operator",target:"_blank",rel:"noopener noreferrer"},_=n("prometheus-operator"),P=n("\uFF09\u3002"),q=e("p",null,[e("code",null,"Helm"),n("\u81F4\u529B\u4E8E\u6210\u4E3Ak8s\u96C6\u7FA4\u7684\u5E94\u7528\u5305\u7BA1\u7406\u5DE5\u5177\uFF0C\u5E0C\u671B\u50CFlinux \u7CFB\u7EDF\u7684"),e("code",null,"RPM"),n(),e("code",null,"DPKG"),n("\u90A3\u6837\u6210\u529F\uFF1B\u786E\u5B9E\u5728k8s\u4E0A\u90E8\u7F72\u590D\u6742\u4E00\u70B9\u7684\u5E94\u7528\u5F88\u9EBB\u70E6\uFF0C\u9700\u8981\u7BA1\u7406\u5F88\u591Ayaml\u6587\u4EF6\uFF08configmap,controller,service,rbac,pv,pvc\u7B49\u7B49\uFF09\uFF0C\u800Chelm\u80FD\u591F\u6574\u9F50\u7BA1\u7406\u8FD9\u4E9B\u6587\u6863\uFF1A\u7248\u672C\u63A7\u5236\uFF0C\u53C2\u6570\u5316\u5B89\u88C5\uFF0C\u65B9\u4FBF\u7684\u6253\u5305\u4E0E\u5206\u4EAB\u7B49\u3002")],-1),k=e("ul",null,[e("li",null,"\u5EFA\u8BAE\u79EF\u7D2F\u4E00\u5B9Ak8s\u7ECF\u9A8C\u4EE5\u540E\u518D\u53BB\u4F7F\u7528helm\uFF1B\u5BF9\u4E8E\u521D\u5B66\u8005\u6765\u8BF4\u624B\u5DE5\u53BB\u914D\u7F6E\u90A3\u4E9Byaml\u6587\u4EF6\u5BF9\u4E8E\u5FEB\u901F\u5B66\u4E60k8s\u7684\u8BBE\u8BA1\u7406\u5FF5\u548C\u8FD0\u884C\u539F\u7406\u975E\u5E38\u6709\u5E2E\u52A9\uFF0C\u800C\u4E0D\u662F\u76F4\u63A5\u53BB\u4F7F\u7528helm\uFF0C\u9762\u5BF9\u53C8\u4E00\u5C42\u5C01\u88C5\u4E0E\u590D\u6742\u5EA6\u3002")],-1),$=e("p",null,"Operator \u7528\u4E8E\u7BA1\u7406 Kubernetes \u7684\u6709\u72B6\u6001\u5206\u5E03\u5F0F\u5E94\u7528\u3002",-1),y=e("h2",{id:"\u5B89\u88C5-helm",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#\u5B89\u88C5-helm","aria-hidden":"true"},"#"),n(" \u5B89\u88C5 Helm")],-1),I=n("\u5728\u5B98\u65B9repo\u4E0B\u8F7D"),R={href:"https://github.com/helm/helm/releases",target:"_blank",rel:"noopener noreferrer"},C=n("release\u7248\u672C"),T=n("\u4E2D\u81EA\u5E26\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u5373\u53EF\uFF08\u4EE5Linux amd64\u4E3A\u4F8B\uFF09"),N=p(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://get.helm.sh/helm-v3.6.1-linux-amd64.tar.gz
<span class="token function">tar</span> -xvf helm-v3.6.1-linux-amd64.tar.gz 
<span class="token function">mv</span> ./linux-amd64/helm /usr/bin
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>\u542F\u7528\u5B98\u65B9 charts \u4ED3\u5E93</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>helm repo <span class="token function">add</span> stable https://charts.helm.sh/stable
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="\u51C6\u5907" tabindex="-1"><a class="header-anchor" href="#\u51C6\u5907" aria-hidden="true">#</a> \u51C6\u5907</h2><p>\u521B\u5EFA\u540D\u79F0\u7A7A\u95F4</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create ns monitoring
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u4E0B\u8F7D\u955C\u50CF\u6E90</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>helm pull stable/prometheus-operator
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u89E3\u538B</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tar -xvf prometheus-operator-9.3.2.tgz
rm -f prometheus-operator-9.3.2.tgz
cd prometheus-operator/
cp values.yaml{,.bak}
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u4FEE\u6539\u4E00\u4E9B\u53C2\u6570<code>vim values.yaml</code></p><ul><li><p>\u4FEE\u6539ControllerManager</p><p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721111652787.png" alt="image-20200721111652787" loading="lazy"></p></li><li><p>\u4FEE\u6539etcd\uFF0C\u589E\u52A0\u8BC1\u4E66\u8BA4\u8BC1</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create secret generic etcd-certs -n monitoring --from-file=/etc/kubernetes/ssl/ca.pem --from-file=/etc/kubernetes/ssl/kubernetes-key.pem --from-file=/etc/kubernetes/ssl/kubernetes.pem
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721112626079.png" alt="image-20200721112626079" loading="lazy"></p><p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721112701363.png" alt="image-20200721112701363" loading="lazy"></p></li><li><p>\u4FEE\u6539Scheduler</p><p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20200721112954847.png" alt="image-20200721112954847" loading="lazy"></p></li><li><p>\u4FEE\u6539Proxy</p><p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-2020072111314751.png" alt="image-20200721113147517" loading="lazy"></p></li><li><p>\u66B4\u9732\u670D\u52A1\uFF0C\u5C06<code>grafana\u3001prometheus\u3001alertmanager</code>\u4E2Dservice\u7684\u66B4\u9732\u65B9\u5F0F\u6539\u4E3A<code>NodePort</code></p><p><code>prometheus\u3001alertmanager</code>\uFF0C\u627E\u5230service \u7684type\u6539\u4E3ANodePort\u5373\u53EF</p><p><code>grafana</code>\uFF0C\u627E\u5230service\u540E\uFF0C\u65B0\u589E\u4EE5\u4E0B\u4E24\u884C</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>    type: NodePort
    nodePort: 30524
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul><h2 id="\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5" aria-hidden="true">#</a> \u5B89\u88C5</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>helm install  prometheus-operator --namespace=monitoring ./
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u67E5\u627E grafana admin \u8D26\u6237\u5BC6\u7801</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get secret --namespace monitoring  prometheus-operator-grafana -o jsonpath=&quot;{.data.admin-password}&quot; | base64 --decode ; echo
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="\u9A8C\u8BC1\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#\u9A8C\u8BC1\u5B89\u88C5" aria-hidden="true">#</a> \u9A8C\u8BC1\u5B89\u88C5</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u67E5\u770B\u76F8\u5173pod\u548Csvc
$ kubectl get pod,svc -n monitoring 
NAME                                                          READY   STATUS    RESTARTS   AGE
pod/alertmanager-prometheus-operator-alertmanager-0           2/2     Running   0          5m54s
pod/prometheus-operator-grafana-7769fc4f77-2wpxk              2/2     Running   0          10m
pod/prometheus-operator-kube-state-metrics-69fcc8d48c-vlxv6   1/1     Running   0          10m
pod/prometheus-operator-operator-c68d5d4cc-b2m77              2/2     Running   0          10m
pod/prometheus-operator-prometheus-node-exporter-gxmsp        1/1     Running   0          10m
pod/prometheus-operator-prometheus-node-exporter-jb9qm        1/1     Running   0          10m
pod/prometheus-operator-prometheus-node-exporter-ld4c4        1/1     Running   0          10m
pod/prometheus-operator-prometheus-node-exporter-tr2vg        1/1     Running   0          10m
pod/prometheus-operator-prometheus-node-exporter-x9ss4        1/1     Running   0          10m
pod/prometheus-operator-prometheus-node-exporter-xrg7s        1/1     Running   0          10m
pod/prometheus-prometheus-operator-prometheus-0               3/3     Running   1          5m44s

NAME                                                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                          ClusterIP   None            &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   5m54s
service/prometheus-operated                            ClusterIP   None            &lt;none&gt;        9090/TCP                     5m44s
service/prometheus-operator-alertmanager               NodePort    10.68.148.209   &lt;none&gt;        9093:30903/TCP               10m
service/prometheus-operator-grafana                    NodePort    10.68.154.126   &lt;none&gt;        80:30524/TCP                 10m
service/prometheus-operator-kube-state-metrics         ClusterIP   10.68.166.79    &lt;none&gt;        8080/TCP                     10m
service/prometheus-operator-operator                   ClusterIP   10.68.42.82     &lt;none&gt;        8080/TCP,443/TCP             10m
service/prometheus-operator-prometheus                 NodePort    10.68.2.85      &lt;none&gt;        9090:30090/TCP               10m
service/prometheus-operator-prometheus-node-exporter   ClusterIP   10.68.85.233    &lt;none&gt;        9100/TCP                     10m
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li>\u8BBF\u95EEprometheus\u7684web\u754C\u9762\uFF1A<code>http://$NodeIP:30090</code></li><li>\u8BBF\u95EEalertmanager\u7684web\u754C\u9762\uFF1A<code>http://$NodeIP:30903</code></li><li>\u8BBF\u95EEgrafana\u7684web\u754C\u9762\uFF1A<code>http://$NodeIP:30524</code> (\u9ED8\u8BA4\u7528\u6237\u5BC6\u7801 admin:prom-operator\uFF0C\u53EF\u5728web\u754C\u9762\u4FEE\u6539)</li></ul><h2 id="\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#\u7BA1\u7406" aria-hidden="true">#</a> \u7BA1\u7406</h2><h2 id="\u7BA1\u7406\u64CD\u4F5C" tabindex="-1"><a class="header-anchor" href="#\u7BA1\u7406\u64CD\u4F5C" aria-hidden="true">#</a> \u7BA1\u7406\u64CD\u4F5C</h2><ul><li>\u5347\u7EA7\uFF08\u4FEE\u6539\u914D\u7F6E\uFF09\uFF1A\u4FEE\u6539\u914D\u7F6E\u8BF7\u5728\`\`\u7B49\u6587\u4EF6\u4E2D\u8FDB\u884C\uFF0C\u4FDD\u5B58\u540E\u6267\u884C\uFF1A</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ helm upgrade prometheus-operator -n monitoring ./
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>\u56DE\u9000\uFF1A\u5177\u4F53\u53EF\u4EE5\u53C2\u8003<code>helm help rollback</code>\u6587\u6863</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u67E5\u770B\u5386\u53F2\u627E\u5230\u7248\u672C\u53F7
$ helm history prometheus-operator -n monitoring
$ helm rollback prometheus-operator [REVISION] -n monitoring
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>\u5220\u9664</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ helm delete prometheus-operator -n monitoring
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="\u589E\u52A0\u9489\u9489\u544A\u8B66" tabindex="-1"><a class="header-anchor" href="#\u589E\u52A0\u9489\u9489\u544A\u8B66" aria-hidden="true">#</a> \u589E\u52A0\u9489\u9489\u544A\u8B66</h2><p>\u4F7F\u7528 PrometheusAlert\u5168\u5BB6\u6876 \u8FDB\u884C\u9489\u9489\u544A\u8B66</p><blockquote><p>\u6587\u6863\uFF1Ahttps://feiyu563.gitbook.io/prometheusalert/</p></blockquote><p>\u81EA\u5B9A\u4E49\u6A21\u677F\u5982\u4E0B\uFF0C\u5982\u4F55\u81EA\u5B9A\u4E49\u6A21\u677F\uFF0C\u8BE6\u89C1\u6587\u6863\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>{{ $var := .externalURL}}{{ range $k,$v:=.alerts }}
{{if eq $v.status &quot;resolved&quot;}}
## [Prometheus\u6062\u590D\u4FE1\u606F]({{$v.generatorURL}})

&gt; &lt;font color=&quot;info&quot;&gt;\u544A\u8B66\u540D\u79F0&lt;/font&gt;\uFF1A[{{$v.labels.alertname}}]({{$var}})

&gt; &lt;font color=&quot;info&quot;&gt;\u544A\u8B66\u7EA7\u522B&lt;/font&gt;\uFF1A{{$v.labels.severity}}

&gt; &lt;font color=&quot;info&quot;&gt;\u5F53\u524D\u72B6\u6001&lt;/font&gt;\uFF1A{{$v.status}}

&gt; &lt;font color=&quot;info&quot;&gt;\u544A\u8B66\u5206\u7EC4&lt;/font&gt;\uFF1A{{$v.labels.team}}

&gt; &lt;font color=&quot;info&quot;&gt;\u5F00\u59CB\u65F6\u95F4&lt;/font&gt;\uFF1A{{GetCSTtime $v.startsAt}}

&gt; &lt;font color=&quot;info&quot;&gt;\u7ED3\u675F\u65F6\u95F4&lt;/font&gt;\uFF1A{{GetCSTtime $v.endsAt}}

&gt; &lt;font color=&quot;info&quot;&gt;\u5B9E\u4F8B\u5730\u5740&lt;/font&gt;\uFF1A{{$v.labels.instance}}

**{{$v.annotations.message}}**
{{else}}
## [ &lt;font color=&quot;#FF0000&quot;&gt;Prometheus\u544A\u8B66\u4FE1\u606F&lt;/font&gt;]({{$v.generatorURL}})
&gt; &lt;font color=&quot;#FF0000&quot;&gt;\u544A\u8B66\u540D\u79F0&lt;/font&gt;\uFF1A[{{$v.labels.alertname}}]({{$var}})

&gt; &lt;font color=&quot;#FF0000&quot;&gt;\u544A\u8B66\u7EA7\u522B&lt;/font&gt;\uFF1A{{$v.labels.severity}}

&gt; &lt;font color=&quot;#FF0000&quot;&gt;\u5F53\u524D\u72B6\u6001&lt;/font&gt;\uFF1A{{$v.status}}

&gt; &lt;font color=&quot;#FF0000&quot;&gt;\u544A\u8B66\u5206\u7EC4&lt;/font&gt;\uFF1A{{$v.labels.team}}

&gt; &lt;font color=&quot;#FF0000&quot;&gt;\u5F00\u59CB\u65F6\u95F4&lt;/font&gt;\uFF1A{{GetCSTtime $v.startsAt}}

&gt; &lt;font color=&quot;#FF0000&quot;&gt;\u5B9E\u4F8B\u5730\u5740&lt;/font&gt;\uFF1A{{$v.labels.instance}}

{{$v.annotations.message}}
{{end}}
{{ end }}
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>\u8DD1\u901A PrometheusAlert \u540E\uFF0C\u4FEE\u6539 values.yaml \u914D\u7F6E\u6587\u4EF6</p><p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/image-20210713205650167.png" alt="image-20210713205650167" loading="lazy"></p><p>\u6CE8\u91CA\u6389\u4E00\u4E2Aetcd alert rules <code>templates/prometheus/rules/etcd.yaml</code>\u548C<code>templates/prometheus/rules-1.14/etcd.yaml</code>\u6587\u4EF6\uFF0C\u4E0D\u786E\u5B9A\u662F\u8BEF\u62A5\u8FD8\u662Fbug\uFF0CetcdHighNumberOfFailedGRPCRequests</p><ul><li>\u5347\u7EA7</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ helm upgrade prometheus-operator -n monitoring ./
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,37);function w(F,z){const s=t("ExternalLinkIcon");return i(),l(o,null,[m,e("p",null,[u,d,b,g,h,v,x,e("a",f,[_,a(s)]),P]),q,k,$,y,e("p",null,[I,e("a",R,[C,a(s)]),T]),N],64)}var A=r(c,[["render",w],["__file","helm-prometheus-operator.html.vue"]]);export{A as default};
