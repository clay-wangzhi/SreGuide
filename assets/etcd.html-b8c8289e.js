import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as e,e as n}from"./app-3cf8be0b.js";const t={},r=n(`<h1 id="etcd-æ¦‚è¿°åŠè¿ç»´å®è·µ" tabindex="-1"><a class="header-anchor" href="#etcd-æ¦‚è¿°åŠè¿ç»´å®è·µ" aria-hidden="true">#</a> Etcd æ¦‚è¿°åŠè¿ç»´å®è·µ</h1><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/EtcdÂ .png" alt=""></p><h2 id="etcd-æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#etcd-æ¦‚è¿°" aria-hidden="true">#</a> Etcd æ¦‚è¿°</h2><h3 id="ä»€ä¹ˆæ˜¯-etcd" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-etcd" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯ Etcd ?</h3><p>Etcd æ˜¯ CoreOS å›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨<code>raft</code>åè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒEtcdåŸºäº Go è¯­è¨€å®ç°ã€‚</p><p>åå­—ç”±æ¥ï¼Œå®ƒæºäºä¸¤ä¸ªæ–¹é¢ï¼Œunixçš„â€œ/etcâ€æ–‡ä»¶å¤¹å’Œåˆ†å¸ƒå¼ç³»ç»Ÿ(â€œDâ€istribute system)çš„Dï¼Œç»„åˆåœ¨ä¸€èµ·è¡¨ç¤ºetcdæ˜¯ç”¨äºå­˜å‚¨åˆ†å¸ƒå¼é…ç½®çš„ä¿¡æ¯å­˜å‚¨æœåŠ¡ã€‚</p><h3 id="kubernetes-ä¸ºä»€ä¹ˆç”¨-etcd" tabindex="-1"><a class="header-anchor" href="#kubernetes-ä¸ºä»€ä¹ˆç”¨-etcd" aria-hidden="true">#</a> Kubernetes ä¸ºä»€ä¹ˆç”¨ Etcd ?</h3><p>2014å¹´6æœˆï¼ŒGoogle çš„ Kubernetes é¡¹ç›®è¯ç”Ÿäº†ï¼Œæˆ‘ä»¬å‰é¢æ‰€è®¨è®ºåˆ° Go è¯­è¨€ç¼–å†™ã€etcd é«˜å¯ç”¨ã€Watch æœºåˆ¶ã€CASã€TTLç­‰ç‰¹æ€§æ­£æ˜¯ Kubernetes æ‰€éœ€è¦çš„ï¼Œå®ƒæ—©æœŸçš„0.4ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„æ­£æ˜¯ etcd v0.2ç‰ˆæœ¬ã€‚</p><p>Kubernetes æ˜¯å¦‚ä½•ä½¿ç”¨ etcd v2 è¿™äº›ç‰¹æ€§çš„å‘¢ï¼Ÿä¸¾å‡ ä¸ªç®€å•å°ä¾‹å­ã€‚</p><p>å½“ä½ ä½¿ç”¨ Kubernetes å£°æ˜å¼ API éƒ¨ç½²æœåŠ¡çš„æ—¶å€™ï¼ŒKubernetes çš„æ§åˆ¶å™¨é€šè¿‡ etcd Watch æœºåˆ¶ï¼Œä¼šå®æ—¶ç›‘å¬èµ„æºå˜åŒ–äº‹ä»¶ï¼Œå¯¹æ¯”å®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€æ˜¯å¦ä¸€è‡´ï¼Œå¹¶é‡‡å–åè°ƒåŠ¨ä½œä½¿å…¶ä¸€è‡´ã€‚Kubernetes æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œé€šè¿‡ CAS æœºåˆ¶ä¿è¯å¹¶å‘åœºæ™¯ä¸‹çš„åŸå­æ›´æ–°ï¼Œå¹¶é€šè¿‡å¯¹ key è®¾ç½® TTL æ¥å­˜å‚¨ Event äº‹ä»¶ï¼Œæå‡Kubernetes é›†ç¾¤çš„å¯è§‚æµ‹æ€§ï¼ŒåŸºäº TTL ç‰¹æ€§ï¼ŒEvent äº‹ä»¶ key åˆ°æœŸåå¯è‡ªåŠ¨åˆ é™¤ã€‚</p><p>Kubernetes é¡¹ç›®ä½¿ç”¨etcdï¼Œé™¤äº†æŠ€æœ¯å› ç´ ä¹Ÿä¸å½“æ—¶çš„å•†ä¸šç«äº‰æœ‰å…³ã€‚CoreOS æ˜¯ Kubernetes å®¹å™¨ç”Ÿæ€åœˆçš„æ ¸å¿ƒæˆå‘˜ä¹‹ä¸€ã€‚</p><h3 id="etcd-ç‰ˆæœ¬å˜åŒ–" tabindex="-1"><a class="header-anchor" href="#etcd-ç‰ˆæœ¬å˜åŒ–" aria-hidden="true">#</a> Etcd ç‰ˆæœ¬å˜åŒ–</h3><p>æ—¶é—´è½´å›¾ï¼Œæ€»ç»“ä¸€ä¸‹ etcd v1/v2 å…³é”®ç‰¹æ€§</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/d0af3537c0eef89b499a82693da23f0e-20240410191510352.png" alt=""></p><p>ç„¶è€Œéšç€ Kubernetes é¡¹ç›®ä¸æ–­å‘å±•ï¼Œv2 ç‰ˆæœ¬çš„ç“¶é¢ˆå’Œç¼ºé™·é€æ¸æš´éœ²ï¼Œé‡åˆ°äº†è‹¥å¹²æ€§èƒ½å’Œç¨³å®šæ€§é—®é¢˜ï¼ŒKubernetes ç¤¾åŒºå‘¼åæ”¯æŒæ–°çš„å­˜å‚¨ã€æ‰¹è¯„ etcd ä¸å¯é çš„å£°éŸ³å¼€å§‹ä¸æ–­å‡ºç°ã€‚</p><p>é—®é¢˜å¦‚ä¸‹</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/881db1b7d05dc40771e9737f3117f5d1-20240410191510378.png" alt=""></p><p>2016å¹´6æœˆï¼Œetcd 3.0 è¯ç”Ÿï¼Œéšå Kubernetes 1.6 å‘å¸ƒï¼Œé»˜è®¤å¯ç”¨ etcd v3ï¼ŒåŠ©åŠ› Kubernetes æ”¯æ’‘5000èŠ‚ç‚¹é›†ç¾¤è§„æ¨¡ã€‚</p><p>æ—¶é—´è½´åŠé‡è¦ç‰¹æ€§</p><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/5f1bf807db06233ed51d142917798b6d-20240410191510416.png" alt=""></p><p>å‘å±•åˆ°ä»Šå¤©ï¼Œåœ¨ GitHub ä¸Š star æ•°è¶…è¿‡46Kã€‚åœ¨ Kubernetes çš„ä¸šåŠ¡åœºæ™¯ç£¨ç‚¼ä¸‹å®ƒä¸æ–­æˆé•¿ï¼Œèµ°å‘ç¨³å®šå’Œæˆç†Ÿï¼Œæˆä¸ºæŠ€æœ¯åœˆä¼—æ‰€å‘¨çŸ¥çš„å¼€æºäº§å“ï¼Œè€Œ <strong>v3æ–¹æ¡ˆçš„å‘å¸ƒï¼Œä¹Ÿæ ‡å¿—ç€ etcd è¿›å…¥äº†æŠ€æœ¯æˆç†ŸæœŸï¼Œæˆä¸ºäº‘åŸç”Ÿæ—¶ä»£çš„é¦–é€‰å…ƒæ•°æ®å­˜å‚¨äº§å“ã€‚</strong></p><h3 id="åŸºç¡€æ¶æ„" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¶æ„" aria-hidden="true">#</a> åŸºç¡€æ¶æ„</h3><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/34486534722d2748d8cd1172bfe63084-20240410191510506.png" alt=""></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§åˆ†å±‚æ¨¡å‹ï¼Œetcd å¯åˆ†ä¸º Client å±‚ã€API ç½‘ç»œå±‚ã€Raft ç®—æ³•å±‚ã€é€»è¾‘å±‚å’Œå­˜å‚¨å±‚ã€‚è¿™äº›å±‚çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li><p><strong>Client å±‚</strong>ï¼šClient å±‚åŒ…æ‹¬ client v2 å’Œ v3 ä¸¤ä¸ªå¤§ç‰ˆæœ¬ API å®¢æˆ·ç«¯åº“ï¼Œæä¾›äº†ç®€æ´æ˜“ç”¨çš„ APIï¼ŒåŒæ—¶æ”¯æŒè´Ÿè½½å‡è¡¡ã€èŠ‚ç‚¹é—´æ•…éšœè‡ªåŠ¨è½¬ç§»ï¼Œå¯æå¤§é™ä½ä¸šåŠ¡ä½¿ç”¨etcdå¤æ‚åº¦ï¼Œæå‡å¼€å‘æ•ˆç‡ã€æœåŠ¡å¯ç”¨æ€§ã€‚</p></li><li><p><strong>API ç½‘ç»œå±‚</strong>ï¼šAPI ç½‘ç»œå±‚ä¸»è¦åŒ…æ‹¬ client è®¿é—® server å’Œ server èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡åè®®ã€‚ä¸€æ–¹é¢ï¼Œclient è®¿é—® etcd server çš„ API åˆ†ä¸º v2 å’Œ v3 ä¸¤ä¸ªå¤§ç‰ˆæœ¬ã€‚v2 API ä½¿ç”¨ HTTP/1.x åè®®ï¼Œv3 API ä½¿ç”¨ gRPC åè®®ã€‚åŒæ—¶ v3 é€šè¿‡ etcd grpc-gateway ç»„ä»¶ä¹Ÿæ”¯æŒ HTTP/1.x åè®®ï¼Œä¾¿äºå„ç§è¯­è¨€çš„æœåŠ¡è°ƒç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œserver ä¹‹é—´é€šä¿¡åè®®ï¼Œæ˜¯æŒ‡èŠ‚ç‚¹é—´é€šè¿‡Raftç®—æ³•å®ç°æ•°æ®å¤åˆ¶å’ŒLeaderé€‰ä¸¾ç­‰åŠŸèƒ½æ—¶ä½¿ç”¨çš„HTTPåè®®ã€‚</p></li><li><p><strong>Raft ç®—æ³•å±‚</strong>ï¼šRaft ç®—æ³•å±‚å®ç°äº† Leader é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€ReadIndex ç­‰æ ¸å¿ƒç®—æ³•ç‰¹æ€§ï¼Œç”¨äºä¿éšœ etcd å¤šä¸ªèŠ‚ç‚¹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€æå‡æœåŠ¡å¯ç”¨æ€§ç­‰ï¼Œæ˜¯etcdçš„åŸºçŸ³å’Œäº®ç‚¹ã€‚</p></li><li><p><strong>åŠŸèƒ½é€»è¾‘å±‚</strong>ï¼šetcd æ ¸å¿ƒç‰¹æ€§å®ç°å±‚ï¼Œå¦‚å…¸å‹çš„ KVServer æ¨¡å—ã€MVCC æ¨¡å—ã€Auth é‰´æƒæ¨¡å—ã€Lease ç§Ÿçº¦æ¨¡å—ã€Compactor å‹ç¼©æ¨¡å—ç­‰ï¼Œå…¶ä¸­ MVCC æ¨¡å—ä¸»è¦ç”± treeIndex æ¨¡å—å’Œ boltdb æ¨¡å—ç»„æˆã€‚</p></li><li><p><strong>å­˜å‚¨å±‚</strong>ï¼šå­˜å‚¨å±‚åŒ…å«é¢„å†™æ—¥å¿—(WAL)æ¨¡å—ã€å¿«ç…§(Snapshot)æ¨¡å—ã€boltdb æ¨¡å—ã€‚å…¶ä¸­ WAL å¯ä¿éšœ etcd crash åæ•°æ®ä¸ä¸¢å¤±ï¼Œboltdb åˆ™ä¿å­˜äº†é›†ç¾¤å…ƒæ•°æ®å’Œç”¨æˆ·å†™å…¥çš„æ•°æ®ã€‚</p></li></ul><h3 id="æ¦‚å¿µæœ¯è¯­" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µæœ¯è¯­" aria-hidden="true">#</a> æ¦‚å¿µæœ¯è¯­</h3><ul><li>Raftï¼šetcd æ‰€é‡‡ç”¨çš„ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿå¼ºä¸€è‡´æ€§çš„ç®—æ³•ã€‚</li><li>Nodeï¼šä¸€ä¸ª Raft çŠ¶æ€æœºå®ä¾‹ã€‚</li><li>Memberï¼š ä¸€ä¸ª etcd å®ä¾‹ã€‚å®ƒç®¡ç†ç€ä¸€ä¸ª Nodeï¼Œå¹¶ä¸”å¯ä»¥ä¸ºå®¢æˆ·ç«¯è¯·æ±‚æä¾›æœåŠ¡ã€‚</li><li>Clusterï¼šç”±å¤šä¸ª Member æ„æˆå¯ä»¥ååŒå·¥ä½œçš„ etcd é›†ç¾¤ã€‚</li><li>Peerï¼šå¯¹åŒä¸€ä¸ª etcd é›†ç¾¤ä¸­å¦å¤–ä¸€ä¸ª Member çš„ç§°å‘¼ã€‚</li><li>Clientï¼š å‘ etcd é›†ç¾¤å‘é€ HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚</li><li>WALï¼šé¢„å†™å¼æ—¥å¿—ï¼Œetcd ç”¨äºæŒä¹…åŒ–å­˜å‚¨çš„æ—¥å¿—æ ¼å¼ã€‚</li><li>snapshotï¼šetcd é˜²æ­¢ WAL æ–‡ä»¶è¿‡å¤šè€Œè®¾ç½®çš„å¿«ç…§ï¼Œå­˜å‚¨ etcd æ•°æ®çŠ¶æ€ã€‚</li><li>Proxyï¼šetcd çš„ä¸€ç§æ¨¡å¼ï¼Œä¸º etcd é›†ç¾¤æä¾›åå‘ä»£ç†æœåŠ¡ã€‚</li><li>Leaderï¼šRaft ç®—æ³•ä¸­é€šè¿‡ç«é€‰è€Œäº§ç”Ÿçš„å¤„ç†æ‰€æœ‰æ•°æ®æäº¤çš„èŠ‚ç‚¹ã€‚</li><li>Followerï¼šç«é€‰å¤±è´¥çš„èŠ‚ç‚¹ä½œä¸º Raft ä¸­çš„ä»å±èŠ‚ç‚¹ï¼Œä¸ºç®—æ³•æä¾›å¼ºä¸€è‡´æ€§ä¿è¯ã€‚</li><li>Candidateï¼šå½“ Follower è¶…è¿‡ä¸€å®šæ—¶é—´æ¥æ”¶ä¸åˆ° Leader çš„å¿ƒè·³æ—¶è½¬å˜ä¸º Candidate å¼€å§‹ç«é€‰ã€‚</li><li>Termï¼šæŸä¸ªèŠ‚ç‚¹æˆä¸º Leader åˆ°ä¸‹ä¸€æ¬¡ç«é€‰æ—¶é—´ï¼Œç§°ä¸ºä¸€ä¸ª Termã€‚</li><li>Indexï¼šæ•°æ®é¡¹ç¼–å·ã€‚Raft ä¸­é€šè¿‡ Term å’Œ Index æ¥å®šä½æ•°æ®ã€‚</li></ul><h2 id="è¿ç»´å®è·µ" tabindex="-1"><a class="header-anchor" href="#è¿ç»´å®è·µ" aria-hidden="true">#</a> è¿ç»´å®è·µ</h2><h3 id="etcdctl-å¸¸ç”¨å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#etcdctl-å¸¸ç”¨å‘½ä»¤" aria-hidden="true">#</a> etcdctl å¸¸ç”¨å‘½ä»¤</h3><p>å…¨å±€å‚æ•°</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCD_CA_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span>
<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.crt&quot;</span>
<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.key&quot;</span>
<span class="token assign-left variable">HOST_1</span><span class="token operator">=</span>https://xxx.xxx.xxx.xxx:2379
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨ç¤ºä¾‹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${HOST_1}</span>&quot;</span> endpoint status --write-out<span class="token operator">=</span>table 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¸¸ç”¨å‘½ä»¤</p><ul><li>é”®å€¼å‘½ä»¤</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># å¢ &amp; æ”¹</span>
put foo bar
<span class="token comment"># æŸ¥</span>
get foo
<span class="token comment"># æ ¹æ®å‰ç¼€æŸ¥è¯¢</span>
get <span class="token parameter variable">--prefix</span> <span class="token string">&quot;/demo&quot;</span>
<span class="token comment"># æŸ¥è¯¢æ‰€æœ‰ keys</span>
get <span class="token parameter variable">--prefix</span> <span class="token string">&quot;&quot;</span> --keys-only
<span class="token comment"># åˆ </span>
del foo
<span class="token comment"># äº‹åŠ¡ï¼Œå¤šä¸ªæ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªäº‹åŠ¡</span>
txn <span class="token operator">&lt;&lt;&lt;</span><span class="token string">&#39;mod(&quot;key1&quot;) &gt; &quot;0&quot;

put key1 &quot;overwrote-key1&quot;

put key1 &quot;created-key1&quot;
put key2 &quot;some extra key&quot;

&#39;</span>
<span class="token comment"># å‹ç¼©</span>
compaction <span class="token number">1234</span>
<span class="token comment"># ç›‘å¬</span>
<span class="token function">watch</span> foo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é›†ç¾¤ç»´æŠ¤å‘½ä»¤</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ—å‡ºæˆå‘˜</span>
member list
<span class="token comment"># ç«¯ç‚¹å¥åº·æƒ…å†µ</span>
endpoint health
<span class="token comment"># ç«¯ç‚¹çŠ¶æ€</span>
endpoint status
<span class="token comment"># å‘Šè­¦åˆ—è¡¨</span>
alarm list
<span class="token comment"># è§£é™¤æ‰€æœ‰å‘Šè­¦</span>
alarm disarm
<span class="token comment"># ç¢ç‰‡æ•´ç†</span>
defrag
<span class="token comment"># åˆ›å»ºå¿«ç…§è¿›è¡Œå¤‡ä»½</span>
snapshot save snapshot.db
<span class="token comment"># å¿«ç…§æ¢å¤</span>
snapshot restore
<span class="token comment"># å¿«ç…§çŠ¶æ€</span>
snapshot status
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="etcd-ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#etcd-ç›‘æ§" aria-hidden="true">#</a> Etcd ç›‘æ§</h3><h4 id="é‡ç‚¹ç›‘æ§æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#é‡ç‚¹ç›‘æ§æŒ‡æ ‡" aria-hidden="true">#</a> é‡ç‚¹ç›‘æ§æŒ‡æ ‡</h4><p>æŒ‡æ ‡åˆ†ç±»</p><ul><li>å¥åº·çŠ¶æ€</li><li>USE æ–¹æ³•ï¼ˆç³»ç»Ÿï¼‰ <ul><li>ä½¿ç”¨ç‡</li><li>é¥±å’Œåº¦</li><li>é”™è¯¯</li></ul></li><li>RED æ–¹æ³•ï¼ˆåº”ç”¨ï¼‰ <ul><li>è¯·æ±‚é€Ÿç‡</li><li>é”™è¯¯ç‡</li><li>å»¶è¿Ÿ</li></ul></li></ul><table><thead><tr><th>æŒ‡æ ‡åˆ†ç±»</th><th>æŒ‡æ ‡</th><th>é‡Šä¹‰</th></tr></thead><tbody><tr><td>å¥åº·çŠ¶æ€</td><td>å®ä¾‹å¥åº·çŠ¶æ€</td><td>etcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”±å¤šä¸ªæˆå‘˜èŠ‚ç‚¹ç»„æˆã€‚ç›‘æ§etcdæˆå‘˜èŠ‚ç‚¹çš„çŠ¶æ€å¯ä»¥å¸®åŠ©ä½ äº†è§£é›†ç¾¤ä¸­èŠ‚ç‚¹çš„å¥åº·çŠ¶å†µï¼Œå‘ç°æ‰çº¿æˆ–è€…å¼‚å¸¸èŠ‚ç‚¹ã€‚</td></tr><tr><td>å¥åº·çŠ¶æ€</td><td>ä¸»ä»çŠ¶æ€</td><td></td></tr><tr><td>å¥åº·çŠ¶æ€</td><td>etcd leaderåˆ‡æ¢ç»Ÿè®¡</td><td>é¢‘ç¹çš„é¢†å¯¼è€…å˜æ›´ä¼šä¸¥é‡å½±å“ etcd çš„æ€§èƒ½ã€‚è¿™ä¹Ÿæ„å‘³ç€é¢†å¯¼è€…ä¸ç¨³å®šï¼Œå¯èƒ½æ˜¯ç”±äºç½‘ç»œè¿æ¥é—®é¢˜æˆ–å¯¹ etcd é›†ç¾¤æ–½åŠ çš„è¿‡è½½è´Ÿè·å¯¼è‡´çš„ã€‚</td></tr><tr><td>å¥åº·çŠ¶æ€</td><td>å¿ƒè·³</td><td>etcdé›†ç¾¤ä¸­çš„èŠ‚ç‚¹é€šè¿‡å‘é€å¿ƒè·³æ¥ä¿æŒå½¼æ­¤ä¹‹é—´çš„è¿æ¥ã€‚ç›‘æ§ä¸¢å¤±çš„å¿ƒè·³å¯ä»¥å¸®åŠ©ä½ å‘ç°etcdèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡é—®é¢˜æˆ–è€…ç½‘ç»œå»¶è¿Ÿã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>QPS</td><td></td></tr><tr><td>RED æ–¹æ³•</td><td>è¯·æ±‚é”™è¯¯ç‡</td><td>ç›‘æ§etcdçš„é”™è¯¯ç‡å¯ä»¥å¸®åŠ©ä½ å‘ç°etcdæ“ä½œä¸­çš„æ½œåœ¨é—®é¢˜ã€‚é«˜é”™è¯¯ç‡å¯èƒ½è¡¨æ˜é›†ç¾¤é‡åˆ°äº†æ•…éšœæˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>è¯·æ±‚å»¶è¿Ÿ</td><td>ç›‘æ§etcdçš„è¯·æ±‚å»¶è¿Ÿå¯ä»¥å¸®åŠ©ä½ äº†è§£APIè¯·æ±‚çš„å¤„ç†æ—¶é—´ã€‚è¾ƒé«˜çš„å»¶è¿Ÿå¯èƒ½è¡¨æ˜etcdæ­£é¢ä¸´è´Ÿè½½å‹åŠ›æˆ–æ€§èƒ½é—®é¢˜ã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>ç£ç›˜åŒæ­¥ï¼ˆWAL/DB fsyncï¼‰è€—æ—¶</td><td>é«˜ç£ç›˜æ“ä½œå»¶è¿Ÿï¼ˆwal_fsync_duration_secondsæˆ–backend_commit_duration_secondsï¼‰é€šå¸¸è¡¨ç¤ºç£ç›˜é—®é¢˜ã€‚å®ƒå¯èƒ½ä¼šå¯¼è‡´é«˜è¯·æ±‚å»¶è¿Ÿæˆ–ä½¿ç¾¤é›†ä¸ç¨³å®šã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>åŒæ­¥å»¶è¿Ÿ</td><td>å¦‚æœé›†ç¾¤æ­£å¸¸è¿è¡Œï¼Œå·²æäº¤çš„ææ¡ˆåº”è¯¥éšç€æ—¶é—´çš„æ¨ç§»è€Œå¢åŠ ã€‚é‡è¦çš„æ˜¯è¦åœ¨é›†ç¾¤çš„æ‰€æœ‰æˆå‘˜ä¸­ç›‘æ§è¿™ä¸ªæŒ‡æ ‡ï¼›å¦‚æœå•ä¸ªæˆå‘˜ä¸å…¶é¢†å¯¼èŠ‚ç‚¹ä¹‹é—´å­˜åœ¨æŒç»­è¾ƒå¤§çš„æ»åï¼Œè¿™è¡¨æ˜è¯¥æˆå‘˜è¿è¡Œç¼“æ…¢æˆ–å­˜åœ¨å¼‚å¸¸ã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>ææ¡ˆå¤±è´¥æ¬¡æ•°</td><td>å¤±è´¥çš„ææ¡ˆé€šå¸¸ä¸ä¸¤ä¸ªé—®é¢˜ç›¸å…³ï¼šä¸é¢†å¯¼é€‰ä¸¾ç›¸å…³çš„æš‚æ—¶æ€§æ•…éšœæˆ–ç”±äºé›†ç¾¤ä¸§å¤±æ³•å®šäººæ•°è€Œå¯¼è‡´çš„è¾ƒé•¿æ—¶é—´çš„åœæœºã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>å¿«ç…§å¤„ç†æ—¶é—´</td><td>etcdå®šæœŸåˆ›å»ºå¿«ç…§ä»¥å¤‡ä»½æ•°æ®ã€‚ç›‘æ§å¿«ç…§å¤„ç†æ—¶é—´å¯ä»¥å¸®åŠ©ä½ äº†è§£etcdå¤‡ä»½çš„æ€§èƒ½ï¼Œç¡®ä¿å¤‡ä»½ä»»åŠ¡èƒ½å¤ŸåŠæ—¶å®Œæˆã€‚</td></tr><tr><td>RED æ–¹æ³•</td><td>watcher æ•°é‡</td><td>ç›‘æ§etcdé›†ç¾¤å½“å‰è¿æ¥åˆ°etcdçš„å®¢æˆ·ç«¯æ•°é‡ã€‚å¦‚æœè¿æ¥æ•°è¿‡é«˜ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´etcdçš„é…ç½®æˆ–è€…å¢åŠ é›†ç¾¤çš„å®¹é‡ã€‚</td></tr><tr><td>USE æ–¹æ³•</td><td>CPU ä½¿ç”¨ç‡</td><td></td></tr><tr><td>USE æ–¹æ³•</td><td>å†…å­˜ä½¿ç”¨é‡</td><td></td></tr><tr><td>USE æ–¹æ³•</td><td>æ‰“å¼€æ–‡ä»¶æ•°</td><td></td></tr><tr><td>USE æ–¹æ³•</td><td>å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡</td><td>ç›‘æ§etcdå­˜å‚¨ç©ºé—´çš„ä½¿ç”¨ç‡å¯ä»¥å¸®åŠ©ä½ ç¡®ä¿etcdæœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜å‚¨é…ç½®æ•°æ®ã€‚å¦‚æœä½¿ç”¨ç‡æ¥è¿‘æˆ–è¾¾åˆ°ä¸Šé™ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘æ‰©å±•å­˜å‚¨å®¹é‡æˆ–è€…æ¸…ç†æ— ç”¨çš„æ•°æ®ã€‚</td></tr></tbody></table><h4 id="ä½¿ç”¨-kube-prometheus-æ”¶é›†-etcd-æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-kube-prometheus-æ”¶é›†-etcd-æŒ‡æ ‡" aria-hidden="true">#</a> ä½¿ç”¨ kube-prometheus æ”¶é›† etcd æŒ‡æ ‡</h4><p><strong>http æ¨¡å¼ï¼ˆæ¨èï¼‰</strong></p><p>ä¿®æ”¹<code>--listen-metrics-urls</code></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>    <span class="token comment">#- --listen-metrics-urls=http://127.0.0.1:2381</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>urls=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2381</span><span class="token punctuation">,</span>http<span class="token punctuation">:</span>//ip<span class="token punctuation">:</span><span class="token number">2381</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>éƒ¨ç½²</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>helm <span class="token function">install</span> monitoring <span class="token parameter variable">-n</span> cattle-prometheus <span class="token parameter variable">--set</span> <span class="token assign-left variable">kubeEtcd.service.port</span><span class="token operator">=</span><span class="token number">2381</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">kubeEtcd.service.targetPort</span><span class="token operator">=</span><span class="token number">2381</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">prometheusOperator.admissionWebhooks.patch.image.sha</span><span class="token operator">=</span>null ./
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>https æ¨¡å¼</strong></p><p>æ–°å¢ etcd secret</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl create secret generic etcd-certs <span class="token parameter variable">-n</span> cattle-prometheus --from-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/ca.crt --from-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/healthcheck-client.key
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>éƒ¨ç½²</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>helm <span class="token function">install</span> monitoring <span class="token parameter variable">-n</span> cattle-prometheus  <span class="token parameter variable">--set</span> <span class="token assign-left variable">kubeEtcd.serviceMonitor.scheme</span><span class="token operator">=</span>https <span class="token parameter variable">--set</span> <span class="token assign-left variable">kubeEtcd.serviceMonitor.caFile</span><span class="token operator">=</span>/etc/prometheus/secrets/etcd-certs/ca.crt <span class="token parameter variable">--set</span> <span class="token assign-left variable">kubeEtcd.serviceMonitor.certFile</span><span class="token operator">=</span>/etc/prometheus/secrets/etcd-certs/healthcheck-client.crt <span class="token parameter variable">--set</span> <span class="token assign-left variable">kubeEtcd.serviceMonitor.keyFile</span><span class="token operator">=</span>/etc/prometheus/secrets/etcd-certs/healthcheck-client.key <span class="token parameter variable">--set</span> <span class="token assign-left variable">prometheus.prometheusSpec.secrets</span><span class="token operator">=</span><span class="token punctuation">{</span>etcd-certs<span class="token punctuation">}</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">prometheusOperator.admissionWebhooks.patch.image.sha</span><span class="token operator">=</span>null ./
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="å¤§ç›˜å±•ç¤º" tabindex="-1"><a class="header-anchor" href="#å¤§ç›˜å±•ç¤º" aria-hidden="true">#</a> å¤§ç›˜å±•ç¤º</h4><p>Grafana å¤§ç›˜ï¼š https://github.com/clay-wangzhi/grafana-dashboard/blob/master/etcd/etcd-dash.json</p><p>å¯¼å…¥å³å¯</p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20230616180204033.png" alt="image-20230616180204033" style="zoom:67%;"><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20230616180334752.png" alt="image-20230616180334752"><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20230616180508983.png" alt=""></p><h4 id="ç›‘æ§æŒ‡æ ‡è¡¥å……" tabindex="-1"><a class="header-anchor" href="#ç›‘æ§æŒ‡æ ‡è¡¥å……" aria-hidden="true">#</a> ç›‘æ§æŒ‡æ ‡è¡¥å……</h4><ul><li>æ•°æ®ä¸€è‡´æ€§ã€å†™è¯·æ±‚ã€èµ„æºå¯¹è±¡æ•°ç­‰</li></ul><p><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240410193826786.png" alt=""></p><p>æ”¶é›†è¿‡ç¨‹è¯¦è§ï¼šhttps://github.com/clay-wangzhi/etcd-metrics</p><p>å‚è€ƒ https://github.com/kstone-io/kstone è¿›è¡Œè£å‰ª</p><h3 id="etcd-åŸºå‡†æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#etcd-åŸºå‡†æµ‹è¯•" aria-hidden="true">#</a> Etcd åŸºå‡†æµ‹è¯•</h3><h4 id="sli-slo" tabindex="-1"><a class="header-anchor" href="#sli-slo" aria-hidden="true">#</a> SLI &amp; SLO</h4><p>SLIï¼ˆService Level Indicatorï¼‰ï¼šæœåŠ¡ç­‰çº§æŒ‡æ ‡ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬é€‰æ‹©å“ªäº›æŒ‡æ ‡æ¥è¡¡é‡æˆ‘ä»¬çš„ç¨³å®šæ€§ã€‚</p><p>SLOï¼ˆService Level Objectiveï¼‰ï¼šæœåŠ¡ç­‰çº§ç›®æ ‡ï¼ŒæŒ‡çš„å°±æ˜¯æˆ‘ä»¬è®¾å®šçš„ç¨³å®šæ€§ç›®æ ‡ï¼Œæ¯”å¦‚â€œå‡ ä¸ª 9â€è¿™æ ·çš„ç›®æ ‡ã€‚</p><p><strong>SLO æ˜¯ SLI è¦è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©åˆé€‚çš„ SLIï¼Œè®¾å®šå¯¹åº”çš„ SLOã€‚</strong></p><table><thead><tr><th>SLI</th><th>SLO</th><th>æµ‹è¯•æ–¹å¼</th></tr></thead><tbody><tr><td>ååé‡ï¼šè¡¡é‡etcdæ¯ç§’å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°é‡</td><td>æ¯ç§’å¤„ç†40,000ä¸ªè¯»å–è¯·æ±‚å’Œ20,000ä¸ªå†™å…¥è¯·æ±‚</td><td>å®˜æ–¹ benchmark</td></tr><tr><td>å“åº”æ—¶é—´ï¼šè¡¡é‡etcdå¯¹äºè¯»å–å’Œå†™å…¥è¯·æ±‚çš„å“åº”æ—¶é—´</td><td>99%çš„è¯»å†™è¯·æ±‚åœ¨100æ¯«ç§’ä»¥å†…å®Œæˆ</td><td>å®˜æ–¹ benchmark</td></tr></tbody></table><p>ç›®å‰å·²æœ‰ SLI æŒ‡æ ‡çš„æ”¶é›†ã€ç›‘æ§ã€å±•ç¤ºåŠå‘Šè­¦</p><h4 id="ä½¿ç”¨-benchmark-æµ‹è¯•å»¶è¿Ÿå’Œååé‡" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-benchmark-æµ‹è¯•å»¶è¿Ÿå’Œååé‡" aria-hidden="true">#</a> <strong>ä½¿ç”¨ benchmark æµ‹è¯•å»¶è¿Ÿå’Œååé‡</strong></h4><p><em>ç¯å¢ƒå‡†å¤‡</em></p><p><strong>åœ¨ Linux ä¸»æœºå®‰è£… Go ç¯å¢ƒ</strong></p><p><strong>ä¸‹è½½è§£å‹</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://golang.google.cn/dl/go1.19.10.linux-amd64.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-C</span> /usr/local <span class="token parameter variable">-xzf</span>  go1.19.10.linux-amd64.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é…ç½®åˆ°PATHç¯å¢ƒå˜é‡</strong></p><p>åœ¨ <code>/etc/profile</code> æ–‡ä»¶è¿½åŠ å¦‚ä¸‹å†…å®¹</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>export PATH=$PATH:/usr/local/go/bin
export GOPROXY=https://goproxy.cn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€å source ç”Ÿæ•ˆ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">source</span> /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>å®‰è£… benchmark å·¥å…·</strong></p><p>clone ä»£ç ï¼Œå®‰è£… benchmark</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/etcd-io/etcd.git <span class="token parameter variable">--depth</span> <span class="token number">1</span>
<span class="token builtin class-name">cd</span> etcd/
go <span class="token function">install</span> <span class="token parameter variable">-v</span> ./tools/benchmark
<span class="token comment"># æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä½ç½®</span>
go list <span class="token parameter variable">-f</span> <span class="token string">&quot;{{.Target}}&quot;</span> ./tools/benchmark
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åŸºå‡†æµ‹è¯•</strong></p><p>æŸ¥çœ‹å¸®åŠ©</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/go/bin/
./benchmark <span class="token parameter variable">-h</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½®å˜é‡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">ETCD_CA_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span>
<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.crt&quot;</span>
<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token string">&quot;/etc/kubernetes/pki/etcd/server.key&quot;</span>
<span class="token assign-left variable">HOST_1</span><span class="token operator">=</span>https://xxx.xxx.xxx.xxx:2379
<span class="token assign-left variable">HOST_2</span><span class="token operator">=</span>https://xxx.xxx.xxx.xxx:2379
<span class="token assign-left variable">HOST_3</span><span class="token operator">=</span>https://xxx.xxx.xxx.xxx:2379

<span class="token comment"># æå‰å†™ä¸ªæµ‹è¯• key</span>
<span class="token assign-left variable">YOUR_KEY</span><span class="token operator">=</span>foo
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /usr/local/bin/etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_1}</span>,<span class="token variable">\${HOST_2}</span>,<span class="token variable">\${HOST_3}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> put <span class="token variable">$YOUR_KEY</span> bar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å†™æµ‹è¯•</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># write to leader</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_2}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> --target-leader <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\\</span>
     put --key-size<span class="token operator">=</span><span class="token number">8</span> --sequential-keys <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">10000</span> --val-size<span class="token operator">=</span><span class="token number">256</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_2}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> --target-leader  <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">100</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token punctuation">\\</span>
     put --key-size<span class="token operator">=</span><span class="token number">8</span> --sequential-keys <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">100000</span> --val-size<span class="token operator">=</span><span class="token number">256</span>
     
<span class="token comment"># write to all members</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_1}</span>,<span class="token variable">\${HOST_2}</span>,<span class="token variable">\${HOST_3}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">100</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token punctuation">\\</span>
    put --key-size<span class="token operator">=</span><span class="token number">8</span> --sequential-keys <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">100000</span> --val-size<span class="token operator">=</span><span class="token number">256</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:right;">Number of keys</th><th style="text-align:right;">Key size in bytes</th><th style="text-align:right;">Value size in bytes</th><th style="text-align:right;">Number of connections</th><th style="text-align:right;">Number of clients</th><th>Target etcd server</th><th style="text-align:right;">Average write QPS</th><th style="text-align:right;">99% latency per request</th></tr></thead><tbody><tr><td style="text-align:right;">10,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">1</td><td style="text-align:right;">1</td><td>leader only</td><td style="text-align:right;">154</td><td style="text-align:right;">14.8ms</td></tr><tr><td style="text-align:right;">100,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">100</td><td style="text-align:right;">1000</td><td>leader only</td><td style="text-align:right;">14,567</td><td style="text-align:right;">134.4ms</td></tr><tr><td style="text-align:right;">100,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">100</td><td style="text-align:right;">1000</td><td>all members</td><td style="text-align:right;">17,018</td><td style="text-align:right;">117ms</td></tr></tbody></table><p><strong>è¯»æµ‹è¯•</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Single connection read requests</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_1}</span>,<span class="token variable">\${HOST_2}</span>,<span class="token variable">\${HOST_3}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\\</span>
    range <span class="token variable">$YOUR_KEY</span> <span class="token parameter variable">--consistency</span><span class="token operator">=</span>l <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">10000</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_1}</span>,<span class="token variable">\${HOST_2}</span>,<span class="token variable">\${HOST_3}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\\</span>
    range <span class="token variable">$YOUR_KEY</span> <span class="token parameter variable">--consistency</span><span class="token operator">=</span>s <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">10000</span>

<span class="token comment"># Many concurrent read requests</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_1}</span>,<span class="token variable">\${HOST_2}</span>,<span class="token variable">\${HOST_3}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">100</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token punctuation">\\</span>
    range <span class="token variable">$YOUR_KEY</span> <span class="token parameter variable">--consistency</span><span class="token operator">=</span>l <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">100000</span>
./benchmark <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token variable">\${HOST_1}</span>,<span class="token variable">\${HOST_2}</span>,<span class="token variable">\${HOST_3}</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CA_CERT}</span>&quot;</span> <span class="token parameter variable">--cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_CERT}</span>&quot;</span> <span class="token parameter variable">--key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${ETCD_KEY}</span>&quot;</span> <span class="token parameter variable">--conns</span><span class="token operator">=</span><span class="token number">100</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token punctuation">\\</span>
    range <span class="token variable">$YOUR_KEY</span> <span class="token parameter variable">--consistency</span><span class="token operator">=</span>s <span class="token parameter variable">--total</span><span class="token operator">=</span><span class="token number">100000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:right;">Number of requests</th><th style="text-align:right;">Key size in bytes</th><th style="text-align:right;">Value size in bytes</th><th style="text-align:right;">Number of connections</th><th style="text-align:right;">Number of clients</th><th>Consistency</th><th style="text-align:right;">Average read QPS</th><th style="text-align:right;">99% latency per request</th></tr></thead><tbody><tr><td style="text-align:right;">10,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">1</td><td style="text-align:right;">1</td><td>Linearizable</td><td style="text-align:right;">509</td><td style="text-align:right;">7.3ms</td></tr><tr><td style="text-align:right;">10,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">1</td><td style="text-align:right;">1</td><td>Serializable</td><td style="text-align:right;">1,709</td><td style="text-align:right;">1.7ms</td></tr><tr><td style="text-align:right;">100,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">100</td><td style="text-align:right;">1000</td><td>Linearizable</td><td style="text-align:right;">29,326</td><td style="text-align:right;">104.8ms</td></tr><tr><td style="text-align:right;">100,000</td><td style="text-align:right;">8</td><td style="text-align:right;">256</td><td style="text-align:right;">100</td><td style="text-align:right;">1000</td><td>Serializable</td><td style="text-align:right;">43,469</td><td style="text-align:right;">98.9ms</td></tr></tbody></table><h4 id="ä½¿ç”¨-fio-æµ‹è¯•ç£ç›˜æ€§èƒ½" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-fio-æµ‹è¯•ç£ç›˜æ€§èƒ½" aria-hidden="true">#</a> ä½¿ç”¨ FIO æµ‹è¯•ç£ç›˜æ€§èƒ½</h4><p>Etcd å¯¹å†…å­˜å’Œ CPU æ¶ˆè€—å¹¶ä¸é«˜ï¼Œè¶³å¤Ÿå°±è¡Œã€‚</p><p>ä¸€æ¬¡ Etcd è¯·æ±‚çš„æœ€å°æ—¶é—´ = æˆå‘˜èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œå¾€è¿”æ—¶å»¶ + æ”¶åˆ°æ•°æ®ä¹‹åè¿›è¡ŒæŒä¹…åŒ–çš„æ—¶å»¶ã€‚å› æ­¤ï¼ŒEtcd çš„æ€§èƒ½ä¸»è¦å—ä¸¤æ–¹é¢çš„çº¦æŸï¼š</p><ul><li>ç½‘ç»œ</li><li>ç£ç›˜</li></ul><p>å¤šèŠ‚ç‚¹çš„ Etcd é›†ç¾¤æˆå‘˜èŠ‚ç‚¹åº”è¯¥å°½é‡éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒï¼Œå‡å°‘ç½‘ç»œæ—¶å»¶ã€‚åŒä¸€æ•°æ®ä¸­å¿ƒå†…ï¼Œä¸åŒèŠ‚ç‚¹çš„ç½‘ç»œæƒ…å†µé€šå¸¸æ˜¯éå¸¸å¥½çš„ï¼Œå¦‚æœéœ€è¦æµ‹è¯•å¯ä»¥ä½¿ç”¨ <code>ping</code> æˆ– <code>tcpdump</code> å‘½ä»¤è¿›è¡Œåˆ†æã€‚</p><p>ä¸‹é¢ä¸»è¦è®¨è®ºç¡¬ç›˜ IO æµ‹è¯•æ–¹æ³•ã€‚</p><p>å­˜å‚¨æ€§èƒ½èƒ½å¤Ÿæ»¡è¶³ etcd çš„æ€§èƒ½è¦æ±‚ï¼Œæœ‰ä¸¤ç§æ–¹æ³•æµ‹è¯•ï¼š</p><ol><li><p>å·²è¿è¡Œçš„ etcd é›†ç¾¤ï¼Œé€šè¿‡æŒ‡æ ‡<code>etcd_disk_wal_fysnc_duration_seconds</code>æ¥è¯„ä¼°å­˜å‚¨ I/O æ€§èƒ½ï¼Œ è¯¥æŒ‡æ ‡è®°å½•äº† WAL æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨ fsync çš„å»¶è¿Ÿåˆ†å¸ƒï¼Œå½“ 99% æ ·æœ¬çš„åŒæ­¥æ—¶é—´å°äº 10 æ¯«ç§’å°±å¯ä»¥è®¤ä¸ºå­˜å‚¨æ€§èƒ½èƒ½å¤Ÿæ»¡è¶³ etcd çš„æ€§èƒ½è¦æ±‚ã€‚</p></li><li><p>æ˜¯ç”¨ fio å‘½ä»¤ï¼Œè¿˜åŸ etcd ä½¿ç”¨åœºæ™¯ï¼Œçœ‹99çº¿</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> test-data 
fio <span class="token parameter variable">--rw</span><span class="token operator">=</span>write <span class="token parameter variable">--ioengine</span><span class="token operator">=</span>sync <span class="token parameter variable">--fdatasync</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--directory</span><span class="token operator">=</span>test-data <span class="token parameter variable">--size</span><span class="token operator">=</span>22m <span class="token parameter variable">--bs</span><span class="token operator">=</span><span class="token number">2300</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>mytest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="è°ƒä¼˜" tabindex="-1"><a class="header-anchor" href="#è°ƒä¼˜" aria-hidden="true">#</a> è°ƒä¼˜</h3><p><strong>ç£ç›˜</strong></p><p>æ¢ SSD ç›˜ -------- è¿™ä¸ªæ˜¯å¿…é¡»çš„</p><p>ç»™å®šè¾ƒé«˜çš„ç£ç›˜ä¼˜å…ˆçº§</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># best effort, highest priority</span>
$ <span class="token function">sudo</span> ionice <span class="token parameter variable">-c2</span> <span class="token parameter variable">-n0</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">\`</span>pgrep etcd<span class="token variable">\`</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CPU</strong></p><p>CPU æ€§èƒ½æ¨¡å¼è°ƒæ•´ä¸º performance , å¦‚ä½•è°ƒæ•´ä¸æˆåŠŸå‚è€ƒï¼šhttps://clay-wangzhi.com/cloudnative/troubleshooting/vm-vs-container-performance.html#cpu</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> performance <span class="token operator">|</span> <span class="token function">tee</span> /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>é…ç½®å‚æ•°</strong></p><p>å¼€å¯è‡ªåŠ¨å‹ç¼©ã€ä¿®æ”¹etcd raftæ¶ˆæ¯æœ€å¤§å­—èŠ‚æ•°ã€ä¿®æ”¹ etcdæœ€å¤§å®¹é‡ç­‰ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p>etcd å®æˆ˜è¯¾ | æå®¢æ—¶é—´ å”èªï¼šhttps://time.geekbang.org/column/intro/100069901</p><p>github etcdctl docï¼šhttps://github.com/etcd-io/etcd/blob/main/etcdctl/README.md</p><p>datadog etcd æŒ‡æ ‡ï¼šhttps://docs.datadoghq.com/integrations/etcd/?tab=host</p><p>etcd å®˜æ–¹æ–‡æ¡£-tunningï¼šhttps://etcd.io/docs/v3.5/tuning/</p><p>etcd å®˜æ–¹æ–‡æ¡£-ç¡¬ä»¶è¦æ±‚ï¼šhttps://etcd.io/docs/v3.5/op-guide/hardware/</p><p>etcd å®˜æ–¹æ–‡æ¡£-benchmarkï¼šhttps://etcd.io/docs/v3.5/benchmarks/etcd-3-demo-benchmarks/</p><p>ä½¿ç”¨fioæµ‹è¯•etcdæ˜¯å¦æ»¡è¶³è¦æ±‚ï¼šhttps://www.ibm.com/cloud/blog/using-fio-to-tell-whether-your-storage-is-fast-enough-for-etcd</p><p>æˆ‘æ˜¯ Clayï¼Œä¸‹æœŸè§ ğŸ‘‹</p><hr><blockquote><ul><li><p>æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·ã€ŒSREè¿ç»´è¿›é˜¶ä¹‹è·¯ã€æˆ–å…³æ³¨æˆ‘çš„ Github https://github.com/clay-wangzhi/wiki æŸ¥çœ‹æœ€æ–°æ–‡ç« </p></li><li><p>æ¬¢è¿åŠ æˆ‘å¾®ä¿¡<code>sre-k8s-ai</code>ï¼Œä¸æˆ‘è®¨è®ºäº‘åŸç”Ÿã€ç¨³å®šæ€§ç›¸å…³å†…å®¹</p></li></ul></blockquote><img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin-20240220180036567.png" alt="weixin" style="zoom:50%;">`,126),l=[r];function p(i,o){return s(),e("div",null,l)}const b=a(t,[["render",p],["__file","etcd.html.vue"]]);export{b as default};
